<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pistachio ‚Äì Al Jameel MES</title>
 <link rel="icon" href="src/assets/icon/pistachio.png">
<link rel="shortcut icon" href="src/assets/icon/pistachio.png">

<link rel="icon" href="src/assests/icons/pistachio.png">
<link rel="shortcut icon" href="src/assests/icons/pistachio.png">

  <style>
    /* --- small layout helpers --- */
    .size-qty-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(220px, 1fr));
      gap:15px;
    }
    @media (max-width:768px){
      .size-qty-grid{ grid-template-columns:1fr; }
    }
    .action-buttons{ display:flex; gap:10px; align-items:center; }
    .action-buttons .edit-btn{ height:44px; }

    /* ============ Brand Tokens (Al Jameel) ============ */
    :root{
      --brand-primary:#a32034;
      --brand-primary-600:#8b1a2a;
      --brand-primary-700:#781624;
      --brand-accent:#d5a333;
      --text:#2f2a28;
      --bg:#f3f4f6;
      --surface:#ffffff;
      --muted:#6b7280;
      --border:#e5e7eb;

      --success:#16a34a;
      --danger:#dc3545;
      --warn:#fff3cd;
      --info:#eef2ff;
    }

    *{margin:0; padding:0; box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ======= Header / Nav ======= */
    .header{
      background:var(--brand-primary);
      color:#fff;
      padding:20px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .header h1{ font-size:20px; letter-spacing:.2px }
    .header a.back{
      color:#fff; text-decoration:none; background:rgba(255,255,255,.12);
      padding:8px 12px; border-radius:10px; margin-right:10px;
    }
    .container{ max-width:1200px; margin:0 auto; padding:20px }

    .nav-buttons{ display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap }
    .nav-btn{
      padding:10px 20px; background:var(--brand-primary); color:#fff;
      border:none; border-radius:8px; cursor:pointer; font-size:16px; min-height:44px;
    }
    .nav-btn:hover{ background:var(--brand-primary-600) }
    .nav-btn.active{ background:var(--brand-primary-700) }
    .nav-btn.print-btn{
      background:linear-gradient(135deg, var(--brand-accent), #e0b760);
      color:#2f2a28; border:2px solid var(--brand-accent); font-weight:700;
      box-shadow:0 2px 4px rgba(213,163,51,.25);
    }
    .nav-btn.print-btn:hover{
      filter:brightness(.95);
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(213,163,51,.35);
    }
/* header icon */
.brandwrap{ display:flex; align-items:center; gap:10px; }
.brandmark{
  width:32px; height:32px; object-fit:contain;
  display:inline-block; vertical-align:middle;
}

    /* ======= Sections / Cards ======= */
    .section{ display:none; background:var(--surface); padding:20px; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,.06) }
    .section.active{ display:block }

    .form-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:15px; margin-bottom:20px }
    .form-grid.materials-grid{ grid-template-columns:repeat(auto-fit,minmax(180px,1fr)) }

    .form-group{ display:flex; flex-direction:column }
    label{ margin-bottom:6px; font-weight:700; color:#444 }

    input, select{
      padding:10px; border:1px solid var(--border); border-radius:10px;
      font-size:16px; background:#fff;
    }
    select:focus, input:focus{
      outline:none; border-color:var(--brand-accent);
      box-shadow:0 0 0 2px rgba(213,163,51,.25);
    }

    /* Prominent selects (box types) */
    select#boxTypeUsed, select#boxTypeWasted{
      background:#fff7e6; border:2px solid #f5e1a8; font-weight:600;
    }
    select#boxTypeUsed:focus, select#boxTypeWasted:focus{
      background:#fff2cc; border-color:var(--brand-accent);
    }

    button{
      padding:12px 24px; background:var(--brand-primary); color:#fff;
      border:none; border-radius:10px; cursor:pointer; font-size:16px; min-height:44px;
    }
    button:hover{ background:var(--brand-primary-600) }

    .output-section{ background:#fafafa; padding:15px; border-radius:10px; margin:20px 0; border:1px solid var(--border) }
    .reject-section{ background:var(--warn); padding:15px; border-radius:10px; margin:20px 0; border:1px solid #ffe8a6 }
    .materials-section{ background:#fff7e6; padding:15px; border-radius:10px; margin:20px 0; border:1px solid #f5e1a8 }

    .table-container{ overflow-x:auto; margin-top:20px; padding-bottom:10px; -webkit-overflow-scrolling:touch }
    table{ width:100%; border-collapse:collapse; min-width:700px }
    th, td{ padding:12px; text-align:left; border-bottom:1px solid var(--border) }
    th{ background:var(--brand-primary); color:#fff }

    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:30px }
    .stat-card{
      background:linear-gradient(0deg,#fff,#fff);
      padding:20px; border-radius:12px; text-align:center;
      border:2px solid var(--brand-accent);
    }
    .stat-value{ font-size:2em; font-weight:800; color:var(--brand-primary) }

    .total-box{ background:#fff7e6; padding:10px; margin-top:10px; border-radius:8px; font-weight:700; border:1px solid #f5e1a8 }

    .warning-box{ background:#fff3cd; border:1px solid #ffeeba; color:#7a5d00; padding:15px; border-radius:10px; margin-bottom:20px }
  </style>
</head>
<body>

<!-- Login -->
<div id="loginScreen" style="min-height:100vh; background:var(--bg); display:flex; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:40px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); width:100%; max-width:400px;">
    <h2 style="text-align:center; color:var(--brand-primary); margin-bottom:20px;">Pistachio Production Login</h2>
    <form onsubmit="handleLogin(event)">
      <div class="form-group"><label>Username</label><input id="loginUsername" type="text" required autocomplete="username"></div>
      <div class="form-group"><label>Password</label><input id="loginPassword" type="password" required autocomplete="current-password"></div>
      <button type="submit" style="width:100%; margin-top:10px;">Login</button>
    </form>
    <div style="margin-top:20px; padding:12px; background:#fafafa; border-radius:10px; border:1px solid var(--border);">
      <p style="margin:0; font-weight:700">Demo Users:</p>
      <p style="margin:6px 0">Admin: admin / admin123</p>
      <p style="margin:6px 0">Operator: operator / op123</p>
    </div>
  </div>
</div>

<!-- App -->
<div id="mainApp" style="display:none;">
  <div class="header">
    <div>
      <a class="back" href="./#/">‚Üê Back to MES</a>
<img src="src/assets/icons/pistachio.png" alt="Pistachio" class="brandmark">
      <h1>Pistachio Production Management</h1>
    </div>
    <div>
      <span id="userDisplay">User</span>
      <button onclick="logout()" style="margin-left:10px; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.25)">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showSection('dashboard', this)">Dashboard</button>
      <button class="nav-btn" onclick="showSection('production', this)">New Production</button>
      <button class="nav-btn" onclick="showSection('records', this)">View Records</button>
      <button class="nav-btn" onclick="showSection('inventory', this)">Inventory</button>
      <button class="nav-btn" onclick="showSection('materials', this)">Materials</button>
      <button class="nav-btn print-btn" onclick="showProductionSelection()">üìä Print Report</button>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div>Total Finished (kg)</div>
          <div class="stat-value" id="kpiFinished">0</div>
        </div>
        <div class="stat-card">
          <div>Efficiency (%)</div>
          <div class="stat-value" id="kpiEff">0</div>
        </div>
        <div class="stat-card">
          <div>Reject Rate (%)</div>
          <div class="stat-value" id="kpiReject">0</div>
        </div>
      </div>
      <div class="output-section">
        <p>This is your Pistachio dashboard. KPIs update when you add records in <strong>New Production</strong>.</p>
      </div>
    </section>

    <!-- NEW PRODUCTION -->
    <section id="production" class="section">
      <img src="src/assests/icons/pistachio.png" alt="Pistachio" style="width:48px;height:48px;display:block;margin-bottom:10px;">

      <div class="warning-box">
        Huller Run hides Size and shows Rejects. Repacking keeps Size and hides Rejects.
      </div>

      <!-- run + brand + size (size hidden for huller) + lot + input -->
      <div class="form-grid">
        <div class="form-group">
          <label>Run Type</label>
          <select id="runType">
            <option value="huller">Huller Run</option>
            <option value="repack">Repacking Only</option>
          </select>
        </div>

        <div class="form-group">
          <label>Brand</label>
          <select id="brand">
            <option>Golden Hill</option>
            <option>Extra</option>
          </select>
        </div>

        <div class="form-group">
          <label>Size</label>
          <select id="size">
            <option>18-21</option>
            <option>21-25</option>
          </select>
        </div>

        <div class="form-group">
          <label>Lot #</label>
          <input id="lot_no" type="text" placeholder="e.g., GH-240315-01">
        </div>

        <div class="form-group">
          <label>Raw material input (kg)</label>
          <input id="raw_input_kg" type="number" min="0" step="1" value="0">
        </div>
      </div>

      <!-- FINAL GOODS ‚Äî two sizes; labels change with brand + run type -->
      <div class="size-qty-grid">
        <div class="form-group">
          <label><span id="label_1821">18‚Äì21</span> ‚Äî Qty (10 kg bags)</label>
          <input id="fg_1821_bags" type="number" min="0" step="1" value="0" />
        </div>

        <div class="form-group">
          <label><span id="label_2125">21‚Äì25</span> ‚Äî Qty (10 kg bags)</label>
          <input id="fg_2125_bags" type="number" min="0" step="1" value="0" />
        </div>
      </div>

      <!-- MATERIALS -->
      <div class="materials-section">
        <div class="form-grid materials-grid">
          <div class="form-group">
            <label>Box type (used)</label>
            <select id="boxTypeUsed">
              <option value="">‚Äî</option>
              <option value="Golden Hill">Golden Hill</option>
              <option value="Extra">Extra</option>
            </select>
          </div>
          <div class="form-group">
            <label>Packing boxes used</label>
            <input id="mat_boxes_used" type="number" min="0" step="1" value="0" />
          </div>
          <div class="form-group">
            <label>Plastic bags used (10 kg)</label>
            <input id="mat_bags_used" type="number" min="0" step="1" value="0" />
          </div>

          <div class="form-group">
            <label>Box type (wasted)</label>
            <select id="boxTypeWasted">
              <option value="">‚Äî</option>
              <option value="Golden Hill">Golden Hill</option>
              <option value="Extra">Extra</option>
            </select>
          </div>
          <div class="form-group">
            <label>Boxes wasted</label>
            <input id="mat_boxes_waste" type="number" min="0" step="1" value="0" />
          </div>
          <div class="form-group">
            <label>Plastic bags wasted (10 kg)</label>
            <input id="mat_bags_waste" type="number" min="0" step="1" value="0" />
          </div>
        </div>
      </div>

      <!-- REJECTS -->
      <div id="rejectBlock" class="reject-section">
        <p><strong>Rejects (kg)</strong> ‚Äî only for Huller Run</p>
        <div class="form-grid materials-grid">
          <div class="form-group"><label>Non-Split (Closed)</label><input id="rej_non_split" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Light Stain</label><input id="rej_light_stain" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Adhering Hull</label><input id="rej_adhering_hull" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Dark Stain</label><input id="rej_dark_stain" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Shell & Split (Pre-clean 1)</label><input id="rej_shell_split_pre1" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Undersize 30/64 & Kernel (Pre-clean 2)</label><input id="rej_undersize_kernel_pre2" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Loose Shell</label><input id="rej_loose_shell" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Loose Kernel</label><input id="rej_loose_kernel" type="number" min="0" step="5" value="0"></div>
          <div class="form-group"><label>Dust</label><input id="rej_dust" type="number" min="0" step="5" value="0"></div>
        </div>
      </div>

      <div class="action-buttons">
        <button type="button" class="edit-btn" onclick="submitProduction()">Submit</button>
      </div>

      <div class="output-section">
        <div class="total-box" id="calcSummary">
          Finished: 0 kg ¬∑ Total Rejects: 0 kg ¬∑ Efficiency: 0% ¬∑ Reject Rate: 0%
        </div>
      </div>
    </section>

    <!-- RECORDS -->
    <section id="records" class="section">
      <div class="table-container">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Time</th><th>Run</th><th>Brand</th><th>Size/Sizes</th>
              <th>Lot</th><th>Raw Input (kg)</th>
              <th>Final Bags</th><th>Bags Used</th><th>Boxes Used</th>
              <th>Total Rejects (kg)</th><th>Status</th>
            </tr>
          </thead>
          <tbody><!-- rows injected --></tbody>
        </table>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="section">
      <!-- Top counters -->
      <div class="stats-grid" style="margin-bottom:16px">
        <div class="stat-card"><div>Vacuum bags (10 kg)</div><div class="stat-value" id="inv_bags">0</div></div>
        <div class="stat-card"><div>Packing boxes</div><div class="stat-value" id="inv_boxes">0</div></div>
        <div class="stat-card"><div>Big Bags (~998.7 kg)</div><div class="stat-value" id="inv_bigbags">0</div></div>
        <div class="stat-card"><div>Cartons (11.34 kg)</div><div class="stat-value" id="inv_cartons">0</div></div>
        <div class="stat-card"><div>Bags (25 kg)</div><div class="stat-value" id="inv_bag25">0</div></div>
      </div>

      <!-- Manual stock movements -->
      <div class="materials-section">
        <div class="form-grid materials-grid">
          <div class="form-group">
            <label>Item</label>
            <select id="inv_item">
              <option value="vacuum_bags_10kg">Vacuum bags (10 kg)</option>
              <option value="packing_boxes">Packing boxes</option>
              <option value="big_bag_998">Big Bag (~998.7 kg)</option>
              <option value="carton_11_34">Carton (11.34 kg)</option>
              <option value="bag_25">Bag (25 kg)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Action</label>
            <select id="inv_action">
              <option value="add">Add to stock</option>
              <option value="remove">Remove from stock</option>
              <option value="adjust">Set exact quantity</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input id="inv_qty" type="number" min="0" step="1" value="0" />
          </div>
          <div class="form-group">
            <label>Notes (optional)</label>
            <input id="inv_note" type="text" placeholder="PO#, reason‚Ä¶" />
          </div>
        </div>
        <div class="row" style="gap:10px;margin-top:8px;flex-wrap:wrap">
          <button type="button" onclick="invAddEntry()">Add Entry</button>
          <button type="button" class="ghost" onclick="invExport()">Export CSV</button>
          <button type="button" class="delete-btn" onclick="invClearAll()" style="margin-inline-start:auto">Clear All (danger)</button>
        </div>
      </div>

      <!-- Log of manual stock movements -->
      <div class="table-container">
        <table id="invTable">
          <thead>
            <tr>
              <th>Time</th><th>Item</th><th>Action</th><th>Qty</th><th>Resulting Stock</th><th>Notes</th>
            </tr>
          </thead>
          <tbody><!-- rows injected --></tbody>
        </table>
      </div>

      <!-- Summary tables from Submitted Production + Adjustments -->
      <div class="output-section" style="margin-top:24px">
        <h3 style="margin:0 0 10px">Finished Goods (from submitted production)</h3>
        <div class="table-container">
          <table id="invFinished">
            <thead>
              <tr><th>Brand</th><th>Size</th><th>Bags (10kg)</th><th>Kg</th></tr>
            </thead>
            <tbody><!-- rows injected --></tbody>
          </table>
        </div>

        <h3 style="margin:18px 0 10px">Materials Usage Totals</h3>
        <div class="table-container">
          <table id="invMaterials">
            <thead>
              <tr><th>Vacuum bags used</th><th>Boxes used</th><th>Vacuum bags wasted</th><th>Boxes wasted</th></tr>
            </thead>
            <tbody><!-- rows injected --></tbody>
          </table>
        </div>

        <h3 style="margin:18px 0 10px">Rejects Total</h3>
        <div class="table-container">
          <table id="invRejects">
            <thead>
              <tr><th>Total Rejects (kg)</th></tr>
            </thead>
            <tbody><!-- rows injected --></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MATERIALS -->
    <section id="materials" class="section">
      <div class="output-section">
        <p>Materials usage summary coming soon‚Ä¶</p>
      </div>
    </section>
  </div>
</div>

<!-- Print Container -->
<div class="print-container" id="printReport"></div>

<!-- ===== CORE CONSTANTS ===== -->
<script>
  const LS_REC_KEY   = 'pistachio_records';          // production records
</script>

<!-- ===== SECTION A: Login ===== -->
<script>
  const USERS = { admin:'admin123', operator:'op123' };

  window.addEventListener('load', function () {
    const savedUser = localStorage.getItem('mes_user');
    if (savedUser && USERS[savedUser]) { showApp(savedUser); } else { showLogin(); }
  });

  function showLogin(){
    const log = document.getElementById('loginScreen');
    const app = document.getElementById('mainApp');
    if (log) log.style.display = 'flex';
    if (app) app.style.display = 'none';
  }
  function showApp(username){
    const log = document.getElementById('loginScreen');
    const app = document.getElementById('mainApp');
    if (log) log.style.display = 'none';
    if (app) app.style.display = 'block';
    const userDisplay = document.getElementById('userDisplay');
    if (userDisplay) userDisplay.textContent = username;
  }
  function handleLogin(e){
    e.preventDefault();
    const u = document.getElementById('loginUsername')?.value?.trim() || '';
    const p = document.getElementById('loginPassword')?.value || '';
    if (!u || !p) { alert('Enter username and password.'); return; }
    const ok = USERS[u] && USERS[u] === p;
    if (!ok) { alert('Invalid username or password.'); return; }
    localStorage.setItem('mes_user', u);
    showApp(u);
  }
  function logout(){ localStorage.removeItem('mes_user'); showLogin(); }
</script>

<!-- ===== SECTION B: Navigation ===== -->
<script>
  window.showSection = function (id, btn) {
    document.querySelectorAll('.section').forEach(sec => {
      sec.classList.toggle('active', sec.id === id);
    });
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    if (id === 'inventory') { renderStockUI(); renderInventory(); }
    window.scrollTo({ top: 0 });
  };
  window.showProductionSelection = function(){ window.print(); };

  function bootDefaultSection(){
    const already = document.querySelector('.section.active');
    if (already) return;
    const first = document.getElementById('dashboard') || document.querySelector('.section');
    if (first) {
      first.classList.add('active');
      const firstBtn = document.querySelector('.nav-buttons .nav-btn');
      if (firstBtn) firstBtn.classList.add('active');
    }
  }
  window.addEventListener('load', bootDefaultSection);
</script>

<!-- ===== SECTION C: Summary math + payload + inventory subtraction ===== -->
<script>
  /* Helpers */
  function readNum(id){ const el = document.getElementById(id); return Number(el?.value||0); }
  function sumRejects(){
    const keys = ['non_split','light_stain','adhering_hull','dark_stain','shell_split_pre1','undersize_kernel_pre2','loose_shell','loose_kernel','dust'];
    return keys.reduce((s,k)=> s + readNum('rej_'+k), 0);
  }

  /* Dynamic labels + visibility */
  function updateOutputLabels(){
    const runType = document.getElementById('runType')?.value || 'huller';
    const brand   = document.getElementById('brand')?.value || 'Golden Hill';

    // Hide Size for Huller; show for Repack
    const sizeGroup = document.getElementById('size')?.closest('.form-group');
    if (sizeGroup) sizeGroup.style.display = (runType === 'huller') ? 'none' : '';

    // Rejects only for Huller
    const rej = document.getElementById('rejectBlock');
    if (rej) rej.style.display = (runType === 'huller') ? 'block' : 'none';

    // Output field labels based on brand
    const l1821 = document.getElementById('label_1821');
    const l2125 = document.getElementById('label_2125');
    if (l1821) l1821.textContent = `18‚Äì21 ${brand}`;
    if (l2125) l2125.textContent = `21‚Äì25 ${brand}`;

    updateSummary();
  }

  /* Summary calc: uses raw input if provided, otherwise finished + rejects */
  function updateSummary(){
    const bags2125 = readNum('fg_2125_bags');
    const bags1821 = readNum('fg_1821_bags');
    const totalBags = bags2125 + bags1821;
    const finishedKg = totalBags * 10;

    const isHuller = (document.getElementById('runType')?.value === 'huller');
    const rejectsKg = isHuller ? sumRejects() : 0;

    const providedRaw = readNum('raw_input_kg');
    const inputKg = providedRaw > 0 ? providedRaw : (finishedKg + rejectsKg);

    const eff = inputKg ? Math.round((finishedKg / inputKg) * 100) : 0;
    const rejRate = inputKg ? Math.round((rejectsKg / inputKg) * 1000)/10 : 0;

    const el = document.getElementById('calcSummary');
    if (el) el.textContent =
      `Finished: ${finishedKg} kg ¬∑ Total Rejects: ${rejectsKg} kg ¬∑ Efficiency: ${eff}% ¬∑ Reject Rate: ${rejRate}%`;
  }

  /* Recompute on input/change */
  ['raw_input_kg','fg_2125_bags','fg_1821_bags',
   'rej_non_split','rej_light_stain','rej_adhering_hull','rej_dark_stain',
   'rej_shell_split_pre1','rej_undersize_kernel_pre2','rej_loose_shell','rej_loose_kernel','rej_dust'
  ].forEach(id => document.addEventListener('input', e => { if(e.target.id===id) updateSummary(); }));
  document.addEventListener('change', (e)=>{
    if (e.target && (e.target.id === 'runType' || e.target.id === 'brand')) { updateOutputLabels(); }
  });

  /* Build record payload */
  function buildPayload(status){
    const brand = document.getElementById('brand').value;
    const size  = document.getElementById('size')?.value || ''; // kept for compatibility (hidden for huller)
    const run   = document.getElementById('runType').value;

    const bags2125 = readNum('fg_2125_bags');
    const bags1821 = readNum('fg_1821_bags');
    const totalBags = bags2125 + bags1821;
    const finishedKg = totalBags * 10;
    const rejectsKg = (run === 'huller') ? sumRejects() : 0;

    return {
      ts: new Date().toISOString(),
      run, brand, size,
      lot: (document.getElementById('lot_no')?.value || '').trim(),
      rawInputKg: readNum('raw_input_kg'),
      sizes: { '21-25': bags2125, '18-21': bags1821 },
      bags10: totalBags,
      finishedKg,
      materials: {
        bags_used:  readNum('mat_bags_used'),
        boxes_used: readNum('mat_boxes_used'),
        bags_waste: readNum('mat_bags_waste'),
        boxes_waste: readNum('mat_boxes_waste'),
        box_type:   document.getElementById('boxTypeUsed')?.value || '',
        box_type_waste: document.getElementById('boxTypeWasted')?.value || ''
      },
      rejectsKg,
      status
    };
  }

  /* Records table */
  function renderRecords(){
    const tbody = document.querySelector('#recordsTable tbody');
    const recs = JSON.parse(localStorage.getItem(LS_REC_KEY) || '[]').slice(-100).reverse();
    tbody.innerHTML = recs.map(r=>{
      const sizeCell = r.sizes
        ? `18‚Äì21:${Number(r.sizes['18-21']||0)} | 21‚Äì25:${Number(r.sizes['21-25']||0)}`
        : (r.size || '-');
      return `
      <tr>
        <td>${new Date(r.ts).toLocaleString()}</td>
        <td>${r.run}</td>
        <td>${r.brand}</td>
        <td>${sizeCell}</td>
        <td>${r.lot || ''}</td>
        <td>${Number(r.rawInputKg||0)}</td>
        <td>${r.bags10}</td>
        <td>${r.materials.bags_used}</td>
        <td>${r.materials.boxes_used}</td>
        <td>${r.rejectsKg}</td>
        <td>${r.status}</td>
      </tr>`;
    }).join('');
  }

  /* Inventory subtraction on submit (consumables) */
  function updateStockFromSubmission(rec){
    const stock = loadStock(); // from Inventory script
    const bagsToSub  = Number(rec.materials?.bags_used  || 0) + Number(rec.materials?.bags_waste || 0);
    const boxesToSub = Number(rec.materials?.boxes_used || 0) + Number(rec.materials?.boxes_waste|| 0);

    stock.vacuum_bags_10kg = Math.max(0, Number(stock.vacuum_bags_10kg || 0) - bagsToSub);
    stock.packing_boxes    = Math.max(0, Number(stock.packing_boxes    || 0) - boxesToSub);

    saveStock(stock);

    if (bagsToSub){ pushInvLog({ ts:new Date().toISOString(), item:'vacuum_bags_10kg', action:'remove', qty:bagsToSub, result:stock.vacuum_bags_10kg, note:'Auto: Production submit' }); }
    if (boxesToSub){ pushInvLog({ ts:new Date().toISOString(), item:'packing_boxes', action:'remove', qty:boxesToSub, result:stock.packing_boxes, note:'Auto: Production submit' }); }

    if (typeof renderStockUI === 'function') renderStockUI();
  }

  /* Submit */
  function submitProduction(){
    const recs = JSON.parse(localStorage.getItem(LS_REC_KEY) || '[]');
    const payload = buildPayload('submitted');
    recs.push(payload);
    localStorage.setItem(LS_REC_KEY, JSON.stringify(recs));

    updateStockFromSubmission(payload);
    alert('Submitted.');
    renderRecords();
    updateSummary();
  }

  /* Boot */
  window.addEventListener('load', function(){
    renderRecords();
    updateOutputLabels();
    updateSummary();
  });
</script>

<!-- ===== SECTION D: Inventory (counters + log + summary tables) ===== -->
<script>
  const LS_INV_ADJ   = 'pistachio_inv_adjustments';
  const LS_INV_STOCK = 'pistachio_inv_stock';
  const LS_INV_LOG   = 'pistachio_inv_log';

  const ITEM_LABELS = {
    vacuum_bags_10kg:'Vacuum bags (10 kg)',
    packing_boxes:'Packing boxes',
    big_bag_998:'Big Bag (~998.7 kg)',
    carton_11_34:'Carton (11.34 kg)',
    bag_25:'Bag (25 kg)'
  };
  const COUNTER_ID = {
    vacuum_bags_10kg:'inv_bags',
    packing_boxes:'inv_boxes',
    big_bag_998:'inv_bigbags',
    carton_11_34:'inv_cartons',
    bag_25:'inv_bag25'
  };

  /* Production records for summaries (submitted only) */
  function getRecords() {
    const all = JSON.parse(localStorage.getItem(LS_REC_KEY) || '[]');
    return all.filter(r => r && r.status === 'submitted');
  }

  /* Manual adjustments (kept for parity) */
  function getAdjustments(){ return JSON.parse(localStorage.getItem(LS_INV_ADJ) || '[]'); }
  function addAdjustment(adj){
    const arr = getAdjustments();
    arr.push({ ...adj, ts:new Date().toISOString() });
    localStorage.setItem(LS_INV_ADJ, JSON.stringify(arr));
  }

  /* Stock engine */
  function loadStock(){
    return Object.assign({
      vacuum_bags_10kg:0, packing_boxes:0, big_bag_998:0, carton_11_34:0, bag_25:0
    }, JSON.parse(localStorage.getItem(LS_INV_STOCK) || '{}'));
  }
  function saveStock(s){ localStorage.setItem(LS_INV_STOCK, JSON.stringify(s)); }

  function loadLog(){ return JSON.parse(localStorage.getItem(LS_INV_LOG) || '[]'); }
  function saveLog(l){ localStorage.setItem(LS_INV_LOG, JSON.stringify(l)); }
  function pushInvLog(entry){ const log = loadLog(); log.push(entry); saveLog(log); }

  function renderCounters(stock){
    Object.keys(stock).forEach(k=>{
      const el = document.getElementById(COUNTER_ID[k]);
      if (el) el.textContent = stock[k];
    });
  }
  function renderLog(log){
    const tbody = document.querySelector('#invTable tbody');
    if (!tbody) return;
    if (!log.length){
      tbody.innerHTML = '<tr><td colspan="6">No inventory entries yet.</td></tr>';
      return;
    }
    const rows = [...log].reverse().map(e=>`
      <tr>
        <td>${new Date(e.ts).toLocaleString()}</td>
        <td>${ITEM_LABELS[e.item] || e.item}</td>
        <td>${e.action}</td>
        <td>${e.qty}</td>
        <td>${e.result}</td>
        <td>${e.note || ''}</td>
      </tr>`).join('');
    tbody.innerHTML = rows;
  }
  function renderStockUI(){ renderCounters(loadStock()); renderLog(loadLog()); }

  function applyAction(stock, item, action, qty){
    const cur = Number(stock[item] || 0);
    if (action === 'add') stock[item] = cur + qty;
    else if (action === 'remove') stock[item] = Math.max(0, cur - qty);
    else if (action === 'adjust') stock[item] = Math.max(0, qty);
    return stock[item];
  }

  /* Buttons */
  window.invAddEntry = function (){
    const item = document.getElementById('inv_item')?.value;
    const action = document.getElementById('inv_action')?.value;
    const qty = Number(document.getElementById('inv_qty')?.value || 0);
    const note = (document.getElementById('inv_note')?.value || '').trim();

    if (!item || !action || !(qty >= 0)) { alert('Fill item, action, and a valid quantity.'); return; }
    if ((action === 'add' || action === 'remove') && qty <= 0) { alert('Quantity must be > 0.'); return; }

    const stock = loadStock();
    const result = applyAction(stock, item, action, qty);
    saveStock(stock);

    const log = loadLog();
    log.push({ ts:new Date().toISOString(), item, action, qty, result, note });
    saveLog(log);

    document.getElementById('inv_qty').value = 0;
    renderStockUI();
  };
  window.invExport = function (){
    const log = loadLog();
    const lines = ['Time,Item,Action,Qty,Resulting Stock,Notes'];
    log.forEach(e=>{
      const t = new Date(e.ts).toISOString();
      lines.push(`${t},"${ITEM_LABELS[e.item] || e.item}",${e.action},${e.qty},${e.result},"${(e.note||'').replace(/"/g,'""')}"`);
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory_log_${Date.now()}.csv`; a.click();
    URL.revokeObjectURL(url);
  };
  window.invClearAll = function (){
    if (!confirm('This will clear ALL inventory stock and log. Continue?')) return;
    localStorage.removeItem(LS_INV_STOCK);
    localStorage.removeItem(LS_INV_LOG);
    renderStockUI();
  };

  /* Summary tables from Production + Adjustments
     NOTE: this respects the new r.sizes map, so huller records
     correctly produce rows for both 18‚Äì21 and 21‚Äì25. */
  function computeInventory() {
    const recs = getRecords();
    const mapFG = {};
    let matUsed = 0, boxUsed = 0, matWaste = 0, boxWaste = 0, rejectsKg = 0;

    recs.forEach(r=>{
      // Finished goods by size
      if (r.sizes && typeof r.sizes === 'object'){
        Object.entries(r.sizes).forEach(([sz, bags])=>{
          const key = `${r.brand}|${sz}`;
          if (!mapFG[key]) mapFG[key] = { brand:r.brand, size:sz, bags:0, kg:0 };
          const b = Number(bags||0);
          mapFG[key].bags += b;
          mapFG[key].kg   += b * 10;
        });
      } else {
        const sz = r.size || '';
        const key = `${r.brand}|${sz}`;
        if (!mapFG[key]) mapFG[key] = { brand:r.brand, size:sz, bags:0, kg:0 };
        mapFG[key].bags += Number(r.bags10 || 0);
        mapFG[key].kg   += Number(r.finishedKg || 0);
      }

      // Materials + rejects totals
      matUsed  += Number(r.materials?.bags_used  || 0);
      boxUsed  += Number(r.materials?.boxes_used || 0);
      matWaste += Number(r.materials?.bags_waste || 0);
      boxWaste += Number(r.materials?.boxes_waste|| 0);
      rejectsKg += Number(r.rejectsKg || 0);
    });

    // Manual adjustments (optional)
    getAdjustments().forEach(a=>{
      const key = `${a.brand}|${a.size}`;
      if (!mapFG[key]) mapFG[key] = { brand:a.brand, size:a.size, bags:0, kg:0 };
      mapFG[key].bags += Number(a.bags || 0);
      mapFG[key].kg   += Number(a.kg   || 0);

      matUsed  += Number(a.mat_bags_used  || 0);
      boxUsed  += Number(a.mat_boxes_used || 0);
      matWaste += Number(a.mat_bags_waste || 0);
      boxWaste += Number(a.mat_boxes_waste|| 0);
      rejectsKg += Number(a.rejectsKg || 0);
    });

    return {
      finished: Object.values(mapFG).sort((a,b)=> (a.brand+a.size).localeCompare(b.brand+b.size)),
      materials: { matUsed, boxUsed, matWaste, boxWaste },
      rejectsKg
    };
  }
  function renderInventory() {
    const snap = computeInventory();

    const tb1 = document.querySelector('#invFinished tbody');
    tb1.innerHTML = snap.finished.length
      ? snap.finished.map(r=>`<tr><td>${r.brand}</td><td>${r.size}</td><td>${r.bags}</td><td>${r.kg}</td></tr>`).join('')
      : `<tr><td colspan="4">No submitted records yet.</td></tr>`;

    document.querySelector('#invMaterials tbody').innerHTML = `
      <tr>
        <td>${snap.materials.matUsed}</td>
        <td>${snap.materials.boxUsed}</td>
        <td>${snap.materials.matWaste}</td>
        <td>${snap.materials.boxWaste}</td>
      </tr>`;

    document.querySelector('#invRejects tbody').innerHTML = `<tr><td>${snap.rejectsKg}</td></tr>`;
  }

  // Initial counters/log only (summary tables render when inventory tab opens)
  window.addEventListener('load', function(){ renderStockUI(); });
</script>

</body>
</html>
