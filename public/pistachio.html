<!DOCTYPE html>
<html lang="en">
<head>
  <head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pistachio Production ‚Äì Al Jameel MES</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #a32034;
      --accent: #d5a333;
      --text: #2f2a28;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 1.5rem; }
    .back-link { 
      color: white; 
      text-decoration: none; 
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-right: 1rem;
    }

    .pistachio-brand-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 0.75rem;
      vertical-align: middle;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    .nav-btn:hover { opacity: 0.9; }
    .nav-btn.active { background: var(--accent); color: var(--text); }

    .section {
      display: none;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section.active { display: block; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      text-align: center;
      border: 2px solid var(--accent);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    input, select {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover { opacity: 0.9; }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--primary);
      color: white;
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
    }

    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .summary-box {
      background: #fff7e6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      border: 1px solid #f5e1a8;
      font-weight: 600;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .materials-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }

    .section-header-with-image {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header-with-image img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-right: 1rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .lot-status {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .lot-status.open {
      background: #d1fae5;
      color: #065f46;
    }

    .lot-status.completed {
      background: #f3f4f6;
      color: #374151;
    }

    .progress-bar {
      background: #e5e7eb;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      height: 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .shift-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .shift-badge.day {
      background: #fef3c7;
      color: #92400e;
    }

    .shift-badge.night {
      background: #e0e7ff;
      color: #3730a3;
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <a href="./index.html" style="position: absolute; top: 20px; left: 20px; color: var(--primary); text-decoration: none; z-index: 10;">‚Üê Back to MES</a>
  <div class="login-form">
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <img src="src/assets/icons/pistachio.png" alt="Pistachio" style="width: 64px; height: 64px; margin-bottom: 1rem;" onerror="this.outerHTML='ü•ú'">
      <h2 style="color: var(--primary); margin: 0;">Pistachio Production Login</h2>
    </div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Username</label>
        <input id="loginUsername" type="text" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input id="loginPassword" type="password" required>
      </div>
      <button type="submit" style="width: 100%; margin-top: 1rem;">Login</button>
    </form>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
      <p><strong>Demo Credentials:</strong></p>
      <p>Admin: admin / admin123</p>
      <p>Operator: operator / op123</p>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display: none;">
  <header class="header">
    <div style="display: flex; align-items: center;">
      <a href="./index.html" class="back-link">‚Üê Back to MES</a>
      <img src="src/assets/icons/pistachio.png" alt="Pistachio" class="pistachio-brand-icon" onerror="this.outerHTML='ü•ú '">
      <h1>Pistachio Production Management</h1>
    </div>
    <div>
      <span id="userDisplay">User</span>
      <button onclick="logout()" style="margin-left: 1rem; background: rgba(255,255,255,0.2);">
        Logout
      </button>
    </div>
  </header>

  <div class="container">
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="showSection('lotmanagement')">Lot Management</button>
      <button class="nav-btn" onclick="showSection('production')">New Production</button>
      <button class="nav-btn" onclick="showSection('records')">View Records</button>
      <button class="nav-btn" onclick="showSection('inventory')">Inventory</button>
      <button class="nav-btn" onclick="showSection('reports')">Reports</button>
    </div>

    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>Production Dashboard</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div>Active Lots</div>
          <div class="stat-value" id="kpiActiveLots">0</div>
        </div>
        <div class="stat-card">
          <div>Total Finished (kg)</div>
          <div class="stat-value" id="kpiFinished">0</div>
        </div>
        <div class="stat-card">
          <div>Efficiency (%)</div>
          <div class="stat-value" id="kpiEff">0</div>
        </div>
        <div class="stat-card">
          <div>Reject Rate (%)</div>
          <div class="stat-value" id="kpiReject">0.0</div>
        </div>
      </div>
      <p>KPIs update automatically when you submit production records.</p>
    </section>

    <!-- Lot Management Section -->
    <section id="lotmanagement" class="section">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>Lot Management</h2>
      </div>
      
      <!-- Create New Lot -->
      <div class="materials-section">
        <h3>Create New Lot</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Lot Number</label>
            <input id="lotNumber" type="text" placeholder="e.g., Lot-01-02-03-2024" required>
          </div>
          <div class="form-group">
            <label>Brand</label>
            <select id="lotBrand">
              <option>Golden Hill</option>
              <option>Extra</option>
            </select>
          </div>
          <div class="form-group">
            <label>Total Containers</label>
            <input id="totalContainers" type="number" min="1" value="1" onchange="calculateLotTotals()">
          </div>
          <div class="form-group">
            <label>Bags per Container</label>
            <input id="bagsPerContainer" type="number" min="1" value="50" onchange="calculateLotTotals()">
          </div>
          <div class="form-group">
            <label>Kg per Bag</label>
            <input id="kgPerBag" type="number" min="0.1" step="0.1" value="25" onchange="calculateLotTotals()">
          </div>
          <div class="form-group">
            <label>Total Raw Quantity (kg)</label>
            <input id="totalRawQuantity" type="number" readonly style="background: #f8f9fa;">
          </div>
        </div>
        <button onclick="createLot()">Create Lot</button>
      </div>

      <!-- Active Lots Table -->
      <h3>Current Lots Status</h3>
      <div style="overflow-x: auto;">
        <table id="lotsTable">
          <thead>
            <tr>
              <th>Lot Number</th>
              <th>Brand</th>
              <th>Total Containers</th>
              <th>Total Raw (kg)</th>
              <th>Used (kg)</th>
              <th>Available (kg)</th>
              <th>Progress</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Production Entry Section (Modified) -->
    <section id="production" class="section">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>New Production Entry</h2>
      </div>
      
      <div class="warning-box">
        <strong>Note:</strong> Select an active lot to record production for a specific shift.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Select Lot</label>
          <select id="productionLot" onchange="updateLotInfo()" required>
            <option value="">Select a lot...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Shift</label>
          <select id="shift">
            <option value="Day">Day Shift</option>
            <option value="Night">Night Shift</option>
          </select>
        </div>
        <div class="form-group">
          <label>Production Date</label>
          <input id="productionDate" type="date" value="" required>
        </div>
        <div class="form-group">
          <label>Raw Input This Shift (kg)</label>
          <input id="rawInputShift" type="number" min="0" step="1" value="0" onchange="updateProductionSummary()">
        </div>
      </div>

      <!-- Lot Info Display -->
      <div id="lotInfoDisplay" class="materials-section" style="display: none;">
        <h4>Selected Lot Information</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div><strong>Brand:</strong> <span id="selectedLotBrand">-</span></div>
          <div><strong>Available Raw:</strong> <span id="selectedLotAvailable">-</span> kg</div>
          <div><strong>Total Containers:</strong> <span id="selectedLotContainers">-</span></div>
          <div><strong>Bags/Container:</strong> <span id="selectedLotBags">-</span></div>
        </div>
      </div>

      <!-- Final Goods Output -->
      <h3>Final Goods Output</h3>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="form-group">
          <label>18-21 Size (kg)</label>
          <input id="bags1821" type="number" min="0" step="1" value="0" onchange="updateProductionSummary()">
        </div>
        <div class="form-group">
          <label>21-25 Size (kg)</label>
          <input id="bags2125" type="number" min="0" step="1" value="0" onchange="updateProductionSummary()">
        </div>
      </div>

      <!-- Materials Usage -->
      <div class="materials-section">
        <h3>Materials Usage</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Vacuum Bags Used</label>
            <input id="bagsUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Used</label>
            <input id="boxesUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Vacuum Bags Wasted</label>
            <input id="bagsWasted" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Wasted</label>
            <input id="boxesWasted" type="number" min="0" step="1" value="0">
          </div>
        </div>
      </div>

      <!-- Rejects -->
      <div class="materials-section">
        <h3>Rejects (kg)</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Non-Split (Closed)</label>
            <input id="rejNonSplit" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Light Stain</label>
            <input id="rejLightStain" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Adhering Hull</label>
            <input id="rejAdheringHull" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Dark Stain</label>
            <input id="rejDarkStain" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Shell & Split</label>
            <input id="rejShellSplit" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Undersize & Kernel</label>
            <input id="rejUndersize" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Loose Shell</label>
            <input id="rejLooseShell" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Loose Kernel</label>
            <input id="rejLooseKernel" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
          <div class="form-group">
            <label>Dust</label>
            <input id="rejDust" type="number" min="0" step="5" value="0" onchange="updateProductionSummary()">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <button onclick="submitProduction()">Submit Production</button>
        <button class="btn-secondary" onclick="clearProductionForm()">Clear Form</button>
      </div>

      <div class="summary-box" id="productionSummary">
        Finished: 0 kg ‚Ä¢ Rejects: 0 kg ‚Ä¢ Efficiency: 0% ‚Ä¢ Yield: 0%
      </div>
    </section>

    <!-- Enhanced Records Section -->
    <section id="records" class="section">
      <h2 style="margin-bottom: 1rem;">üìã Production Records</h2>
      
      <!-- Filter Controls -->
      <div class="materials-section">
        <h3>Filter Records</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Filter by Lot</label>
            <select id="recordsLotFilter" onchange="filterRecords()">
              <option value="">All Lots</option>
            </select>
          </div>
          <div class="form-group">
            <label>Filter by Shift</label>
            <select id="recordsShiftFilter" onchange="filterRecords()">
              <option value="">All Shifts</option>
              <option value="Day">Day Shift</option>
              <option value="Night">Night Shift</option>
            </select>
          </div>
          <div class="form-group">
            <label>From Date</label>
            <input id="recordsFromDate" type="date" onchange="filterRecords()">
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input id="recordsToDate" type="date" onchange="filterRecords()">
          </div>
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Date/Time</th>
              <th>Lot Number</th>
              <th>Brand</th>
              <th>Shift</th>
              <th>Raw Input (kg)</th>
              <th>18-21 Size (kg)</th>
              <th>21-25 Size (kg)</th>
              <th>Finished (kg)</th>
              <th>Rejects (kg)</th>
              <th>Efficiency (%)</th>
              <th>Yield (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Enhanced Reports Section -->
    <section id="reports" class="section">
      <h2 style="margin-bottom: 1rem;">üìä Lot & Production Reports</h2>
      
      <div class="materials-section">
  <h3>Multi-Lot Summary Report</h3>
  <div class="form-grid">
    <div class="form-group">
      <label>Report Type</label>
      <select id="reportType" onchange="toggleLotSelection()">
        <option value="single">Single Lot Report</option>
        <option value="multiple">Multiple Lots Report</option>
      </select>
    </div>
    <div class="form-group" id="singleLotGroup">
      <label>Select Lot</label>
      <select id="reportLotSelect">
        <option value="">Choose a lot...</option>
      </select>
    </div>
    <div class="form-group" id="multipleLotGroup" style="display: none;">
      <label>Select Multiple Lots</label>
      <div id="lotCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.5rem;">
        <!-- Checkboxes will be populated here -->
      </div>
      <div style="margin-top: 0.5rem;">
        <button type="button" onclick="selectAllLots()" class="btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Select All</button>
        <button type="button" onclick="clearAllLots()" class="btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Clear All</button>
        <span id="selectedLotsCount" style="margin-left: 1rem; font-size: 0.9rem; color: var(--muted);">0 lots selected</span>
      </div>
    </div>
    <div class="form-group">
      <label>&nbsp;</label>
      <button onclick="generateLotReport()" style="width: 100%;">Generate Report</button>
    </div>
  </div>
</div>

      <!-- Report Preview Area -->
      <div id="lotReportPreview" style="display: none; margin-top: 2rem;">
  <div style="text-align: right; margin-bottom: 1rem;">
    <button onclick="printLotReport()">üñ®Ô∏è Print Report</button>
    <button onclick="exportLotReportPDF()" class="btn-secondary">üìÑ Export PDF</button>
    <button onclick="exportLotReportExcel()" class="btn-secondary">üìä Export Excel</button>
  </div>
  <div id="lotReportContent" class="report-content">
          <!-- Lot report content will be generated here -->
        </div>
      </div>
    </section>

    <!-- Inventory Section (Simplified) -->
    <section id="inventory" class="section">
      <h2 style="margin-bottom: 1rem;">üì¶ Inventory Management</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Vacuum Bags (10kg)</div>
          <div class="stat-value" id="invVacuumBags">0</div>
        </div>
        <div class="stat-card">
          <div>Golden Hill Boxes</div>
          <div class="stat-value" id="invGoldenHillBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Extra Boxes</div>
          <div class="stat-value" id="invExtraBoxes">0</div>
        </div>
      </div>

      <div class="materials-section">
        <h3>Stock Adjustment</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Item</label>
            <select id="invItem">
              <option value="vacuumBags">Vacuum Bags (10kg)</option>
              <option value="goldenHillBoxes">Golden Hill Boxes</option>
              <option value="extraBoxes">Extra Boxes</option>
            </select>
          </div>
          <div class="form-group">
            <label>Action</label>
            <select id="invAction">
              <option value="add">Add Stock</option>
              <option value="remove">Remove Stock</option>
              <option value="set">Set Exact Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input id="invQuantity" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input id="invNotes" type="text" placeholder="Reason for adjustment">
          </div>
        </div>
        <button onclick="adjustInventory()">Update Inventory</button>
        <button class="btn-secondary" onclick="exportInventoryExcel()">üìä Export Excel</button>
    <button class="btn-secondary" onclick="exportInventoryPDF()">üìÑ Export PDF</button>
      </div>
    </section>
  </div>
</div>

<script>
// Enhanced State Management with Lot Support
class EnhancedAppState {
  constructor() {
    this.data = {
      lots: [],
      productionRecords: [],
      inventoryLog: [],
      currentInventory: {
        vacuumBags: 0,
        goldenHillBoxes: 0,
        extraBoxes: 0
      },
      currentUser: null
    };
    this.listeners = {};
    this.loadFromStorage();
  }

  subscribe(key, callback) {
    if (!this.listeners[key]) {
      this.listeners[key] = [];
    }
    this.listeners[key].push(callback);
  }

  setState(key, value) {
    this.data[key] = value;
    this.saveToStorage();
    this.notify(key, value);
  }

  getState(key) {
    return this.data[key];
  }

  notify(key, value) {
    if (this.listeners[key]) {
      this.listeners[key].forEach(callback => callback(value));
    }
  }

  addToArray(key, item) {
    if (Array.isArray(this.data[key])) {
      this.data[key].push(item);
      this.saveToStorage();
      this.notify(key, this.data[key]);
    }
  }

  updateArrayItem(key, id, updater) {
    if (Array.isArray(this.data[key])) {
      const index = this.data[key].findIndex(item => item.id === id);
      if (index !== -1) {
        this.data[key][index] = updater(this.data[key][index]);
        this.saveToStorage();
        this.notify(key, this.data[key]);
      }
    }
  }

  updateInventory(item, action, quantity) {
    const current = this.data.currentInventory[item] || 0;
    let newValue;

    switch(action) {
      case 'add':
        newValue = current + quantity;
        break;
      case 'remove':
        newValue = Math.max(0, current - quantity);
        break;
      case 'set':
        newValue = Math.max(0, quantity);
        break;
      default:
        return false;
    }

    this.data.currentInventory[item] = newValue;
    this.saveToStorage();
    this.notify('currentInventory', this.data.currentInventory);
    return true;
  }

  saveToStorage() {
    try {
      localStorage.setItem('pistachio_enhanced_mes_data', JSON.stringify(this.data));
    } catch (e) {
      console.warn('Could not save to localStorage:', e);
    }
  }

  loadFromStorage() {
    try {
      const saved = localStorage.getItem('pistachio_enhanced_mes_data');
      if (saved) {
        const parsed = JSON.parse(saved);
        this.data = { ...this.data, ...parsed };
      }
    } catch (e) {
      console.warn('Could not load from localStorage:', e);
    }
  }
}

// Initialize Enhanced State
window.appState = new EnhancedAppState();

// User management
const users = { admin: 'admin123', operator: 'op123' };

// Login handling
function handleLogin(event) {
  event.preventDefault();
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  
  if (users[username] && users[username] === password) {
    window.appState.setState('currentUser', username);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userDisplay').textContent = username;
    
    // Set today's date
    document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];
    
    updateDashboard();
    renderLots();
    renderRecords();
    renderInventory();
    updateProductionLotDropdown();
    updateReportsLotDropdown();
  } else {
    alert('Invalid credentials');
  }
}

function logout() {
  window.appState.setState('currentUser', null);
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

// Navigation
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.getElementById(sectionId).classList.add('active');
  event.target.classList.add('active');
}

// Lot Management Functions
function calculateLotTotals() {
  const containers = parseInt(document.getElementById('totalContainers').value) || 0;
  const bagsPerContainer = parseInt(document.getElementById('bagsPerContainer').value) || 0;
  const kgPerBag = parseFloat(document.getElementById('kgPerBag').value) || 0;
  
  const totalRawQuantity = containers * bagsPerContainer * kgPerBag;
  document.getElementById('totalRawQuantity').value = totalRawQuantity;
}

function createLot() {
  const lotNumber = document.getElementById('lotNumber').value.trim();
  const brand = document.getElementById('lotBrand').value;
  const totalContainers = parseInt(document.getElementById('totalContainers').value) || 0;
  const bagsPerContainer = parseInt(document.getElementById('bagsPerContainer').value) || 0;
  const kgPerBag = parseFloat(document.getElementById('kgPerBag').value) || 0;
  const totalRawQuantity = parseFloat(document.getElementById('totalRawQuantity').value) || 0;
  
  if (!lotNumber) {
    alert('Please enter a lot number');
    return;
  }
  
  if (totalContainers <= 0 || bagsPerContainer <= 0 || kgPerBag <= 0) {
    alert('Please enter valid quantities');
    return;
  }
  
  // Check for duplicate lot number
  const lots = window.appState.getState('lots') || [];
  if (lots.some(lot => lot.lotNumber === lotNumber)) {
    alert('Lot number already exists');
    return;
  }
  
  const newLot = {
    id: Date.now().toString(),
    lotNumber,
    brand,
    totalContainers,
    bagsPerContainer,
    kgPerBag,
    totalRawQuantity,
    availableRawQuantity: totalRawQuantity,
    usedRawQuantity: 0,
    status: 'Open',
    createdDate: new Date().toISOString()
  };
  
  window.appState.addToArray('lots', newLot);
  
  // Clear form
  document.getElementById('lotNumber').value = '';
  document.getElementById('totalContainers').value = '1';
  document.getElementById('bagsPerContainer').value = '50';
  document.getElementById('kgPerBag').value = '25';
  document.getElementById('totalRawQuantity').value = '';
  
  alert('Lot created successfully!');
  renderLots();
  updateProductionLotDropdown();
  updateReportsLotDropdown();
  updateDashboard();
}

function renderLots() {
  const tbody = document.querySelector('#lotsTable tbody');
  tbody.innerHTML = '';
  
  const lots = window.appState.getState('lots') || [];
  lots.forEach(lot => {
    const progressPercent = lot.totalRawQuantity > 0 
      ? Math.round((lot.usedRawQuantity / lot.totalRawQuantity) * 100) 
      : 0;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${lot.lotNumber}</strong></td>
      <td>${lot.brand}</td>
      <td>${lot.totalContainers}</td>
      <td>${lot.totalRawQuantity.toLocaleString()}</td>
      <td>${lot.usedRawQuantity.toLocaleString()}</td>
      <td>${lot.availableRawQuantity.toLocaleString()}</td>
      <td>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressPercent}%;">
            ${progressPercent}%
          </div>
        </div>
      </td>
      <td><span class="lot-status ${lot.status.toLowerCase()}">${lot.status}</span></td>
      <td>${new Date(lot.createdDate).toLocaleDateString()}</td>
    `;
    tbody.appendChild(row);
  });
}

// Production Functions
function updateProductionLotDropdown() {
  const dropdown = document.getElementById('productionLot');
  dropdown.innerHTML = '<option value="">Select a lot...</option>';
  
  const lots = window.appState.getState('lots') || [];
  const openLots = lots.filter(lot => lot.status === 'Open' && lot.availableRawQuantity > 0);
  
  openLots.forEach(lot => {
    const option = document.createElement('option');
    option.value = lot.id;
    option.textContent = `${lot.lotNumber} (${lot.brand}) - ${lot.availableRawQuantity} kg available`;
    dropdown.appendChild(option);
  });
}

function updateLotInfo() {
  const lotId = document.getElementById('productionLot').value;
  const lotDisplay = document.getElementById('lotInfoDisplay');
  
  if (!lotId) {
    lotDisplay.style.display = 'none';
    return;
  }
  
  const lots = window.appState.getState('lots') || [];
  const selectedLot = lots.find(lot => lot.id === lotId);
  
  if (selectedLot) {
    document.getElementById('selectedLotBrand').textContent = selectedLot.brand;
    document.getElementById('selectedLotAvailable').textContent = selectedLot.availableRawQuantity.toLocaleString();
    document.getElementById('selectedLotContainers').textContent = selectedLot.totalContainers;
    document.getElementById('selectedLotBags').textContent = selectedLot.bagsPerContainer;
    lotDisplay.style.display = 'block';
  }
}

function updateProductionSummary() {
  const kg1821 = parseInt(document.getElementById('bags1821').value) || 0;
  const kg2125 = parseInt(document.getElementById('bags2125').value) || 0;
  const finishedKg = kg1821 + kg2125;
  
  const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                    'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
  const rejectsKg = rejectIds.reduce((sum, id) => {
    return sum + (parseInt(document.getElementById(id).value) || 0);
  }, 0);
  
  const rawInput = parseInt(document.getElementById('rawInputShift').value) || 0;
  const totalOutput = finishedKg + rejectsKg;
  
  const efficiency = rawInput > 0 ? Math.round((finishedKg / rawInput) * 100) : 0;
  const yield = rawInput > 0 ? Math.round((totalOutput / rawInput) * 100) : 0;
  
  document.getElementById('productionSummary').textContent = 
    `Finished: ${finishedKg} kg ‚Ä¢ Rejects: ${rejectsKg} kg ‚Ä¢ Efficiency: ${efficiency}% ‚Ä¢ Yield: ${yield}%`;
}

function submitProduction() {
  const lotId = document.getElementById('productionLot').value;
  const shift = document.getElementById('shift').value;
  const productionDate = document.getElementById('productionDate').value;
  const rawInputShift = parseInt(document.getElementById('rawInputShift').value) || 0;
  
  if (!lotId) {
    alert('Please select a lot');
    return;
  }
  
  if (!productionDate) {
    alert('Please select a production date');
    return;
  }
  
  if (rawInputShift <= 0) {
    alert('Please enter raw input quantity');
    return;
  }
  
  const lots = window.appState.getState('lots') || [];
  const selectedLot = lots.find(lot => lot.id === lotId);
  
  if (!selectedLot) {
    alert('Selected lot not found');
    return;
  }
  
  if (rawInputShift > selectedLot.availableRawQuantity) {
    alert(`Insufficient raw material. Available: ${selectedLot.availableRawQuantity} kg`);
    return;
  }
  
  const bags1821 = parseInt(document.getElementById('bags1821').value) || 0;
  const bags2125 = parseInt(document.getElementById('bags2125').value) || 0;
  const finishedKg = bags1821 + bags2125;
  
  if (finishedKg <= 0) {
    alert('Please enter finished goods quantities');
    return;
  }
  
  const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                    'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
  const rejectsKg = rejectIds.reduce((sum, id) => {
    return sum + (parseInt(document.getElementById(id).value) || 0);
  }, 0);
  
  const totalOutput = finishedKg + rejectsKg;
  const efficiency = Math.round((finishedKg / rawInputShift) * 100);
  const yield = Math.round((totalOutput / rawInputShift) * 100);
  
  const productionRecord = {
    id: Date.now().toString(),
    lotId: lotId,
    lotNumber: selectedLot.lotNumber,
    brand: selectedLot.brand,
    shift: shift,
    productionDate: productionDate,
    timestamp: new Date().toISOString(),
    rawInputShift: rawInputShift,
    kg1821: bags1821,
    kg2125: bags2125,
    finishedKg: finishedKg,
    rejectsKg: rejectsKg,
    totalOutput: totalOutput,
    efficiency: efficiency,
    yield: yield,
    materials: {
      bagsUsed: parseInt(document.getElementById('bagsUsed').value) || 0,
      boxesUsed: parseInt(document.getElementById('boxesUsed').value) || 0,
      bagsWasted: parseInt(document.getElementById('bagsWasted').value) || 0,
      boxesWasted: parseInt(document.getElementById('boxesWasted').value) || 0
    },
    rejects: {
      nonSplit: parseInt(document.getElementById('rejNonSplit').value) || 0,
      lightStain: parseInt(document.getElementById('rejLightStain').value) || 0,
      adheringHull: parseInt(document.getElementById('rejAdheringHull').value) || 0,
      darkStain: parseInt(document.getElementById('rejDarkStain').value) || 0,
      shellSplit: parseInt(document.getElementById('rejShellSplit').value) || 0,
      undersize: parseInt(document.getElementById('rejUndersize').value) || 0,
      looseShell: parseInt(document.getElementById('rejLooseShell').value) || 0,
      looseKernel: parseInt(document.getElementById('rejLooseKernel').value) || 0,
      dust: parseInt(document.getElementById('rejDust').value) || 0
    }
  };
  
  // Add production record
  window.appState.addToArray('productionRecords', productionRecord);
  
  // Update lot quantities
  window.appState.updateArrayItem('lots', lotId, (lot) => {
    lot.usedRawQuantity += rawInputShift;
    lot.availableRawQuantity -= rawInputShift;
    if (lot.availableRawQuantity <= 0) {
      lot.status = 'Completed';
    }
    return lot;
  });
  
  // Handle inventory updates (materials usage)
  const totalBagsNeeded = productionRecord.materials.bagsUsed + productionRecord.materials.bagsWasted;
  const totalBoxesNeeded = productionRecord.materials.boxesUsed + productionRecord.materials.boxesWasted;
  const boxType = selectedLot.brand === 'Golden Hill' ? 'goldenHillBoxes' : 'extraBoxes';
  
  if (totalBagsNeeded > 0) {
    window.appState.updateInventory('vacuumBags', 'remove', totalBagsNeeded);
  }
  if (totalBoxesNeeded > 0) {
    window.appState.updateInventory(boxType, 'remove', totalBoxesNeeded);
  }
  
  alert('Production record submitted successfully!');
  clearProductionForm();
  updateDashboard();
  renderLots();
  renderRecords();
  updateProductionLotDropdown();
}

function clearProductionForm() {
  document.getElementById('productionLot').value = '';
  document.getElementById('rawInputShift').value = '0';
  document.querySelectorAll('#production input[type="number"]').forEach(input => {
    input.value = '0';
  });
  document.getElementById('lotInfoDisplay').style.display = 'none';
  updateProductionSummary();
}

// Dashboard Functions
function updateDashboard() {
  const lots = window.appState.getState('lots') || [];
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  const activeLots = lots.filter(lot => lot.status === 'Open').length;
  
  let totalFinished = 0;
  let totalInput = 0;
  let totalRejects = 0;
  
  productionRecords.forEach(record => {
    totalFinished += record.finishedKg;
    totalInput += record.rawInputShift;
    totalRejects += record.rejectsKg;
  });
  
  const avgEfficiency = totalInput > 0 ? Math.round((totalFinished / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((totalRejects / totalInput) * 1000) / 10 : 0;
  
  document.getElementById('kpiActiveLots').textContent = activeLots;
  document.getElementById('kpiFinished').textContent = totalFinished.toLocaleString();
  document.getElementById('kpiEff').textContent = avgEfficiency;
  document.getElementById('kpiReject').textContent = rejectRate.toFixed(1);
}

// Records Functions
function renderRecords() {
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(record.timestamp).toLocaleString()}</td>
      <td>${record.lotNumber}</td>
      <td>${record.brand}</td>
      <td><span class="shift-badge ${record.shift.toLowerCase()}">${record.shift}</span></td>
      <td>${record.rawInputShift.toLocaleString()}</td>
      <td>${record.kg1821.toLocaleString()}</td>
      <td>${record.kg2125.toLocaleString()}</td>
      <td><strong>${record.finishedKg.toLocaleString()}</strong></td>
      <td>${record.rejectsKg.toLocaleString()}</td>
      <td><strong>${record.efficiency}%</strong></td>
      <td>${record.yield}%</td>
    `;
    tbody.appendChild(row);
  });
  
  updateRecordsFilters();
}

function updateRecordsFilters() {
  const lots = window.appState.getState('lots') || [];
  const lotFilter = document.getElementById('recordsLotFilter');
  
  // Update lot filter options
  const currentValue = lotFilter.value;
  lotFilter.innerHTML = '<option value="">All Lots</option>';
  lots.forEach(lot => {
    const option = document.createElement('option');
    option.value = lot.lotNumber;
    option.textContent = `${lot.lotNumber} (${lot.brand})`;
    if (option.value === currentValue) option.selected = true;
    lotFilter.appendChild(option);
  });
}

function filterRecords() {
  const lotFilter = document.getElementById('recordsLotFilter').value;
  const shiftFilter = document.getElementById('recordsShiftFilter').value;
  const fromDate = document.getElementById('recordsFromDate').value;
  const toDate = document.getElementById('recordsToDate').value;
  
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  
  let productionRecords = window.appState.getState('productionRecords') || [];
  
  // Apply filters
  if (lotFilter) {
    productionRecords = productionRecords.filter(record => record.lotNumber === lotFilter);
  }
  
  if (shiftFilter) {
    productionRecords = productionRecords.filter(record => record.shift === shiftFilter);
  }
  
  if (fromDate) {
    productionRecords = productionRecords.filter(record => record.productionDate >= fromDate);
  }
  
  if (toDate) {
    productionRecords = productionRecords.filter(record => record.productionDate <= toDate);
  }
  
  // Render filtered records
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(record.timestamp).toLocaleString()}</td>
      <td>${record.lotNumber}</td>
      <td>${record.brand}</td>
      <td><span class="shift-badge ${record.shift.toLowerCase()}">${record.shift}</span></td>
      <td>${record.rawInputShift.toLocaleString()}</td>
      <td>${record.kg1821.toLocaleString()}</td>
      <td>${record.kg2125.toLocaleString()}</td>
      <td><strong>${record.finishedKg.toLocaleString()}</strong></td>
      <td>${record.rejectsKg.toLocaleString()}</td>
      <td><strong>${record.efficiency}%</strong></td>
      <td>${record.yield}%</td>
    `;
    tbody.appendChild(row);
  });
}

// Reports Functions
function updateReportsLotDropdown() {
  const dropdown = document.getElementById('reportLotSelect');
  const checkboxContainer = document.getElementById('lotCheckboxes');
  
  dropdown.innerHTML = '<option value="">Choose a lot...</option>';
  if (checkboxContainer) checkboxContainer.innerHTML = '';
  
  const lots = window.appState.getState('lots') || [];
  lots.forEach(lot => {
    // Single lot dropdown
    const option = document.createElement('option');
    option.value = lot.id;
    option.textContent = `${lot.lotNumber} (${lot.brand}) - ${lot.status}`;
    dropdown.appendChild(option);
    
    // Multiple lots checkboxes
    if (checkboxContainer) {
      const checkboxDiv = document.createElement('div');
      checkboxDiv.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid #eee;';
      checkboxDiv.innerHTML = `
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" value="${lot.id}" onchange="updateSelectedCount()">
          <div>
            <strong>${lot.lotNumber}</strong> (${lot.brand})
            <div style="font-size: 0.8rem; color: var(--muted);">
              ${lot.status} ‚Ä¢ ${lot.totalRawQuantity.toLocaleString()} kg total
            </div>
          </div>
        </label>
      `;
      checkboxContainer.appendChild(checkboxDiv);
    }
  });
}

function generateLotReport() {
  const reportType = document.getElementById('reportType') ? document.getElementById('reportType').value : 'single';
  let selectedLotIds = [];
  
  if (reportType === 'single') {
    const singleLotId = document.getElementById('reportLotSelect').value;
    if (!singleLotId) {
      alert('Please select a lot');
      return;
    }
    selectedLotIds = [singleLotId];
  } else {
    const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]:checked');
    selectedLotIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedLotIds.length === 0) {
      alert('Please select at least one lot');
      return;
    }
  }
  
  const lots = window.appState.getState('lots') || [];
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  const selectedLots = lots.filter(lot => selectedLotIds.includes(lot.id));
  const allLotRecords = productionRecords.filter(record => selectedLotIds.includes(record.lotId));
  
  if (selectedLots.length === 1) {
    generateLotReportHTML(selectedLots[0], allLotRecords);
  } else {
    generateMultiLotReportHTML(selectedLots, allLotRecords);
  }
  
  document.getElementById('lotReportPreview').style.display = 'block';
}

function generateLotReportHTML(lot, records) {
  const reportContent = document.getElementById('lotReportContent');
  
  // Calculate totals
  const totalRawUsed = records.reduce((sum, r) => sum + r.rawInputShift, 0);
  const totalFinished = records.reduce((sum, r) => sum + r.finishedKg, 0);
  const totalRejects = records.reduce((sum, r) => sum + r.rejectsKg, 0);
  const avgEfficiency = totalRawUsed > 0 ? Math.round((totalFinished / totalRawUsed) * 100) : 0;
  const avgYield = totalRawUsed > 0 ? Math.round(((totalFinished + totalRejects) / totalRawUsed) * 100) : 0;
  
  const reportHTML = `
    <div style="padding: 2rem; background: white; border-radius: 0.5rem;">
      <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 3px solid var(--primary);">
        <h1 style="color: var(--primary); margin: 0;">Al Jameel MES</h1>
        <h2 style="margin: 0.5rem 0;">Lot Production Report</h2>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div>
          <h3 style="color: var(--primary); margin-bottom: 1rem;">Lot Information</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Lot Number:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.lotNumber}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Brand:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.brand}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Total Containers:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.totalContainers}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Bags per Container:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.bagsPerContainer}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Kg per Bag:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.kgPerBag}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Total Raw Quantity:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.totalRawQuantity.toLocaleString()} kg</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem;">Status:</td><td style="padding: 0.5rem;"><span class="lot-status ${lot.status.toLowerCase()}">${lot.status}</span></td></tr>
          </table>
        </div>

        <div>
          <h3 style="color: var(--primary); margin-bottom: 1rem;">Production Summary</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${records.length}</div>
              <div style="font-size: 0.9rem;">Total Shifts</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${totalRawUsed.toLocaleString()}</div>
              <div style="font-size: 0.9rem;">Raw Used (kg)</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${totalFinished.toLocaleString()}</div>
              <div style="font-size: 0.9rem;">Finished (kg)</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${avgEfficiency}%</div>
              <div style="font-size: 0.9rem;">Avg Efficiency</div>
            </div>
          </div>
        </div>
      </div>

      <h3 style="color: var(--primary); margin-bottom: 1rem;">Shift-wise Production Details</h3>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
          <thead>
            <tr style="background: var(--primary); color: white;">
              <th style="padding: 0.75rem; text-align: left;">Date</th>
              <th style="padding: 0.75rem; text-align: left;">Shift</th>
              <th style="padding: 0.75rem; text-align: right;">Raw Input (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">18-21 Size (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">21-25 Size (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Finished (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Rejects (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Efficiency (%)</th>
              <th style="padding: 0.75rem; text-align: right;">Yield (%)</th>
            </tr>
          </thead>
          <tbody>
            ${records.map(record => `
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 0.5rem;">${new Date(record.productionDate).toLocaleDateString()}</td>
                <td style="padding: 0.5rem;"><span class="shift-badge ${record.shift.toLowerCase()}">${record.shift}</span></td>
                <td style="padding: 0.5rem; text-align: right;">${record.rawInputShift.toLocaleString()}</td>
                <td style="padding: 0.5rem; text-align: right;">${record.kg1821.toLocaleString()}</td>
                <td style="padding: 0.5rem; text-align: right;">${record.kg2125.toLocaleString()}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${record.finishedKg.toLocaleString()}</td>
                <td style="padding: 0.5rem; text-align: right;">${record.rejectsKg.toLocaleString()}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${record.efficiency}%</td>
                <td style="padding: 0.5rem; text-align: right;">${record.yield}%</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background: #f8f9fa; font-weight: bold;">
              <td style="padding: 0.75rem;" colspan="2">TOTALS</td>
              <td style="padding: 0.75rem; text-align: right;">${totalRawUsed.toLocaleString()}</td>
              <td style="padding: 0.75rem; text-align: right;">${records.reduce((sum, r) => sum + r.kg1821, 0).toLocaleString()}</td>
              <td style="padding: 0.75rem; text-align: right;">${records.reduce((sum, r) => sum + r.kg2125, 0).toLocaleString()}</td>
              <td style="padding: 0.75rem; text-align: right;">${totalFinished.toLocaleString()}</td>
              <td style="padding: 0.75rem; text-align: right;">${totalRejects.toLocaleString()}</td>
              <td style="padding: 0.75rem; text-align: right;">${avgEfficiency}%</td>
              <td style="padding: 0.75rem; text-align: right;">${avgYield}%</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 0.5rem; text-align: center; border-top: 3px solid var(--primary);">
        <p style="margin: 0; color: var(--primary); font-weight: 600;">Al Jameel MES - Pistachio Production Management System</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #6c757d;">Generated: ${new Date().toLocaleString()} | Confidential Report</p>
      </div>
    </div>
  `;
  
  reportContent.innerHTML = reportHTML;
}
// ADD these new functions after the existing generateLotReportHTML function

function toggleLotSelection() {
  const reportType = document.getElementById('reportType').value;
  const singleGroup = document.getElementById('singleLotGroup');
  const multipleGroup = document.getElementById('multipleLotGroup');
  
  if (reportType === 'single') {
    singleGroup.style.display = 'block';
    multipleGroup.style.display = 'none';
  } else {
    singleGroup.style.display = 'none';
    multipleGroup.style.display = 'block';
  }
}

function selectAllLots() {
  const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = true);
  updateSelectedCount();
}

function clearAllLots() {
  const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
  updateSelectedCount();
}

function updateSelectedCount() {
  const countElement = document.getElementById('selectedLotsCount');
  if (countElement) {
    const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]:checked');
    countElement.textContent = `${checkboxes.length} lots selected`;
  }
}

function generateMultiLotReportHTML(lots, allRecords) {
  const reportContent = document.getElementById('lotReportContent');
  
  // Calculate combined totals
  const totalRawUsed = allRecords.reduce((sum, r) => sum + r.rawInputShift, 0);
  const totalFinished = allRecords.reduce((sum, r) => sum + r.finishedKg, 0);
  const totalRejects = allRecords.reduce((sum, r) => sum + r.rejectsKg, 0);
  const totalShifts = allRecords.length;
  const avgEfficiency = totalRawUsed > 0 ? Math.round((totalFinished / totalRawUsed) * 100) : 0;
  
  // Calculate lot-wise summaries
  const lotSummaries = lots.map(lot => {
    const lotRecords = allRecords.filter(r => r.lotId === lot.id);
    const lotRawUsed = lotRecords.reduce((sum, r) => sum + r.rawInputShift, 0);
    const lotFinished = lotRecords.reduce((sum, r) => sum + r.finishedKg, 0);
    const lotRejects = lotRecords.reduce((sum, r) => sum + r.rejectsKg, 0);
    const lotEfficiency = lotRawUsed > 0 ? Math.round((lotFinished / lotRawUsed) * 100) : 0;
    
    return {
      lot,
      records: lotRecords,
      totalRawUsed: lotRawUsed,
      totalFinished: lotFinished,
      totalRejects: lotRejects,
      efficiency: lotEfficiency,
      shiftsCount: lotRecords.length
    };
  });
  
  const reportHTML = `
    <div style="padding: 2rem; background: white; border-radius: 0.5rem;">
      <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 3px solid var(--primary);">
        <h1 style="color: var(--primary); margin: 0;">Al Jameel MES</h1>
        <h2 style="margin: 0.5rem 0;">Multi-Lot Production Report</h2>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
        <p><strong>Lots Included:</strong> ${lots.length} lots ‚Ä¢ <strong>Total Shifts:</strong> ${totalShifts}</p>
      </div>

      <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; border-left: 4px solid var(--primary);">
        <h3 style="color: var(--primary); margin-bottom: 1rem;">üìä Combined Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${lots.length}</div>
            <div style="font-size: 0.9rem;">Total Lots</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${totalFinished.toLocaleString()}</div>
            <div style="font-size: 0.9rem;">Finished (kg)</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${avgEfficiency}%</div>
            <div style="font-size: 0.9rem;">Avg Efficiency</div>
          </div>
        </div>
      </div>

      <h3 style="color: var(--primary); margin-bottom: 1rem;">üìà Lot Performance Comparison</h3>
      <div style="overflow-x: auto; margin-bottom: 2rem;">
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
          <thead>
            <tr style="background: var(--primary); color: white;">
              <th style="padding: 0.75rem; text-align: left;">Lot Number</th>
              <th style="padding: 0.75rem; text-align: left;">Brand</th>
              <th style="padding: 0.75rem; text-align: right;">Finished (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Efficiency (%)</th>
            </tr>
          </thead>
          <tbody>
            ${lotSummaries.map(summary => `
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 0.5rem; font-weight: bold;">${summary.lot.lotNumber}</td>
                <td style="padding: 0.5rem;">${summary.lot.brand}</td>
                <td style="padding: 0.5rem; text-align: right;">${summary.totalFinished.toLocaleString()}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${summary.efficiency}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 0.5rem; text-align: center;">
        <p style="margin: 0; color: var(--primary); font-weight: 600;">Al Jameel MES - Multi-Lot Production Report</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #6c757d;">Generated: ${new Date().toLocaleString()}</p>
      </div>
    </div>
  `;
  
  reportContent.innerHTML = reportHTML;
}
function printLotReport() {
  window.print();
}

// Inventory Functions (Simplified)
function renderInventory() {
  const currentInventory = window.appState.getState('currentInventory') || {};
  document.getElementById('invVacuumBags').textContent = currentInventory.vacuumBags || 0;
  document.getElementById('invGoldenHillBoxes').textContent = currentInventory.goldenHillBoxes || 0;
  document.getElementById('invExtraBoxes').textContent = currentInventory.extraBoxes || 0;
}

function adjustInventory() {
  const item = document.getElementById('invItem').value;
  const action = document.getElementById('invAction').value;
  const quantity = parseInt(document.getElementById('invQuantity').value) || 0;
  const notes = document.getElementById('invNotes').value;
  
  if (quantity <= 0 && action !== 'set') {
    alert('Please enter a valid quantity');
    return;
  }
  
  const success = window.appState.updateInventory(item, action, quantity);
  
  if (success) {
    document.getElementById('invQuantity').value = 0;
    document.getElementById('invNotes').value = '';
    alert('Inventory updated successfully');
  } else {
    alert('Failed to update inventory');
  }
  
  renderInventory();
}
// Export Functions
function exportInventoryExcel() {
  const inventoryLog = window.appState.getState('inventoryLog') || [];
  const currentInventory = window.appState.getState('currentInventory') || {};
  
  if (inventoryLog.length === 0) {
    alert('No inventory data to export');
    return;
  }

  // Create workbook
  const wb = XLSX.utils.book_new();
  
  // Current Stock Sheet
  const stockData = [
    ['Item', 'Current Quantity'],
    ['Vacuum Bags (10kg)', currentInventory.vacuumBags || 0],
    ['Golden Hill Boxes', currentInventory.goldenHillBoxes || 0],
    ['Extra Boxes', currentInventory.extraBoxes || 0]
  ];
  const stockWs = XLSX.utils.aoa_to_sheet(stockData);
  XLSX.utils.book_append_sheet(wb, stockWs, 'Current Stock');
  
  // Inventory Log Sheet
  const logData = [
    ['Timestamp', 'Item', 'Action', 'Quantity', 'Result', 'Notes'],
    ...inventoryLog.map(log => [
      new Date(log.timestamp).toLocaleString(),
      log.item,
      log.action,
      log.quantity,
      log.result,
      log.notes || ''
    ])
  ];
  const logWs = XLSX.utils.aoa_to_sheet(logData);
  XLSX.utils.book_append_sheet(wb, logWs, 'Inventory Log');
  
  // Save file
  XLSX.writeFile(wb, `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function exportInventoryPDF() {
  const inventoryLog = window.appState.getState('inventoryLog') || [];
  const currentInventory = window.appState.getState('currentInventory') || {};
  
  if (inventoryLog.length === 0) {
    alert('No inventory data to export');
    return;
  }

  let pdfContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Inventory Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #a32034; padding-bottom: 10px; }
        .stock-summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stock-card { padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; }
        .stock-value { font-size: 24px; font-weight: bold; color: #a32034; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #a32034; color: white; }
        @media print { body { margin: 0; } }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Al Jameel MES - Inventory Report</h1>
        <p>Generated: ${new Date().toLocaleString()}</p>
      </div>
      
      <h2>Current Stock Levels</h2>
      <div class="stock-summary">
        <div class="stock-card">
          <div class="stock-value">${currentInventory.vacuumBags || 0}</div>
          <div>Vacuum Bags (10kg)</div>
        </div>
        <div class="stock-card">
          <div class="stock-value">${currentInventory.goldenHillBoxes || 0}</div>
          <div>Golden Hill Boxes</div>
        </div>
        <div class="stock-card">
          <div class="stock-value">${currentInventory.extraBoxes || 0}</div>
          <div>Extra Boxes</div>
        </div>
      </div>
      
      <h2>Recent Inventory Movements</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Item</th>
            <th>Action</th>
            <th>Quantity</th>
            <th>Result</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          ${inventoryLog.slice(-20).reverse().map(log => `
            <tr>
              <td>${new Date(log.timestamp).toLocaleDateString()}</td>
              <td>${log.item}</td>
              <td>${log.action}</td>
              <td>${log.quantity}</td>
              <td>${log.result}</td>
              <td>${log.notes || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfContent);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 250);
}

function exportLotReportPDF() {
  const reportContent = document.getElementById('lotReportContent');
  if (!reportContent || !reportContent.innerHTML.trim()) {
    alert('Please generate a lot report first');
    return;
  }
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Lot Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        .lot-status.open { background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 4px; }
        .lot-status.completed { background: #f3f4f6; color: #374151; padding: 4px 8px; border-radius: 4px; }
        .shift-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .shift-badge.day { background: #fef3c7; color: #92400e; }
        .shift-badge.night { background: #e0e7ff; color: #3730a3; }
        @media print { body { margin: 0; } @page { margin: 1in; } }
      </style>
    </head>
    <body>
      ${reportContent.innerHTML}
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 250);
}

function exportLotReportExcel() {
  const reportType = document.getElementById('reportType') ? document.getElementById('reportType').value : 'single';
  let selectedLotIds = [];
  
  if (reportType === 'single') {
    const singleLotId = document.getElementById('reportLotSelect').value;
    if (!singleLotId) {
      alert('Please generate a lot report first');
      return;
    }
    selectedLotIds = [singleLotId];
  } else {
    const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]:checked');
    selectedLotIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedLotIds.length === 0) {
      alert('Please generate a lot report first');
      return;
    }
  }
  
  const lots = window.appState.getState('lots') || [];
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  const selectedLot = lots.find(lot => lot.id === lotId);
  const lotRecords = productionRecords.filter(record => record.lotId === lotId);
  
  const wb = XLSX.utils.book_new();
  
  // Lot Summary Sheet
  const summaryData = [
    ['Lot Information', ''],
    ['Lot Number', selectedLot.lotNumber],
    ['Brand', selectedLot.brand],
    ['Total Containers', selectedLot.totalContainers],
    ['Bags per Container', selectedLot.bagsPerContainer],
    ['Kg per Bag', selectedLot.kgPerBag],
    ['Total Raw Quantity (kg)', selectedLot.totalRawQuantity],
    ['Status', selectedLot.status],
    ['', ''],
    ['Production Summary', ''],
    ['Total Shifts', lotRecords.length],
    ['Raw Used (kg)', lotRecords.reduce((sum, r) => sum + r.rawInputShift, 0)],
    ['Finished (kg)', lotRecords.reduce((sum, r) => sum + r.finishedKg, 0)],
    ['Rejects (kg)', lotRecords.reduce((sum, r) => sum + r.rejectsKg, 0)]
  ];
  const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, summaryWs, 'Lot Summary');
  
  // Production Details Sheet
  const detailsData = [
    ['Date', 'Shift', 'Raw Input (kg)', '18-21 Size (kg)', '21-25 Size (kg)', 'Finished (kg)', 'Rejects (kg)', 'Efficiency (%)', 'Yield (%)'],
    ...lotRecords.map(record => [
      new Date(record.productionDate).toLocaleDateString(),
      record.shift,
      record.rawInputShift,
      record.kg1821,
      record.kg2125,
      record.finishedKg,
      record.rejectsKg,
      record.efficiency,
      record.yield
    ])
  ];
  const detailsWs = XLSX.utils.aoa_to_sheet(detailsData);
  XLSX.utils.book_append_sheet(wb, detailsWs, 'Production Details');
  
  XLSX.writeFile(wb, `lot_report_${selectedLot.lotNumber}_${new Date().toISOString().split('T')[0]}.xlsx`);
}
// Initialize on load
window.addEventListener('load', () => {
  calculateLotTotals();
  updateProductionSummary();
  
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('productionDate').value = today;
  
  // Subscribe to state changes
  window.appState.subscribe('lots', renderLots);
  window.appState.subscribe('productionRecords', renderRecords);
  window.appState.subscribe('currentInventory', renderInventory);
});
</script>

<style>
@media print {
  body * { visibility: hidden; }
  .report-content, .report-content * { visibility: visible; }
  .report-content {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    background: white !important;
  }
  .header, .nav-buttons, .container > *:not(.section), 
  .section:not(#reports), #lotReportPreview button {
    display: none !important;
  }
  @page { margin: 1in; size: A4; }
}
</style>

</body>
</html>
