<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pistachio Production ‚Äì Al Jameel MES</title>
  <style>
    :root {
      --primary: #a32034;
      --accent: #d5a333;
      --text: #2f2a28;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 1.5rem; }
    .back-link { 
      color: white; 
      text-decoration: none; 
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-right: 1rem;
    }

    /* Pistachio icon styling */
    .pistachio-brand-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 0.75rem;
      vertical-align: middle;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    .nav-btn:hover { opacity: 0.9; }
    .nav-btn.active { background: var(--accent); color: var(--text); }

    .section {
      display: none;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section.active { display: block; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      text-align: center;
      border: 2px solid var(--accent);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    input, select {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover { opacity: 0.9; }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--primary);
      color: white;
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
    }

    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .summary-box {
      background: #fff7e6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      border: 1px solid #f5e1a8;
      font-weight: 600;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .materials-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }

    /* Section header with pistachio image */
    .section-header-with-image {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header-with-image img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-right: 1rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <a href="./index.html" style="position: absolute; top: 20px; left: 20px; color: var(--primary); text-decoration: none; z-index: 10;">‚Üê Back to MES</a>
  <div class="login-form">
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <img src="src/assets/icons/pistachio.png" alt="Pistachio" style="width: 64px; height: 64px; margin-bottom: 1rem;" onerror="this.outerHTML='ü•ú'">
      <h2 style="color: var(--primary); margin: 0;">Pistachio Production Login</h2>
    </div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Username</label>
        <input id="loginUsername" type="text" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input id="loginPassword" type="password" required>
      </div>
      <button type="submit" style="width: 100%; margin-top: 1rem;">Login</button>
    </form>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
      <p><strong>Demo Credentials:</strong></p>
      <p>Admin: admin / admin123</p>
      <p>Operator: operator / op123</p>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display: none;">
  <header class="header">
    <div style="display: flex; align-items: center;">
      <a href="./index.html" class="back-link">‚Üê Back to MES</a>
      <img src="src/assets/icons/pistachio.png" alt="Pistachio" class="pistachio-brand-icon" onerror="this.outerHTML='ü•ú '">
      <h1>Pistachio Production Management</h1>
    </div>
    <div>
      <span id="userDisplay">User</span>
      <button onclick="logout()" style="margin-left: 1rem; background: rgba(255,255,255,0.2);">
        Logout
      </button>
    </div>
  </header>

  <div class="container">
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="showSection('production')">New Production</button>
      <button class="nav-btn" onclick="showSection('records')">View Records</button>
      <button class="nav-btn" onclick="showSection('inventory')">Inventory</button>
      <button class="nav-btn" onclick="showSection('maintenance')">Maintenance</button>
    </div>

    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>Production Dashboard</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div>Total Finished (kg)</div>
          <div class="stat-value" id="kpiFinished">0</div>
        </div>
        <div class="stat-card">
          <div>Efficiency (%)</div>
          <div class="stat-value" id="kpiEff">0</div>
        </div>
        <div class="stat-card">
          <div>Reject Rate (%)</div>
          <div class="stat-value" id="kpiReject">0.0</div>
        </div>
      </div>
      <p>KPIs update automatically when you submit production records.</p>
    </section>

    <!-- Production Entry Section -->
    <section id="production" class="section">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>New Production Entry</h2>
      </div>
      
      <div class="warning-box">
        <strong>Note:</strong> Huller Run shows rejects section, Repacking Only hides it.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Run Type</label>
          <select id="runType" onchange="updateFormVisibility()">
            <option value="huller">Huller Run</option>
            <option value="repack">Repacking Only</option>
          </select>
        </div>
        <div class="form-group">
          <label>Brand</label>
          <select id="brand" onchange="updateInventoryDisplay()">
            <option>Golden Hill</option>
            <option>Extra</option>
          </select>
        </div>
        <div class="form-group" id="sizeGroup">
          <label>Size</label>
          <select id="size">
            <option>18-21</option>
            <option>21-25</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lot Number</label>
          <input id="lotNo" type="text" placeholder="e.g., GH-240315-01">
        </div>
        <div class="form-group">
          <label>Raw Input (kg)</label>
          <input id="rawInput" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
      </div>

      <!-- Final Goods -->
      <h3>Final Goods Output</h3>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="form-group">
          <label>18-21 Size (kg)</label>
          <input id="bags1821" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
        <div class="form-group">
          <label>21-25 Size (kg)</label>
          <input id="bags2125" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
      </div>

      <!-- Materials -->
      <div class="materials-section">
        <h3>Materials Usage</h3>
        <div id="inventoryStatus" style="background: #e3f2fd; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem;">
          <strong>Current Stock:</strong> 
          <span id="currentBags">0</span> vacuum bags, 
          <span id="currentGoldenBoxes">0</span> Golden Hill boxes, 
          <span id="currentExtraBoxes">0</span> Extra boxes
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Vacuum Bags Used</label>
            <input id="bagsUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Used</label>
            <input id="boxesUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Vacuum Bags Wasted</label>
            <input id="bagsWasted" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Wasted</label>
            <input id="boxesWasted" type="number" min="0" step="1" value="0">
          </div>
        </div>
      </div>

      <!-- Rejects (shown only for Huller Run) -->
      <div id="rejectsSection" class="materials-section">
        <h3>Rejects (kg) - Huller Run Only</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Non-Split (Closed)</label>
            <input id="rejNonSplit" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Light Stain</label>
            <input id="rejLightStain" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Adhering Hull</label>
            <input id="rejAdheringHull" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Dark Stain</label>
            <input id="rejDarkStain" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Shell & Split</label>
            <input id="rejShellSplit" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Undersize & Kernel</label>
            <input id="rejUndersize" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Loose Shell</label>
            <input id="rejLooseShell" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Loose Kernel</label>
            <input id="rejLooseKernel" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Dust</label>
            <input id="rejDust" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <button onclick="submitProduction()">Submit Production</button>
        <button class="btn-secondary" onclick="clearForm()">Clear Form</button>
      </div>

      <div class="summary-box" id="productionSummary">
        Finished: 0 kg ‚Ä¢ Rejects: 0 kg ‚Ä¢ Efficiency: 0% ‚Ä¢ Reject Rate: 0%
      </div>
    </section>

    <!-- Records Section -->
    <section id="records" class="section">
      <h2 style="margin-bottom: 1rem;">üìã Production Records</h2>
      <div style="overflow-x: auto;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Run Type</th>
              <th>Brand</th>
              <th>Size</th>
              <th>Lot</th>
              <th>Raw Input (kg)</th>
              <th>Final Bags</th>
              <th>Finished (kg)</th>
              <th>Rejects (kg)</th>
              <th>Efficiency (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Maintenance Section -->
    <section id="maintenance" class="section">
      <h2 style="margin-bottom: 1rem;">üîß Equipment Maintenance</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Total Equipment</div>
          <div class="stat-value" id="totalEquipment">65</div>
        </div>
        <div class="stat-card">
          <div>Operational</div>
          <div class="stat-value" id="operationalEquipment" style="color: #22c55e;">0</div>
        </div>
        <div class="stat-card">
          <div>Critical Down (P1-3)</div>
          <div class="stat-value" id="criticalDown" style="color: #ef4444;">0</div>
        </div>
        <div class="stat-card">
          <div>Minor Issues (P5+)</div>
          <div class="stat-value" id="minorIssues" style="color: #f59e0b;">0</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="materials-section" style="margin-bottom: 1rem;">
        <h3>Equipment Filters</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Priority Level</label>
            <select id="priorityFilter" onchange="filterEquipment()">
              <option value="all">All Priorities</option>
              <option value="1">Priority 1 (Critical)</option>
              <option value="3">Priority 3 (High)</option>
              <option value="5">Priority 5 (Medium)</option>
              <option value="7">Priority 7 (Low)</option>
              <option value="8">Priority 8 (Automation)</option>
              <option value="10">Priority 10 (Minimal)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Equipment Type</label>
            <select id="typeFilter" onchange="filterEquipment()">
              <option value="all">All Types</option>
              <option value="conveyor">Conveyors</option>
              <option value="elevator">Elevators</option>
              <option value="sorter">Sorters</option>
              <option value="bin">Bins/Storage</option>
              <option value="processing">Processing</option>
              <option value="automation">Automation</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="statusFilter" onchange="filterEquipment()">
              <option value="all">All Status</option>
              <option value="operational">Operational Only</option>
              <option value="issues">Issues Only</option>
              <option value="down">Down/Broken Only</option>
            </select>
          </div>
         <div class="form-group">
  <label>Sort By</label>
  <select id="sortBy">
    <option value="priority">Priority Level</option>
    <option value="code">Equipment Code</option>
    <option value="status">Status</option>
  </select>
</div>
<div class="form-group">
  <label>&nbsp;</label>
  <button onclick="filterEquipment()" style="width: 100%;">Apply Filters</button>
</div>
        </div>
      </div>

      <h3>Equipment Status (<span id="shownCount">65</span> shown)</h3>
      <div id="equipmentGrid" class="stats-grid" style="margin-bottom: 2rem;">
        <!-- Equipment cards will be populated here -->
      </div>

      <div class="materials-section">
        <h3>Update Equipment Status</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Equipment</label>
            <select id="equipmentSelect">
              <option value="Ton">Ton - Ton bag opener (P1)</option>
              <option value="E1">E1 - Z elevator (P1)</option>
              <option value="E2">E2 - Z elevator (P1)</option>
              <option value="Bin1">Bin1 - Material silo (P1)</option>
              <option value="E3">E3 - Z elevator (P1)</option>
              <option value="C1">C1 - Conveyor (P1)</option>
              <option value="C2">C2 - Conveyor(LR) (P1)</option>
              <option value="C3">C3 - Conveyor(LR) (P1)</option>
              <option value="C4">C4 - Conveyor(LR) (P3)</option>
              <option value="C5">C5 - Conveyor(LR) (P3)</option>
              <option value="C6">C6 - Conveyor(LR) (P3)</option>
              <option value="C7">C7 - Conveyor(LR) (P3)</option>
              <option value="Sor1">Sor1 - Sorter (P3)</option>
              <option value="Sor2">Sor2 - Sorter (P3)</option>
              <option value="Sor3">Sor3 - Sorter (P3)</option>
              <option value="Sor4">Sor4 - Sorter (P3)</option>
              <option value="C8">C8 - Conveyor (P1)</option>
              <option value="C9">C9 - Conveyor (P1)</option>
              <option value="C10">C10 - Conveyor (P5)</option>
              <option value="C11">C11 - Conveyor (P5)</option>
              <option value="C12">C12 - Conveyor (P5)</option>
              <option value="C13">C13 - Conveyor (P5)</option>
              <option value="C14">C14 - Conveyor (P5)</option>
              <option value="C15">C15 - Conveyor (P5)</option>
              <option value="C16">C16 - Conveyor (P5)</option>
              <option value="C17">C17 - Conveyor (P5)</option>
              <option value="C18">C18 - Conveyor (P5)</option>
              <option value="C19">C19 - Conveyor (P5)</option>
              <option value="C20">C20 - Conveyor (P5)</option>
              <option value="C21">C21 - Conveyor (P5)</option>
              <option value="C22">C22 - Conveyor (P5)</option>
              <option value="C23">C23 - Conveyor (P5)</option>
              <option value="Bin2">Bin2 - Product bin (P7)</option>
              <option value="Bin3">Bin3 - By product bin (P7)</option>
              <option value="Bin4">Bin4 - By product bin (P7)</option>
              <option value="Bin5">Bin5 - By product bin (P7)</option>
              <option value="Bin6">Bin6 - By product bin (P7)</option>
              <option value="Bin7">Bin7 - By product bin (P7)</option>
              <option value="Bin8">Bin8 - By product bin (P7)</option>
              <option value="Bin9">Bin9 - By product bin (P7)</option>
              <option value="C24">C24 - Conveyor (P5)</option>
              <option value="C25">C25 - Conveyor (P5)</option>
              <option value="C26">C26 - Conveyor (P5)</option>
              <option value="C27">C27 - Conveyor (P5)</option>
              <option value="C28">C28 - Conveyor (P5)</option>
              <option value="C29">C29 - Conveyor (P5)</option>
              <option value="E4">E4 - Z elevator (P1)</option>
              <option value="E5">E5 - Z elevator (P7)</option>
              <option value="E6">E6 - Z elevator (P3)</option>
              <option value="E7">E7 - Z elevator (P3)</option>
              <option value="Bin10">Bin10 - Sizing bin (P10)</option>
              <option value="Bin11">Bin11 - Sizing bin (P5)</option>
              <option value="Bin12">Bin12 - Sizing bin (P5)</option>
              <option value="C30">C30 - Conveyor (P7)</option>
              <option value="C31">C31 - Conveyor (P7)</option>
              <option value="E8">E8 - Z elevator (P3)</option>
              <option value="E9">E9 - Z elevator (P3)</option>
              <option value="E10">E10 - Z elevator (P10)</option>
              <option value="Pac-1">Pac-1 - Packing and stacking unit (P3)</option>
              <option value="Pac-2">Pac-2 - Packing and stacking unit (P3)</option>
              <option value="Wra">Wra - Frame wrapper (P5)</option>
              <option value="PRE-CL">PRE-CL - Pre-Cleaner (P1)</option>
              <option value="AGV-1">AGV-1 - AVG Robot (P8)</option>
              <option value="AGV-2">AGV-2 - AVG Robot (P8)</option>
              <option value="SIZE">SIZE - Sizer Machine (P3)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="equipmentStatus">
              <option value="operational" style="color: #22c55e;">Operational</option>
              <option value="maintenance" style="color: #f59e0b;">Maintenance Due</option>
              <option value="attention" style="color: #f97316;">Needs Attention</option>
              <option value="down" style="color: #ef4444;">Down/Broken</option>
              <option value="offline" style="color: #6b7280;">Offline</option>
            </select>
          </div>
          <div class="form-group">
            <label>Problem Description</label>
            <input id="problemDescription" type="text" placeholder="Describe the issue or maintenance needed">
          </div>
          <div class="form-group">
            <label>Maintenance Cost ($)</label>
            <input id="maintenanceCost" type="number" min="0" step="0.01" value="0">
          </div>
        </div>
        <button onclick="updateEquipmentStatus()">Update Status</button>
      </div>

      <h3>Maintenance Log</h3>
      <div class="materials-section" style="margin-bottom: 1rem;">
  <h4>Export Maintenance Cost Report</h4>
  <div class="form-grid">
    <div class="form-group">
      <label>From Date</label>
      <input id="exportFromDate" type="date">
    </div>
    <div class="form-group">
      <label>To Date</label>
      <input id="exportToDate" type="date">
    </div>
    <div class="form-group">
      <label>&nbsp;</label>
      <button onclick="exportMaintenanceReport()" style="width: 100%;">Export Cost Report</button>
    </div>
  </div>
</div>
      <div style="overflow-x: auto;">
        <table id="maintenanceTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Equipment</th>
              <th>Priority</th>
              <th>Status Change</th>
              <th>Problem</th>
              <th>Cost ($)</th>
              <th>Downtime (hrs)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Inventory Section -->
    <section id="inventory" class="section">
      <h2 style="margin-bottom: 1rem;">üì¶ Inventory Management</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Vacuum Bags (10kg)</div>
          <div class="stat-value" id="invVacuumBags">0</div>
        </div>
        <div class="stat-card">
          <div>Golden Hill Boxes</div>
          <div class="stat-value" id="invGoldenHillBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Extra Boxes</div>
          <div class="stat-value" id="invExtraBoxes">0</div>
        </div>
      </div>

      <div class="materials-section">
        <h3>Stock Adjustment</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Item</label>
            <select id="invItem">
              <option value="vacuumBags">Vacuum Bags (10kg)</option>
              <option value="goldenHillBoxes">Golden Hill Boxes</option>
              <option value="extraBoxes">Extra Boxes</option>
            </select>
          </div>
          <div class="form-group">
            <label>Action</label>
            <select id="invAction">
              <option value="add">Add Stock</option>
              <option value="remove">Remove Stock</option>
              <option value="set">Set Exact Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input id="invQuantity" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input id="invNotes" type="text" placeholder="Reason for adjustment">
          </div>
        </div>
        <button onclick="adjustInventory()">Update Inventory</button>
      </div>

      <h3>Stock Movement Log</h3>
      <div style="overflow-x: auto;">
        <table id="inventoryTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Item</th>
              <th>Action</th>
              <th>Quantity</th>
              <th>Result</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
</div>
<script>
// ===== STATE MANAGEMENT =====
class AppState {
  constructor() {
    this.data = {
      productionRecords: [],
      inventoryLog: [],
      maintenanceLog: [],
      currentInventory: {
        vacuumBags: 0,
        goldenHillBoxes: 0,
        extraBoxes: 0
      },
      equipment: [], // Will be populated below
      currentUser: null
    };
    this.listeners = {};
    this.loadFromStorage();
  }

  subscribe(key, callback) {
    if (!this.listeners[key]) {
      this.listeners[key] = [];
    }
    this.listeners[key].push(callback);
  }

  setState(key, value) {
    this.data[key] = value;
    this.saveToStorage();
    this.notify(key, value);
  }

  getState(key) {
    return this.data[key];
  }

  notify(key, value) {
    if (this.listeners[key]) {
      this.listeners[key].forEach(callback => callback(value));
    }
  }

  addToArray(key, item) {
    if (Array.isArray(this.data[key])) {
      this.data[key].push(item);
      this.saveToStorage();
      this.notify(key, this.data[key]);
    }
  }

  updateInventory(item, action, quantity) {
    const current = this.data.currentInventory[item] || 0;
    let newValue;

    switch(action) {
      case 'add':
        newValue = current + quantity;
        break;
      case 'remove':
        newValue = Math.max(0, current - quantity);
        break;
      case 'set':
        newValue = Math.max(0, quantity);
        break;
      default:
        return false;
    }

    this.data.currentInventory[item] = newValue;
    this.saveToStorage();
    this.notify('currentInventory', this.data.currentInventory);
    return true;
  }

  saveToStorage() {
    try {
      localStorage.setItem('pistachio_mes_data', JSON.stringify(this.data));
    } catch (e) {
      console.warn('Could not save to localStorage:', e);
    }
  }

  loadFromStorage() {
    try {
      const saved = localStorage.getItem('pistachio_mes_data');
      if (saved) {
        const parsed = JSON.parse(saved);
        this.data = { ...this.data, ...parsed };
      }
    } catch (e) {
      console.warn('Could not load from localStorage:', e);
    }
  }
}

// ===== VALIDATION SYSTEM =====
class FormValidator {
  constructor() {
    this.rules = {};
    this.setupStyles();
  }

  setupStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .form-field-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
      }
      .form-field-success {
        border-color: #22c55e !important;
      }
      .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
      }
      .form-group.has-error label {
        color: #ef4444;
      }
      .success-toast, .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 1001;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }
      .success-toast {
        background: #22c55e;
      }
      .error-toast {
        background: #ef4444;
      }
      .success-toast.show, .error-toast.show {
        transform: translateX(0);
      }
    `;
    document.head.appendChild(style);
  }

  addRule(fieldId, validator, message) {
    if (!this.rules[fieldId]) {
      this.rules[fieldId] = [];
    }
    this.rules[fieldId].push({ validator, message });
  }

  validateField(fieldId) {
    const field = document.getElementById(fieldId);
    const rules = this.rules[fieldId];
    
    if (!field || !rules) return true;

    this.clearFieldError(fieldId);
    
    for (const rule of rules) {
      if (!rule.validator(field.value, field)) {
        this.showFieldError(fieldId, rule.message);
        return false;
      }
    }
    
    this.showFieldSuccess(fieldId);
    return true;
  }

  validateForm() {
    let isValid = true;
    const fieldIds = Object.keys(this.rules);
    
    fieldIds.forEach(fieldId => {
      if (!this.validateField(fieldId)) {
        isValid = false;
      }
    });
    
    return isValid;
  }

  showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const formGroup = field.closest('.form-group');
    
    field.classList.add('form-field-error');
    field.classList.remove('form-field-success');
    formGroup.classList.add('has-error');
    
    const errorMsg = document.createElement('span');
    errorMsg.className = 'error-message';
    errorMsg.textContent = message;
    formGroup.appendChild(errorMsg);
  }

  showFieldSuccess(fieldId) {
    const field = document.getElementById(fieldId);
    const formGroup = field.closest('.form-group');
    
    field.classList.remove('form-field-error');
    field.classList.add('form-field-success');
    formGroup.classList.remove('has-error');
  }

  clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    const formGroup = field.closest('.form-group');
    
    field.classList.remove('form-field-error', 'form-field-success');
    formGroup.classList.remove('has-error');
    
    const errorMsg = formGroup.querySelector('.error-message');
    if (errorMsg) {
      errorMsg.remove();
    }
  }

  showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `${type}-toast`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
}

// ===== VALIDATION RULES =====
const ValidationRules = {
  required: (value) => value.trim() !== '',
  positiveNumber: (value) => !isNaN(value) && parseFloat(value) >= 0,
  range: (min, max) => (value) => {
    const num = parseFloat(value);
    return !isNaN(num) && num >= min && num <= max;
  },
  lotNumberFormat: (value) => {
    return /^[A-Z]{2}-\d{6}-\d{2}$/.test(value);
  }
};

// ===== INITIALIZE GLOBAL OBJECTS =====
window.appState = new AppState();
window.formValidator = new FormValidator();

// ===== ORIGINAL DATA WITH STATE INTEGRATION =====
// Equipment data
const equipmentData = [
  {code: "Ton", name: "Ton bag opener", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E1", name: "Z elevator", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E2", name: "Z elevator", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin1", name: "Material silo", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E3", name: "Z elevator", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C1", name: "Conveyor", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C2", name: "Conveyor(LR)", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C3", name: "Conveyor(LR)", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C4", name: "Conveyor(LR)", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C5", name: "Conveyor(LR)", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C6", name: "Conveyor(LR)", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C7", name: "Conveyor(LR)", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Sor1", name: "Sorter", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Sor2", name: "Sorter", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Sor3", name: "Sorter", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Sor4", name: "Sorter", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C8", name: "Conveyor", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C9", name: "Conveyor", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C10", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C11", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C12", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C13", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C14", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C15", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C16", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C17", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C18", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C19", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C20", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C21", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C22", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C23", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin2", name: "Product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin3", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin4", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin5", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin6", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin7", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin8", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin9", name: "By product bin", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C24", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C25", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C26", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C27", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C28", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C29", name: "Conveyor", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E4", name: "Z elevator", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E5", name: "Z elevator", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E6", name: "Z elevator", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E7", name: "Z elevator", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin10", name: "Sizing bin", priority: 10, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin11", name: "Sizing bin", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Bin12", name: "Sizing bin", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C30", name: "Conveyor", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "C31", name: "Conveyor", priority: 7, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E8", name: "Z elevator", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E9", name: "Z elevator", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "E10", name: "Z elevator", priority: 10, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Pac-1", name: "Packing and stacking unit", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Pac-2", name: "Packing and stacking unit", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "Wra", name: "Frame wrapper", priority: 5, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "PRE-CL", name: "Pre-Cleaner", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "AGV-1", name: "AVG Robot", priority: 8, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "AGV-2", name: "AVG Robot", priority: 8, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "SIZE", name: "Sizer Machine", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0}
];

// Initialize equipment data in state
window.appState.setState('equipment', equipmentData);

// User management
const users = { admin: 'admin123', operator: 'op123' };

// ===== UPDATED FUNCTIONS WITH VALIDATION =====
function setupProductionValidation() {
  const validator = window.formValidator;
  
  validator.addRule('rawInput', ValidationRules.positiveNumber, 'Raw input must be a positive number');
  validator.addRule('rawInput', ValidationRules.range(0, 10000), 'Raw input must be between 0-10,000 kg');
  validator.addRule('bags1821', ValidationRules.positiveNumber, '18-21 size must be a positive number');
  validator.addRule('bags2125', ValidationRules.positiveNumber, '21-25 size must be a positive number');
  validator.addRule('lotNo', ValidationRules.required, 'Lot number is required');
  validator.addRule('lotNo', ValidationRules.lotNumberFormat, 'Lot format should be XX-YYMMDD-NN (e.g., GH-240315-01)');
  validator.addRule('bagsUsed', ValidationRules.positiveNumber, 'Bags used must be a positive number');
}

// ===== MODIFIED ORIGINAL FUNCTIONS =====

// Login handling
function handleLogin(event) {
  event.preventDefault();
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  
  if (users[username] && users[username] === password) {
    window.appState.setState('currentUser', username);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userDisplay').textContent = username;
    updateDashboard();
    renderRecords();
    renderInventory();
    renderEquipmentGrid();
  } else {
    window.formValidator.showToast('Invalid credentials', 'error');
  }
}

function logout() {
  window.appState.setState('currentUser', null);
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

// Navigation
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.getElementById(sectionId).classList.add('active');
  event.target.classList.add('active');
}

// Form handling
function updateFormVisibility() {
  const runType = document.getElementById('runType').value;
  const sizeGroup = document.getElementById('sizeGroup');
  const rejectsSection = document.getElementById('rejectsSection');
  
  if (runType === 'huller') {
    sizeGroup.style.display = 'none';
    rejectsSection.style.display = 'block';
  } else {
    sizeGroup.style.display = 'block';
    rejectsSection.style.display = 'none';
  }
  updateSummary();
}

function updateInventoryDisplay() {
  renderInventory();
}

function updateSummary() {
  const kg1821 = parseInt(document.getElementById('bags1821').value) || 0;
  const kg2125 = parseInt(document.getElementById('bags2125').value) || 0;
  const finishedKg = kg1821 + kg2125;
  
  const runType = document.getElementById('runType').value;
  let rejectsKg = 0;
  
  if (runType === 'huller') {
    const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                      'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
    rejectsKg = rejectIds.reduce((sum, id) => {
      return sum + (parseInt(document.getElementById(id).value) || 0);
    }, 0);
  }
  
  const rawInput = parseInt(document.getElementById('rawInput').value) || 0;
  const totalInput = rawInput > 0 ? rawInput : finishedKg + rejectsKg;
  
  const efficiency = totalInput > 0 ? Math.round((finishedKg / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((rejectsKg / totalInput) * 1000) / 10 : 0;
  
  document.getElementById('productionSummary').textContent = 
    `Finished: ${finishedKg} kg ‚Ä¢ Rejects: ${rejectsKg} kg ‚Ä¢ Efficiency: ${efficiency}% ‚Ä¢ Reject Rate: ${rejectRate}%`;
}

function clearForm() {
  document.querySelectorAll('#production input[type="number"]').forEach(input => {
    input.value = 0;
  });
  document.getElementById('lotNo').value = '';
  updateSummary();
}

function submitProduction() {
  // Validate form first
  if (!window.formValidator.validateForm()) {
    window.formValidator.showToast('Please fix the errors before submitting', 'error');
    return;
  }

  const bags1821 = parseInt(document.getElementById('bags1821').value) || 0;
  const bags2125 = parseInt(document.getElementById('bags2125').value) || 0;
  const totalBags = bags1821 + bags2125;
  
  if (totalBags === 0) {
    window.formValidator.showToast('Please enter finished goods quantities', 'error');
    return;
  }
  
  const brand = document.getElementById('brand').value;
  const boxType = brand === 'Golden Hill' ? 'goldenHillBoxes' : 'extraBoxes';
  
  const bagsUsed = parseInt(document.getElementById('bagsUsed').value) || 0;
  const boxesUsed = parseInt(document.getElementById('boxesUsed').value) || 0;
  const bagsWasted = parseInt(document.getElementById('bagsWasted').value) || 0;
  const boxesWasted = parseInt(document.getElementById('boxesWasted').value) || 0;
  
  const totalBagsNeeded = bagsUsed + bagsWasted;
  const totalBoxesNeeded = boxesUsed + boxesWasted;
  
  const currentInventory = window.appState.getState('currentInventory');
  
  if (totalBagsNeeded > currentInventory.vacuumBags) {
    window.formValidator.showToast(`Insufficient vacuum bags! Required: ${totalBagsNeeded}, Available: ${currentInventory.vacuumBags}`, 'error');
    return;
  }
  
  if (totalBoxesNeeded > currentInventory[boxType]) {
    const boxTypeName = brand === 'Golden Hill' ? 'Golden Hill boxes' : 'Extra boxes';
    window.formValidator.showToast(`Insufficient ${boxTypeName}! Required: ${totalBoxesNeeded}, Available: ${currentInventory[boxType]}`, 'error');
    return;
  }
  
  const runType = document.getElementById('runType').value;
  const finishedKg = totalBags;
  
  let rejectsKg = 0;
  if (runType === 'huller') {
    const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                      'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
    rejectsKg = rejectIds.reduce((sum, id) => {
      return sum + (parseInt(document.getElementById(id).value) || 0);
    }, 0);
  }
  
  const rawInput = parseInt(document.getElementById('rawInput').value) || 0;
  const totalInput = rawInput > 0 ? rawInput : finishedKg + rejectsKg;
  const efficiency = totalInput > 0 ? Math.round((finishedKg / totalInput) * 100) : 0;
  
  const record = {
    timestamp: new Date().toISOString(),
    runType,
    brand: brand,
    size: document.getElementById('size').value,
    lot: document.getElementById('lotNo').value,
    rawInput,
    kg1821: bags1821,
    kg2125: bags2125,
    totalKg: totalBags,
    finishedKg,
    rejectsKg,
    efficiency,
    materials: {
      bagsUsed: bagsUsed,
      boxesUsed: boxesUsed,
      bagsWasted: bagsWasted,
      boxesWasted: boxesWasted
    }
  };
  
  // Add to state instead of local array
  window.appState.addToArray('productionRecords', record);
  
  // Update inventory using state methods
  window.appState.updateInventory('vacuumBags', 'remove', totalBagsNeeded);
  window.appState.updateInventory(boxType, 'remove', totalBoxesNeeded);
  
  // Add inventory log entries
  if (totalBagsNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: 'Vacuum Bags (10kg)',
      action: 'remove',
      quantity: totalBagsNeeded,
      result: window.appState.getState('currentInventory').vacuumBags,
      notes: 'Auto: Production submission'
    });
  }
  
  if (totalBoxesNeeded > 0) {
    const boxTypeName = brand === 'Golden Hill' ? 'Golden Hill Boxes' : 'Extra Boxes';
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: boxTypeName,
      action: 'remove',
      quantity: totalBoxesNeeded,
      result: window.appState.getState('currentInventory')[boxType],
      notes: 'Auto: Production submission'
    });
  }
  
  window.formValidator.showToast('Production record submitted successfully!', 'success');
  clearForm();
  updateDashboard();
  renderRecords();
  renderInventory();
}

// Dashboard updates
function updateDashboard() {
  const productionRecords = window.appState.getState('productionRecords') || [];
  let totalFinished = 0;
  let totalRejects = 0;
  let totalInput = 0;
  
  productionRecords.forEach(record => {
    totalFinished += record.finishedKg;
    totalRejects += record.rejectsKg;
    totalInput += record.rawInput || (record.finishedKg + record.rejectsKg);
  });
  
  const efficiency = totalInput > 0 ? Math.round((totalFinished / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((totalRejects / totalInput) * 1000) / 10 : 0;
  
  document.getElementById('kpiFinished').textContent = totalFinished;
  document.getElementById('kpiEff').textContent = efficiency;
  document.getElementById('kpiReject').textContent = rejectRate.toFixed(1);
}

// Records rendering
function renderRecords() {
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  
  const productionRecords = window.appState.getState('productionRecords') || [];
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(record.timestamp).toLocaleString()}</td>
      <td>${record.runType}</td>
      <td>${record.brand}</td>
      <td>${record.size}</td>
      <td>${record.lot}</td>
      <td>${record.rawInput}</td>
      <td>${record.totalKg || record.totalBags}</td>
      <td>${record.finishedKg}</td>
      <td>${record.rejectsKg}</td>
      <td>${record.efficiency}%</td>
    `;
    tbody.appendChild(row);
  });
}

// Inventory management
function adjustInventory() {
  const item = document.getElementById('invItem').value;
  const action = document.getElementById('invAction').value;
  const quantity = parseInt(document.getElementById('invQuantity').value) || 0;
  const notes = document.getElementById('invNotes').value;
  
  if (quantity <= 0 && action !== 'set') {
    window.formValidator.showToast('Please enter a valid quantity', 'error');
    return;
  }
  
  let itemName;
  if (item === 'vacuumBags') itemName = 'Vacuum Bags (10kg)';
  else if (item === 'goldenHillBoxes') itemName = 'Golden Hill Boxes';
  else if (item === 'extraBoxes') itemName = 'Extra Boxes';
  
  const success = window.appState.updateInventory(item, action, quantity);
  
  if (success) {
    const result = window.appState.getState('currentInventory')[item];
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: itemName,
      action,
      quantity,
      result,
      notes
    });
    
    document.getElementById('invQuantity').value = 0;
    document.getElementById('invNotes').value = '';
    window.formValidator.showToast('Inventory updated successfully', 'success');
  } else {
    window.formValidator.showToast('Failed to update inventory', 'error');
  }
  
  renderInventory();
}

function renderInventory() {
  const currentInventory = window.appState.getState('currentInventory') || {};
  document.getElementById('invVacuumBags').textContent = currentInventory.vacuumBags || 0;
  document.getElementById('invGoldenHillBoxes').textContent = currentInventory.goldenHillBoxes || 0;
  document.getElementById('invExtraBoxes').textContent = currentInventory.extraBoxes || 0;
  
  if (document.getElementById('currentBags')) {
    document.getElementById('currentBags').textContent = currentInventory.vacuumBags || 0;
    document.getElementById('currentGoldenBoxes').textContent = currentInventory.goldenHillBoxes || 0;
    document.getElementById('currentExtraBoxes').textContent = currentInventory.extraBoxes || 0;
  }
  
  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML = '';
  
  const inventoryLog = window.appState.getState('inventoryLog') || [];
  inventoryLog.slice().reverse().forEach(log => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(log.timestamp).toLocaleString()}</td>
      <td>${log.item}</td>
      <td>${log.action}</td>
      <td>${log.quantity}</td>
      <td>${log.result}</td>
      <td>${log.notes}</td>
    `;
    tbody.appendChild(row);
  });
}

// Equipment & Maintenance management (keeping your original functions but using state)
function updateEquipmentStatus() {
  const equipmentCode = document.getElementById('equipmentSelect').value;
  const newStatus = document.getElementById('equipmentStatus').value;
  const problem = document.getElementById('problemDescription').value;
  const cost = parseFloat(document.getElementById('maintenanceCost').value) || 0;
  
  const equipment = window.appState.getState('equipment');
  const equipmentItem = equipment.find(e => e.code === equipmentCode);
  if (!equipmentItem) return;
  
  const oldStatus = equipmentItem.status;
  
  let downtimeHours = 0;
  if (oldStatus !== 'operational' && newStatus === 'operational') {
    const downStart = new Date(equipmentItem.lastUpdate);
    const now = new Date();
    downtimeHours = Math.round((now - downStart) / (1000 * 60 * 60) * 10) / 10;
  }
  
  equipmentItem.status = newStatus;
  equipmentItem.problem = problem;
  equipmentItem.lastUpdate = new Date().toISOString();
  if (newStatus === 'operational') {
    equipmentItem.downtime = 0;
  }
  
  window.appState.setState('equipment', equipment);
  
  window.appState.addToArray('maintenanceLog', {
    timestamp: new Date().toISOString(),
    equipment: `${equipmentCode} - ${equipmentItem.name}`,
    priority: equipmentItem.priority,
    statusChange: `${oldStatus} ‚Üí ${newStatus}`,
    problem: problem || 'Status update',
    cost: cost,
    downtime: downtimeHours
  });
  
  document.getElementById('problemDescription').value = '';
  document.getElementById('maintenanceCost').value = 0;
  
  window.formValidator.showToast('Equipment status updated successfully!', 'success');
  renderEquipmentGrid();
  renderMaintenanceLog();
}

function filterEquipment() {
  const priorityFilter = document.getElementById('priorityFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  const sortBy = document.getElementById('sortBy').value;
  
  const equipment = window.appState.getState('equipment');
  let filteredEquipment = [...equipment];
  
  if (priorityFilter !== 'all') {
    filteredEquipment = filteredEquipment.filter(eq => eq.priority == priorityFilter);
  }
  
  if (typeFilter !== 'all') {
    filteredEquipment = filteredEquipment.filter(eq => {
      switch(typeFilter) {
        case 'conveyor': return eq.code.startsWith('C');
        case 'elevator': return eq.code.startsWith('E');
        case 'sorter': return eq.code.startsWith('Sor');
        case 'bin': return eq.code.startsWith('Bin');
        case 'processing': return ['SIZE', 'PRE-CL', 'Wra', 'Ton'].includes(eq.code);
        case 'automation': return eq.code.startsWith('AGV');
        default: return true;
      }
    });
  }
  
  if (statusFilter !== 'all') {
    if (statusFilter === 'operational') {
      filteredEquipment = filteredEquipment.filter(eq => eq.status === 'operational');
    } else if (statusFilter === 'issues') {
      filteredEquipment = filteredEquipment.filter(eq => ['maintenance', 'attention'].includes(eq.status));
    } else if (statusFilter === 'down') {
      filteredEquipment = filteredEquipment.filter(eq => ['down', 'offline'].includes(eq.status));
    }
  }
  
  filteredEquipment.sort((a, b) => {
    switch(sortBy) {
      case 'priority': return a.priority - b.priority;
      case 'code': return a.code.localeCompare(b.code);
      case 'status': 
        const statusOrder = {operational: 0, maintenance: 1, attention: 2, down: 3, offline: 4};
        return statusOrder[a.status] - statusOrder[b.status];
      default: return 0;
    }
  });
  
  renderFilteredEquipment(filteredEquipment);
}

function renderFilteredEquipment(filteredList) {
  const grid = document.getElementById('equipmentGrid');
  
  const equipmentCards = filteredList.map(eq => {
    const statusColors = {
      operational: '#22c55e',
      maintenance: '#f59e0b', 
      attention: '#f97316',
      down: '#ef4444',
      offline: '#6b7280'
    };
    
    const statusLabels = {
      operational: 'Operational',
      maintenance: 'Maintenance Due',
      attention: 'Needs Attention', 
      down: 'Down/Broken',
      offline: 'Offline'
    };
    
    return `
      <div class="stat-card" style="border-left: 5px solid ${statusColors[eq.status]};">
        <div style="font-weight: bold; font-size: 1.1rem;">${eq.code}</div>
        <div style="margin: 0.5rem 0; color: ${statusColors[eq.status]}; font-weight: 600;">
          ${statusLabels[eq.status]}
        </div>
        <div style="font-size: 0.9rem; color: #666;">
          ${eq.name}
        </div>
        <div style="font-size: 0.8rem; color: #666;">Priority ${eq.priority}</div>
        ${eq.problem ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">${eq.problem}</div>` : ''}
      </div>
    `;
  }).join('');
  
  grid.innerHTML = equipmentCards;
  document.getElementById('shownCount').textContent = filteredList.length;
}

function renderEquipmentGrid() {
  const equipment = window.appState.getState('equipment');
  const grid = document.getElementById('equipmentGrid');
  
  const equipmentCards = equipment.map(eq => {
    const statusColors = {
      operational: '#22c55e',
      maintenance: '#f59e0b', 
      attention: '#f97316',
      down: '#ef4444',
      offline: '#6b7280'
    };
    
    const statusLabels = {
      operational: 'Operational',
      maintenance: 'Maintenance Due',
      attention: 'Needs Attention', 
      down: 'Down/Broken',
      offline: 'Offline'
    };
    
    return `
      <div class="stat-card" style="border-left: 5px solid ${statusColors[eq.status]};">
        <div style="font-weight: bold; font-size: 1.1rem;">${eq.code}</div>
        <div style="margin: 0.5rem 0; color: ${statusColors[eq.status]}; font-weight: 600;">
          ${statusLabels[eq.status]}
        </div>
        <div style="font-size: 0.9rem; color: #666;">
          ${eq.name}
        </div>
        ${eq.problem ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">${eq.problem}</div>` : ''}
      </div>
    `;
  }).join('');
  
  grid.innerHTML = equipmentCards;
  
  const operational = equipment.filter(e => e.status === 'operational').length;
  const criticalDown = equipment.filter(e => e.priority <= 3 && e.status !== 'operational').length;
  const minorIssues = equipment.filter(e => e.priority >= 5 && e.status !== 'operational').length;
  
  document.getElementById('operationalEquipment').textContent = operational;
  document.getElementById('criticalDown').textContent = criticalDown;
  document.getElementById('minorIssues').textContent = minorIssues;
}

function renderMaintenanceLog() {
  const tbody = document.querySelector('#maintenanceTable tbody');
  tbody.innerHTML = '';
  
  const maintenanceLog = window.appState.getState('maintenanceLog') || [];
  maintenanceLog.slice().reverse().forEach(log => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(log.timestamp).toLocaleString()}</td>
      <td>${log.equipment}</td>
      <td style="color: ${log.priority <= 3 ? '#ef4444' : '#22c55e'}; font-weight: bold;">P${log.priority || 'N/A'}</td>
      <td>${log.statusChange}</td>
      <td>${log.problem}</td>
      <td>${log.cost > 0 ? '$' + log.cost.toFixed(2) : '-'}</td>
      <td>${log.downtime > 0 ? log.downtime : '-'}</td>
    `;
    tbody.appendChild(row);
  });
}

function exportMaintenanceReport() {
  const fromDate = document.getElementById('exportFromDate').value;
  const toDate = document.getElementById('exportToDate').value;
  
  if (!fromDate || !toDate) {
    window.formValidator.showToast('Please select both From and To dates', 'error');
    return;
  }
  
  const maintenanceLog = window.appState.getState('maintenanceLog') || [];
  const filtered = maintenanceLog.filter(log => {
    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
    return logDate >= fromDate && logDate <= toDate;
  });
  
  if (filtered.length === 0) {
    window.formValidator.showToast('No maintenance records found in the selected date range', 'error');
    return;
  }
  
  const equipmentCosts = {};
  filtered.forEach(log => {
    const equipment = log.equipment;
    if (!equipmentCosts[equipment]) {
      equipmentCosts[equipment] = {
        totalCost: 0,
        activities: [],
        priority: log.priority || 'N/A'
      };
    }
    equipmentCosts[equipment].totalCost += log.cost || 0;
    if (log.cost > 0) {
      equipmentCosts[equipment].activities.push({
        date: new Date(log.timestamp).toLocaleDateString(),
        cost: log.cost,
        problem: log.problem
      });
    }
  });
  
  let reportHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Maintenance Cost Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .summary { margin-bottom: 20px; padding: 15px; background: #f5f5f5; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #a32034; color: white; }
        .equipment-section { margin-bottom: 25px; }
        .equipment-title { font-weight: bold; font-size: 1.1em; color: #a32034; }
        .total-cost { font-weight: bold; color: #a32034; }
        @media print { body { margin: 0; } }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Al Jameel MES - Maintenance Cost Report</h1>
        <h3>Pistachio Production Line</h3>
        <p>Report Period: ${new Date(fromDate).toLocaleDateString()} to ${new Date(toDate).toLocaleDateString()}</p>
        <p>Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
      </div>
  `;
  
  const grandTotal = Object.values(equipmentCosts).reduce((sum, eq) => sum + eq.totalCost, 0);
  
  reportHTML += `
    <div class="summary">
      <h3>Summary</h3>
      <p><strong>Total Equipment with Maintenance:</strong> ${Object.keys(equipmentCosts).length}</p>
      <p><strong>Total Maintenance Cost:</strong> $${grandTotal.toFixed(2)}</p>
      <p><strong>Total Activities:</strong> ${filtered.filter(log => log.cost > 0).length}</p>
    </div>
  `;
  
  reportHTML += `<h3>Equipment Breakdown</h3>`;
  
  const sortedEquipment = Object.entries(equipmentCosts).sort((a, b) => b[1].totalCost - a[1].totalCost);
  
  sortedEquipment.forEach(([equipment, data]) => {
    if (data.totalCost > 0) {
      reportHTML += `
        <div class="equipment-section">
          <div class="equipment-title">${equipment} (Priority ${data.priority})</div>
          <div class="total-cost">Total Cost: $${data.totalCost.toFixed(2)}</div>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Cost</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.activities.forEach(activity => {
        reportHTML += `
          <tr>
            <td>${activity.date}</td>
            <td>$${activity.cost.toFixed(2)}</td>
            <td>${activity.problem}</td>
          </tr>
        `;
      });
      
      reportHTML += `
            </tbody>
          </table>
        </div>
      `;
    }
  });
  
  reportHTML += `
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(reportHTML);
  printWindow.document.close();
  printWindow.focus();
  
  setTimeout(() => {
    printWindow.print();
  }, 250);
}

// Initialize
window.addEventListener('load', () => {
  setupProductionValidation();
  updateFormVisibility();
  updateSummary();
  renderInventory();
  renderEquipmentGrid();
  renderMaintenanceLog();
  
  const today = new Date();
  const monthAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  document.getElementById('exportToDate').value = today.toISOString().split('T')[0];
  document.getElementById('exportFromDate').value = monthAgo.toISOString().split('T')[0];
});
</script>

</body>
</html>
