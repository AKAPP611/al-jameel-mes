<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pistachio Production ‚Äì Al Jameel MES</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #a32034;
      --accent: #d5a333;
      --text: #2f2a28;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 { font-size: 1.5rem; }
    
    .back-link { 
      color: white; 
      text-decoration: none; 
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-right: 1rem;
      transition: background 0.2s;
    }
    
    .back-link:hover { background: rgba(255,255,255,0.2); }

    .pistachio-brand-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 0.75rem;
      vertical-align: middle;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .nav-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(163, 32, 52, 0.3); }
    .nav-btn.active { background: var(--accent); color: var(--text); }

    .section {
      display: none;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section.active { display: block; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      text-align: center;
      border: 2px solid var(--accent);
      transition: transform 0.2s;
    }

    .stat-card:hover { transform: translateY(-2px); }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    input, select {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(163, 32, 52, 0.1);
    }

    input:invalid {
      border-color: var(--error);
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    button:hover { 
      background: color-mix(in srgb, var(--primary) 90%, black);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: color-mix(in srgb, var(--border) 80%, black);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background: rgba(163, 32, 52, 0.05);
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--accent));
    }

    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }

    .summary-box {
      background: #fff7e6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      border: 1px solid #f5e1a8;
      font-weight: 600;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .error-box {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .success-box {
      background: #efe;
      border: 1px solid #cfc;
      color: #363;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .materials-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      border-left: 4px solid var(--accent);
    }

    .section-header-with-image {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header-with-image img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-right: 1rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .lot-status {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .lot-status.open {
      background: #d1fae5;
      color: #065f46;
    }

    .lot-status.completed {
      background: #f3f4f6;
      color: #374151;
    }

    .progress-bar {
      background: #e5e7eb;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.5rem 0;
      position: relative;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      min-width: fit-content;
    }

    .shift-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .shift-badge.day {
      background: #fef3c7;
      color: #92400e;
    }

    .shift-badge.night {
      background: #e0e7ff;
      color: #3730a3;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .checkbox-container {
      max-height: 200px; 
      overflow-y: auto; 
      border: 1px solid var(--border); 
      border-radius: 0.5rem; 
      padding: 0.5rem;
      background: white;
    }

    .checkbox-item {
      padding: 0.5rem; 
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-item:last-child {
      border-bottom: none;
    }

    .checkbox-item label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0;
    }

    .report-content {
      background: white;
      border-radius: 0.5rem;
    }

    @media print {
      body * { visibility: hidden; }
      .report-content, .report-content * { visibility: visible; }
      .report-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white !important;
      }
      .header, .nav-buttons, .container > *:not(.section), 
      .section:not(#reports), #lotReportPreview button {
        display: none !important;
      }
      @page { margin: 1in; size: A4; }
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .form-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .nav-buttons { justify-content: center; }
      .header { flex-direction: column; gap: 1rem; text-align: center; }
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <a href="./index.html" style="position: absolute; top: 20px; left: 20px; color: white; text-decoration: none; z-index: 10; background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 0.5rem;">‚Üê Back to MES</a>
  <div class="login-form">
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <div style="font-size: 64px; margin-bottom: 1rem;">ü•ú</div>
      <h2 style="color: var(--primary); margin: 0;">Pistachio Production Login</h2>
    </div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Username</label>
        <input id="loginUsername" type="text" required autocomplete="username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input id="loginPassword" type="password" required autocomplete="current-password">
      </div>
      <button type="submit" style="width: 100%; margin-top: 1rem;">Login</button>
    </form>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
      <p><strong>Demo Credentials:</strong></p>
      <p>Admin: admin / admin123</p>
      <p>Operator: operator / op123</p>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display: none;">
  <header class="header">
    <div style="display: flex; align-items: center;">
      <a href="./index.html" class="back-link">‚Üê Back to MES</a>
      <span style="font-size: 32px; margin-right: 0.75rem;">ü•ú</span>
      <h1>Pistachio Production Management</h1>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <span id="userDisplay">User</span>
      <button onclick="logout()" style="background: rgba(255,255,255,0.2);">
        Logout
      </button>
    </div>
  </header>

  <div class="container">
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="showSection('lotmanagement')">Lot Management</button>
      <button class="nav-btn" onclick="showSection('production')">New Production</button>
      <button class="nav-btn" onclick="showSection('records')">View Records</button>
      <button class="nav-btn" onclick="showSection('inventory')">Inventory</button>
      <button class="nav-btn" onclick="showSection('reports')">Reports</button>
    </div>

    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <div class="section-header-with-image">
        <span style="font-size: 48px; margin-right: 1rem;">ü•ú</span>
        <h2>Production Dashboard</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div>Active Lots</div>
          <div class="stat-value" id="kpiActiveLots">0</div>
        </div>
        <div class="stat-card">
          <div>Total Finished (kg)</div>
          <div class="stat-value" id="kpiFinished">0</div>
        </div>
        <div class="stat-card">
          <div>Efficiency (%)</div>
          <div class="stat-value" id="kpiEff">0</div>
        </div>
        <div class="stat-card">
          <div>Reject Rate (%)</div>
          <div class="stat-value" id="kpiReject">0.0</div>
        </div>
      </div>
      <p style="color: #666; font-style: italic;">KPIs update automatically when you submit production records.</p>
    </section>

    <!-- Lot Management Section -->
    <section id="lotmanagement" class="section">
      <div class="section-header-with-image">
        <span style="font-size: 48px; margin-right: 1rem;">ü•ú</span>
        <h2>Lot Management</h2>
      </div>
      
      <div id="lotMessages"></div>
      
      <!-- Create New Lot -->
      <div class="materials-section">
        <h3>Create New Lot</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Lot Number *</label>
            <input id="lotNumber" type="text" placeholder="e.g., LOT-2024-001" required>
          </div>
          <div class="form-group">
            <label>Brand *</label>
            <select id="lotBrand" required>
              <option value="">Select Brand</option>
              <option value="Golden Hill">Golden Hill</option>
              <option value="Extra">Extra</option>
            </select>
          </div>
          <div class="form-group">
            <label>Total Containers *</label>
            <input id="totalContainers" type="number" min="1" max="1000" value="1" onchange="calculateLotTotals()" required>
          </div>
          <div class="form-group">
            <label>Bags per Container *</label>
            <input id="bagsPerContainer" type="number" min="1" max="200" value="50" onchange="calculateLotTotals()" required>
          </div>
          <div class="form-group">
            <label>Kg per Bag *</label>
            <input id="kgPerBag" type="number" min="0.1" max="100" step="0.1" value="25" onchange="calculateLotTotals()" required>
          </div>
          <div class="form-group">
            <label>Total Raw Quantity (kg)</label>
            <input id="totalRawQuantity" type="number" readonly style="background: #f8f9fa; font-weight: bold;">
          </div>
        </div>
        <button onclick="createLot()" id="createLotBtn">Create Lot</button>
      </div>

      <!-- Active Lots Table -->
      <h3>Current Lots Status</h3>
      <div style="overflow-x: auto;">
        <table id="lotsTable">
          <thead>
            <tr>
              <th>Lot Number</th>
              <th>Brand</th>
              <th>Containers</th>
              <th>Total Raw (kg)</th>
              <th>Used (kg)</th>
              <th>Available (kg)</th>
              <th>Progress</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Production Entry Section -->
    <section id="production" class="section">
      <div class="section-header-with-image">
        <span style="font-size: 48px; margin-right: 1rem;">ü•ú</span>
        <h2>New Production Entry</h2>
      </div>
      
      <div id="productionMessages"></div>
      
      <div class="warning-box">
        <strong>Note:</strong> Select an active lot to record production for a specific shift.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Select Lot *</label>
          <select id="productionLot" onchange="updateLotInfo()" required>
            <option value="">Select a lot...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Shift *</label>
          <select id="shift" required>
            <option value="Day">Day Shift</option>
            <option value="Night">Night Shift</option>
          </select>
        </div>
        <div class="form-group">
          <label>Production Date *</label>
          <input id="productionDate" type="date" required>
        </div>
        <div class="form-group">
          <label>Raw Input This Shift (kg) *</label>
          <input id="rawInputShift" type="number" min="0" max="100000" step="1" value="0" onchange="debounceProductionSummary()" required>
        </div>
      </div>

      <!-- Lot Info Display -->
      <div id="lotInfoDisplay" class="materials-section" style="display: none;">
        <h4>Selected Lot Information</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div><strong>Brand:</strong> <span id="selectedLotBrand">-</span></div>
          <div><strong>Available Raw:</strong> <span id="selectedLotAvailable">-</span> kg</div>
          <div><strong>Total Containers:</strong> <span id="selectedLotContainers">-</span></div>
          <div><strong>Bags/Container:</strong> <span id="selectedLotBags">-</span></div>
        </div>
      </div>

      <!-- Final Goods Output -->
      <h3>Final Goods Output</h3>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="form-group">
          <label>18-21 Size (kg) *</label>
          <input id="bags1821" type="number" min="0" max="50000" step="1" value="0" onchange="debounceProductionSummary()" required>
        </div>
        <div class="form-group">
          <label>21-25 Size (kg) *</label>
          <input id="bags2125" type="number" min="0" max="50000" step="1" value="0" onchange="debounceProductionSummary()" required>
        </div>
      </div>

      <!-- Materials Usage -->
      <div class="materials-section">
        <h3>Materials Usage</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Vacuum Bags Used</label>
            <input id="bagsUsed" type="number" min="0" max="10000" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Used</label>
            <input id="boxesUsed" type="number" min="0" max="10000" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Vacuum Bags Wasted</label>
            <input id="bagsWasted" type="number" min="0" max="1000" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Wasted</label>
            <input id="boxesWasted" type="number" min="0" max="1000" step="1" value="0">
          </div>
        </div>
      </div>

      <!-- Rejects -->
      <div class="materials-section">
        <h3>Rejects (kg)</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Non-Split (Closed)</label>
            <input id="rejNonSplit" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Light Stain</label>
            <input id="rejLightStain" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Adhering Hull</label>
            <input id="rejAdheringHull" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Dark Stain</label>
            <input id="rejDarkStain" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Shell & Split</label>
            <input id="rejShellSplit" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Undersize & Kernel</label>
            <input id="rejUndersize" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Loose Shell</label>
            <input id="rejLooseShell" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Loose Kernel</label>
            <input id="rejLooseKernel" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
          <div class="form-group">
            <label>Dust</label>
            <input id="rejDust" type="number" min="0" max="10000" step="1" value="0" onchange="debounceProductionSummary()">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
        <button onclick="submitProduction()" id="submitProductionBtn">Submit Production</button>
        <button class="btn-secondary" onclick="clearProductionForm()">Clear Form</button>
      </div>

      <div class="summary-box" id="productionSummary">
        Finished: 0 kg ‚Ä¢ Rejects: 0 kg ‚Ä¢ Efficiency: 0% ‚Ä¢ Yield: 0%
      </div>
    </section>

    <!-- Records Section -->
    <section id="records" class="section">
      <h2 style="margin-bottom: 1rem;">üìã Production Records</h2>
      
      <!-- Filter Controls -->
      <div class="materials-section">
        <h3>Filter Records</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Filter by Lot</label>
            <select id="recordsLotFilter" onchange="filterRecords()">
              <option value="">All Lots</option>
            </select>
          </div>
          <div class="form-group">
            <label>Filter by Shift</label>
            <select id="recordsShiftFilter" onchange="filterRecords()">
              <option value="">All Shifts</option>
              <option value="Day">Day Shift</option>
              <option value="Night">Night Shift</option>
            </select>
          </div>
          <div class="form-group">
            <label>From Date</label>
            <input id="recordsFromDate" type="date" onchange="filterRecords()">
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input id="recordsToDate" type="date" onchange="filterRecords()">
          </div>
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Date/Time</th>
              <th>Lot Number</th>
              <th>Brand</th>
              <th>Shift</th>
              <th>Raw Input (kg)</th>
              <th>18-21 Size (kg)</th>
              <th>21-25 Size (kg)</th>
              <th>Finished (kg)</th>
              <th>Rejects (kg)</th>
              <th>Efficiency (%)</th>
              <th>Yield (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Reports Section -->
    <section id="reports" class="section">
      <h2 style="margin-bottom: 1rem;">üìä Lot & Production Reports</h2>
      
      <div class="materials-section">
        <h3>Generate Reports</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Report Type</label>
            <select id="reportType" onchange="toggleLotSelection()">
              <option value="single">Single Lot Report</option>
              <option value="multiple">Multiple Lots Report</option>
            </select>
          </div>
          <div class="form-group" id="singleLotGroup">
            <label>Select Lot</label>
            <select id="reportLotSelect">
              <option value="">Choose a lot...</option>
            </select>
          </div>
          <div class="form-group" id="multipleLotGroup" style="display: none;">
            <label>Select Multiple Lots</label>
            <div id="lotCheckboxes" class="checkbox-container">
              <!-- Checkboxes will be populated here -->
            </div>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
              <button type="button" onclick="selectAllLots()" class="btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Select All</button>
              <button type="button" onclick="clearAllLots()" class="btn-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">Clear All</button>
              <span id="selectedLotsCount" style="font-size: 0.9rem; color: #666;">0 lots selected</span>
            </div>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button onclick="generateLotReport()" id="generateReportBtn">Generate Report</button>
          </div>
        </div>
      </div>

      <!-- Report Preview Area -->
      <div id="lotReportPreview" style="display: none; margin-top: 2rem;">
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
          <button onclick="printLotReport()">üñ®Ô∏è Print Report</button>
          <button onclick="exportLotReportPDF()" class="btn-secondary">üìÑ Export PDF</button>
          <button onclick="exportLotReportExcel()" class="btn-secondary">üìä Export Excel</button>
        </div>
        <div id="lotReportContent" class="report-content">
          <!-- Report content will be generated here -->
        </div>
      </div>
    </section>

    <!-- Inventory Section -->
    <section id="inventory" class="section">
      <h2 style="margin-bottom: 1rem;">üì¶ Inventory Management</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Vacuum Bags (10kg)</div>
          <div class="stat-value" id="invVacuumBags">0</div>
        </div>
        <div class="stat-card">
          <div>Golden Hill Boxes</div>
          <div class="stat-value" id="invGoldenHillBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Extra Boxes</div>
          <div class="stat-value" id="invExtraBoxes">0</div>
        </div>
      </div>

      <div id="inventoryMessages"></div>

      <div class="materials-section">
        <h3>Stock Adjustment</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Item *</label>
            <select id="invItem" required>
              <option value="">Select Item</option>
              <option value="vacuumBags">Vacuum Bags (10kg)</option>
              <option value="goldenHillBoxes">Golden Hill Boxes</option>
              <option value="extraBoxes">Extra Boxes</option>
            </select>
          </div>
          <div class="form-group">
            <label>Action *</label>
            <select id="invAction" required>
              <option value="">Select Action</option>
              <option value="add">Add Stock</option>
              <option value="remove">Remove Stock</option>
              <option value="set">Set Exact Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity *</label>
            <input id="invQuantity" type="number" min="0" max="100000" step="1" value="0" required>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input id="invNotes" type="text" placeholder="Reason for adjustment" maxlength="200">
          </div>
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button onclick="adjustInventory()" id="adjustInventoryBtn">Update Inventory</button>
          <button class="btn-secondary" onclick="exportInventoryExcel()">üìä Export Excel</button>
          <button class="btn-secondary" onclick="exportInventoryPDF()">üìÑ Export PDF</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
// Utility functions
const Utils = {
  debounce: function(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  sanitizeInput: function(input, type = 'text') {
    if (typeof input !== 'string') return input;
    
    switch (type) {
      case 'number':
        return parseFloat(input.replace(/[^\d.-]/g, '')) || 0;
      case 'integer':
        return parseInt(input.replace(/[^\d-]/g, '')) || 0;
      case 'text':
        return input.trim().slice(0, 200);
      default:
        return input.trim();
    }
  },

  showMessage: function(containerId, message, type = 'info', duration = 5000) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-box`;
    messageDiv.textContent = message;
    messageDiv.style.animation = 'fadeIn 0.3s ease';
    
    container.innerHTML = '';
    container.appendChild(messageDiv);

    if (duration > 0) {
      setTimeout(() => {
        messageDiv.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 300);
      }, duration);
    }
  },

  validateNumberRange: function(value, min = 0, max = Infinity) {
    const num = parseFloat(value);
    return !isNaN(num) && num >= min && num <= max;
  },

  formatNumber: function(number, decimals = 0) {
    return parseFloat(number).toLocaleString(undefined, {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  },

  formatDate: function(date) {
    return new Date(date).toLocaleDateString();
  },

  formatDateTime: function(date) {
    return new Date(date).toLocaleString();
  },

  safeLocalStorage: {
    get: function(key, defaultValue = null) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (error) {
        console.warn('Error reading from localStorage:', error);
        return defaultValue;
      }
    },

    set: function(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (error) {
        console.warn('Error writing to localStorage:', error);
        Utils.showMessage('mainMessages', 'Storage error - some changes may not be saved', 'warning');
        return false;
      }
    }
  }
};

// Enhanced State Management
class AppState {
  constructor() {
    this.data = {
      lots: [],
      productionRecords: [],
      inventoryLog: [],
      currentInventory: {
        vacuumBags: 1000,
        goldenHillBoxes: 500,
        extraBoxes: 300
      },
      currentUser: null
    };
    this.listeners = {};
    this.loadFromStorage();
  }

  subscribe(key, callback) {
    if (!this.listeners[key]) {
      this.listeners[key] = [];
    }
    this.listeners[key].push(callback);
  }

  setState(key, value) {
    this.data[key] = value;
    this.saveToStorage();
    this.notify(key, value);
  }

  getState(key) {
    return this.data[key];
  }

  notify(key, value) {
    if (this.listeners[key]) {
      this.listeners[key].forEach(callback => {
        try {
          callback(value);
        } catch (error) {
          console.error('Error in state listener:', error);
        }
      });
    }
  }

  addToArray(key, item) {
    if (Array.isArray(this.data[key])) {
      this.data[key].push(item);
      this.saveToStorage();
      this.notify(key, this.data[key]);
      return true;
    }
    return false;
  }

  updateArrayItem(key, id, updater) {
    if (Array.isArray(this.data[key])) {
      const index = this.data[key].findIndex(item => item.id === id);
      if (index !== -1) {
        try {
          this.data[key][index] = updater(this.data[key][index]);
          this.saveToStorage();
          this.notify(key, this.data[key]);
          return true;
        } catch (error) {
          console.error('Error updating array item:', error);
          return false;
        }
      }
    }
    return false;
  }

  updateInventory(item, action, quantity) {
    if (!this.data.currentInventory.hasOwnProperty(item)) {
      return { success: false, error: 'Invalid item' };
    }

    const current = this.data.currentInventory[item] || 0;
    let newValue;

    switch(action) {
      case 'add':
        newValue = current + quantity;
        break;
      case 'remove':
        if (current < quantity) {
          return { success: false, error: 'Insufficient stock' };
        }
        newValue = current - quantity;
        break;
      case 'set':
        newValue = Math.max(0, quantity);
        break;
      default:
        return { success: false, error: 'Invalid action' };
    }

    this.data.currentInventory[item] = newValue;
    
    // Log the change
    const logEntry = {
      id: Date.now().toString(),
      timestamp: new Date().toISOString(),
      item: item,
      action: action,
      quantity: quantity,
      previousValue: current,
      newValue: newValue,
      user: this.data.currentUser
    };
    
    this.data.inventoryLog.push(logEntry);
    this.saveToStorage();
    this.notify('currentInventory', this.data.currentInventory);
    
    return { success: true, newValue: newValue };
  }

  saveToStorage() {
    return Utils.safeLocalStorage.set('pistachio_mes_data', this.data);
  }

  loadFromStorage() {
    const saved = Utils.safeLocalStorage.get('pistachio_mes_data');
    if (saved && typeof saved === 'object') {
      this.data = { ...this.data, ...saved };
    }
  }
}

// Initialize app state
window.appState = new AppState();

// User management
const users = { 
  admin: 'admin123', 
  operator: 'op123' 
};

// Debounced functions
const debounceProductionSummary = Utils.debounce(updateProductionSummary, 300);

// Login handling
function handleLogin(event) {
  event.preventDefault();
  
  const username = Utils.sanitizeInput(document.getElementById('loginUsername').value, 'text');
  const password = Utils.sanitizeInput(document.getElementById('loginPassword').value, 'text');
  
  if (!username || !password) {
    Utils.showMessage('loginMessages', 'Please enter both username and password', 'error');
    return;
  }
  
  if (users[username] && users[username] === password) {
    window.appState.setState('currentUser', username);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userDisplay').textContent = username.charAt(0).toUpperCase() + username.slice(1);
    
    // Set today's date
    document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];
    
    // Initialize all sections
    initializeApp();
    
    Utils.showMessage('mainMessages', `Welcome back, ${username}!`, 'success');
  } else {
    Utils.showMessage('loginMessages', 'Invalid credentials. Please try again.', 'error');
    document.getElementById('loginPassword').value = '';
  }
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    window.appState.setState('currentUser', null);
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    
    // Clear form data for security
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
  }
}

function initializeApp() {
  updateDashboard();
  renderLots();
  renderRecords();
  renderInventory();
  updateProductionLotDropdown();
  updateReportsLotDropdown();
  calculateLotTotals();
  updateProductionSummary();
}

// Navigation
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.getElementById(sectionId).classList.add('active');
  event.target.classList.add('active');
}

// Lot Management Functions
function calculateLotTotals() {
  const containers = Utils.sanitizeInput(document.getElementById('totalContainers').value, 'integer');
  const bagsPerContainer = Utils.sanitizeInput(document.getElementById('bagsPerContainer').value, 'integer');
  const kgPerBag = Utils.sanitizeInput(document.getElementById('kgPerBag').value, 'number');
  
  if (!Utils.validateNumberRange(containers, 1, 1000) || 
      !Utils.validateNumberRange(bagsPerContainer, 1, 200) || 
      !Utils.validateNumberRange(kgPerBag, 0.1, 100)) {
    document.getElementById('totalRawQuantity').value = 0;
    return;
  }
  
  const totalRawQuantity = containers * bagsPerContainer * kgPerBag;
  document.getElementById('totalRawQuantity').value = totalRawQuantity.toFixed(1);
}

function createLot() {
  const btn = document.getElementById('createLotBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span> Creating...';
  
  try {
    const lotNumber = Utils.sanitizeInput(document.getElementById('lotNumber').value, 'text');
    const brand = document.getElementById('lotBrand').value;
    const totalContainers = Utils.sanitizeInput(document.getElementById('totalContainers').value, 'integer');
    const bagsPerContainer = Utils.sanitizeInput(document.getElementById('bagsPerContainer').value, 'integer');
    const kgPerBag = Utils.sanitizeInput(document.getElementById('kgPerBag').value, 'number');
    const totalRawQuantity = parseFloat(document.getElementById('totalRawQuantity').value) || 0;
    
    // Validation
    if (!lotNumber) {
      Utils.showMessage('lotMessages', 'Please enter a lot number', 'error');
      return;
    }
    
    if (!brand) {
      Utils.showMessage('lotMessages', 'Please select a brand', 'error');
      return;
    }
    
    if (!Utils.validateNumberRange(totalContainers, 1, 1000)) {
      Utils.showMessage('lotMessages', 'Total containers must be between 1 and 1000', 'error');
      return;
    }
    
    if (!Utils.validateNumberRange(bagsPerContainer, 1, 200)) {
      Utils.showMessage('lotMessages', 'Bags per container must be between 1 and 200', 'error');
      return;
    }
    
    if (!Utils.validateNumberRange(kgPerBag, 0.1, 100)) {
      Utils.showMessage('lotMessages', 'Kg per bag must be between 0.1 and 100', 'error');
      return;
    }
    
    if (totalRawQuantity <= 0) {
      Utils.showMessage('lotMessages', 'Total raw quantity must be greater than 0', 'error');
      return;
    }
    
    // Check for duplicate lot number
    const lots = window.appState.getState('lots') || [];
    if (lots.some(lot => lot.lotNumber.toLowerCase() === lotNumber.toLowerCase())) {
      Utils.showMessage('lotMessages', 'Lot number already exists', 'error');
      return;
    }
    
    const newLot = {
      id: Date.now().toString(),
      lotNumber: lotNumber.toUpperCase(),
      brand,
      totalContainers,
      bagsPerContainer,
      kgPerBag,
      totalRawQuantity,
      availableRawQuantity: totalRawQuantity,
      usedRawQuantity: 0,
      status: 'Open',
      createdDate: new Date().toISOString(),
      createdBy: window.appState.getState('currentUser')
    };
    
    window.appState.addToArray('lots', newLot);
    
    // Clear form
    document.getElementById('lotNumber').value = '';
    document.getElementById('lotBrand').value = '';
    document.getElementById('totalContainers').value = '1';
    document.getElementById('bagsPerContainer').value = '50';
    document.getElementById('kgPerBag').value = '25';
    document.getElementById('totalRawQuantity').value = '';
    
    Utils.showMessage('lotMessages', `Lot ${lotNumber.toUpperCase()} created successfully!`, 'success');
    
    // Update related components
    updateProductionLotDropdown();
    updateReportsLotDropdown();
    updateDashboard();
    
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create Lot';
  }
}

function renderLots() {
  const tbody = document.querySelector('#lotsTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  const lots = window.appState.getState('lots') || [];
  
  if (lots.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 2rem;">No lots created yet</td></tr>';
    return;
  }
  
  lots.forEach(lot => {
    const progressPercent = lot.totalRawQuantity > 0 
      ? Math.min(100, Math.round((lot.usedRawQuantity / lot.totalRawQuantity) * 100))
      : 0;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${lot.lotNumber}</strong></td>
      <td>${lot.brand}</td>
      <td>${Utils.formatNumber(lot.totalContainers)}</td>
      <td>${Utils.formatNumber(lot.totalRawQuantity, 1)}</td>
      <td>${Utils.formatNumber(lot.usedRawQuantity, 1)}</td>
      <td>${Utils.formatNumber(lot.availableRawQuantity, 1)}</td>
      <td>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressPercent}%;">
            ${progressPercent}%
          </div>
        </div>
      </td>
      <td><span class="lot-status ${lot.status.toLowerCase()}">${lot.status}</span></td>
      <td>${Utils.formatDate(lot.createdDate)}</td>
    `;
    tbody.appendChild(row);
  });
}

// Production Functions
function updateProductionLotDropdown() {
  const dropdown = document.getElementById('productionLot');
  if (!dropdown) return;
  
  const currentValue = dropdown.value;
  dropdown.innerHTML = '<option value="">Select a lot...</option>';
  
  const lots = window.appState.getState('lots') || [];
  const openLots = lots.filter(lot => lot.status === 'Open' && lot.availableRawQuantity > 0);
  
  if (openLots.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'No active lots available';
    option.disabled = true;
    dropdown.appendChild(option);
  } else {
    openLots.forEach(lot => {
      const option = document.createElement('option');
      option.value = lot.id;
      option.textContent = `${lot.lotNumber} (${lot.brand}) - ${Utils.formatNumber(lot.availableRawQuantity, 1)} kg available`;
      if (option.value === currentValue) option.selected = true;
      dropdown.appendChild(option);
    });
  }
}

function updateLotInfo() {
  const lotId = document.getElementById('productionLot').value;
  const lotDisplay = document.getElementById('lotInfoDisplay');
  
  if (!lotId || !lotDisplay) {
    if (lotDisplay) lotDisplay.style.display = 'none';
    return;
  }
  
  const lots = window.appState.getState('lots') || [];
  const selectedLot = lots.find(lot => lot.id === lotId);
  
  if (selectedLot) {
    document.getElementById('selectedLotBrand').textContent = selectedLot.brand;
    document.getElementById('selectedLotAvailable').textContent = Utils.formatNumber(selectedLot.availableRawQuantity, 1);
    document.getElementById('selectedLotContainers').textContent = Utils.formatNumber(selectedLot.totalContainers);
    document.getElementById('selectedLotBags').textContent = Utils.formatNumber(selectedLot.bagsPerContainer);
    lotDisplay.style.display = 'block';
  }
}

function updateProductionSummary() {
  const kg1821 = Utils.sanitizeInput(document.getElementById('bags1821').value, 'integer');
  const kg2125 = Utils.sanitizeInput(document.getElementById('bags2125').value, 'integer');
  const finishedKg = kg1821 + kg2125;
  
  const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                    'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
  const rejectsKg = rejectIds.reduce((sum, id) => {
    const element = document.getElementById(id);
    return sum + (element ? Utils.sanitizeInput(element.value, 'integer') : 0);
  }, 0);
  
  const rawInput = Utils.sanitizeInput(document.getElementById('rawInputShift').value, 'integer');
  const totalOutput = finishedKg + rejectsKg;
  
  const efficiency = rawInput > 0 ? Math.min(100, Math.round((finishedKg / rawInput) * 100)) : 0;
  const yield = rawInput > 0 ? Math.min(100, Math.round((totalOutput / rawInput) * 100)) : 0;
  
  const summaryElement = document.getElementById('productionSummary');
  if (summaryElement) {
    summaryElement.textContent = 
      `Finished: ${Utils.formatNumber(finishedKg)} kg ‚Ä¢ Rejects: ${Utils.formatNumber(rejectsKg)} kg ‚Ä¢ Efficiency: ${efficiency}% ‚Ä¢ Yield: ${yield}%`;
    
    // Update styling based on efficiency
    summaryElement.style.borderLeft = efficiency >= 80 ? '4px solid var(--success)' : 
                                     efficiency >= 60 ? '4px solid var(--warning)' : 
                                     '4px solid var(--error)';
  }
}

function submitProduction() {
  const btn = document.getElementById('submitProductionBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span> Submitting...';
  
  try {
    const lotId = document.getElementById('productionLot').value;
    const shift = document.getElementById('shift').value;
    const productionDate = document.getElementById('productionDate').value;
    const rawInputShift = Utils.sanitizeInput(document.getElementById('rawInputShift').value, 'integer');
    
    // Basic validation
    if (!lotId) {
      Utils.showMessage('productionMessages', 'Please select a lot', 'error');
      return;
    }
    
    if (!productionDate) {
      Utils.showMessage('productionMessages', 'Please select a production date', 'error');
      return;
    }
    
    if (!Utils.validateNumberRange(rawInputShift, 1, 100000)) {
      Utils.showMessage('productionMessages', 'Raw input must be between 1 and 100,000 kg', 'error');
      return;
    }
    
    const lots = window.appState.getState('lots') || [];
    const selectedLot = lots.find(lot => lot.id === lotId);
    
    if (!selectedLot) {
      Utils.showMessage('productionMessages', 'Selected lot not found', 'error');
      return;
    }
    
    if (rawInputShift > selectedLot.availableRawQuantity) {
      Utils.showMessage('productionMessages', 
        `Insufficient raw material. Available: ${Utils.formatNumber(selectedLot.availableRawQuantity, 1)} kg`, 'error');
      return;
    }
    
    const bags1821 = Utils.sanitizeInput(document.getElementById('bags1821').value, 'integer');
    const bags2125 = Utils.sanitizeInput(document.getElementById('bags2125').value, 'integer');
    const finishedKg = bags1821 + bags2125;
    
    if (finishedKg <= 0) {
      Utils.showMessage('productionMessages', 'Please enter finished goods quantities', 'error');
      return;
    }
    
    // Check for unrealistic efficiency
    const efficiency = Math.round((finishedKg / rawInputShift) * 100);
    if (efficiency > 100) {
      Utils.showMessage('productionMessages', 
        'Efficiency cannot exceed 100%. Please check your input values.', 'error');
      return;
    }
    
    const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                      'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
    const rejectsData = {};
    const rejectsKg = rejectIds.reduce((sum, id) => {
      const key = id.replace('rej', '').toLowerCase();
      const value = Utils.sanitizeInput(document.getElementById(id).value, 'integer');
      rejectsData[key] = value;
      return sum + value;
    }, 0);
    
    const totalOutput = finishedKg + rejectsKg;
    const yield = Math.round((totalOutput / rawInputShift) * 100);
    
    // Check for unrealistic yield
    if (yield > 120) {
      Utils.showMessage('productionMessages', 
        'Total output exceeds reasonable yield. Please check your input values.', 'error');
      return;
    }
    
    const productionRecord = {
      id: Date.now().toString(),
      lotId: lotId,
      lotNumber: selectedLot.lotNumber,
      brand: selectedLot.brand,
      shift: shift,
      productionDate: productionDate,
      timestamp: new Date().toISOString(),
      rawInputShift: rawInputShift,
      kg1821: bags1821,
      kg2125: bags2125,
      finishedKg: finishedKg,
      rejectsKg: rejectsKg,
      totalOutput: totalOutput,
      efficiency: efficiency,
      yield: yield,
      materials: {
        bagsUsed: Utils.sanitizeInput(document.getElementById('bagsUsed').value, 'integer'),
        boxesUsed: Utils.sanitizeInput(document.getElementById('boxesUsed').value, 'integer'),
        bagsWasted: Utils.sanitizeInput(document.getElementById('bagsWasted').value, 'integer'),
        boxesWasted: Utils.sanitizeInput(document.getElementById('boxesWasted').value, 'integer')
      },
      rejects: rejectsData,
      user: window.appState.getState('currentUser')
    };
    
    // Add production record
    window.appState.addToArray('productionRecords', productionRecord);
    
    // Update lot quantities
    const updateResult = window.appState.updateArrayItem('lots', lotId, (lot) => {
      lot.usedRawQuantity += rawInputShift;
      lot.availableRawQuantity -= rawInputShift;
      if (lot.availableRawQuantity <= 0) {
        lot.status = 'Completed';
      }
      return lot;
    });
    
    if (!updateResult) {
      Utils.showMessage('productionMessages', 'Error updating lot quantities', 'error');
      return;
    }
    
    // Handle inventory updates (materials usage)
    const totalBagsNeeded = productionRecord.materials.bagsUsed + productionRecord.materials.bagsWasted;
    const totalBoxesNeeded = productionRecord.materials.boxesUsed + productionRecord.materials.boxesWasted;
    const boxType = selectedLot.brand === 'Golden Hill' ? 'goldenHillBoxes' : 'extraBoxes';
    
    let inventoryWarnings = [];
    
    if (totalBagsNeeded > 0) {
      const result = window.appState.updateInventory('vacuumBags', 'remove', totalBagsNeeded);
      if (!result.success) {
        inventoryWarnings.push(`Vacuum bags: ${result.error}`);
      }
    }
    if (totalBoxesNeeded > 0) {
      const result = window.appState.updateInventory(boxType, 'remove', totalBoxesNeeded);
      if (!result.success) {
        inventoryWarnings.push(`${selectedLot.brand} boxes: ${result.error}`);
      }
    }
    
    let message = `Production record submitted successfully!`;
    if (inventoryWarnings.length > 0) {
      message += ` Note: ${inventoryWarnings.join(', ')}`;
    }
    
    Utils.showMessage('productionMessages', message, inventoryWarnings.length > 0 ? 'warning' : 'success');
    
    clearProductionForm();
    updateDashboard();
    renderRecords();
    updateProductionLotDropdown();
    
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Production';
  }
}

function clearProductionForm() {
  if (confirm('Are you sure you want to clear all form data?')) {
    document.getElementById('productionLot').value = '';
    document.getElementById('rawInputShift').value = '0';
    document.querySelectorAll('#production input[type="number"]').forEach(input => {
      if (input.id !== 'rawInputShift') {
        input.value = '0';
      }
    });
    document.getElementById('lotInfoDisplay').style.display = 'none';
    updateProductionSummary();
  }
}

// Dashboard Functions
function updateDashboard() {
  const lots = window.appState.getState('lots') || [];
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  const activeLots = lots.filter(lot => lot.status === 'Open').length;
  
  let totalFinished = 0;
  let totalInput = 0;
  let totalRejects = 0;
  
  productionRecords.forEach(record => {
    totalFinished += record.finishedKg || 0;
    totalInput += record.rawInputShift || 0;
    totalRejects += record.rejectsKg || 0;
  });
  
  const avgEfficiency = totalInput > 0 ? Math.round((totalFinished / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? ((totalRejects / totalInput) * 100) : 0;
  
  const elements = {
    kpiActiveLots: activeLots,
    kpiFinished: Utils.formatNumber(totalFinished),
    kpiEff: avgEfficiency,
    kpiReject: rejectRate.toFixed(1)
  };
  
  Object.entries(elements).forEach(([id, value]) => {
    const element = document.getElementById(id);
    if (element) element.textContent = value;
  });
}

// Records Functions
function renderRecords() {
  const tbody = document.querySelector('#recordsTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  if (productionRecords.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666; font-style: italic; padding: 2rem;">No production records yet</td></tr>';
    updateRecordsFilters();
    return;
  }
  
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${Utils.formatDateTime(record.timestamp)}</td>
      <td><strong>${record.lotNumber}</strong></td>
      <td>${record.brand}</td>
      <td><span class="shift-badge ${record.shift.toLowerCase()}">${record.shift}</span></td>
      <td>${Utils.formatNumber(record.rawInputShift)}</td>
      <td>${Utils.formatNumber(record.kg1821)}</td>
      <td>${Utils.formatNumber(record.kg2125)}</td>
      <td><strong>${Utils.formatNumber(record.finishedKg)}</strong></td>
      <td>${Utils.formatNumber(record.rejectsKg)}</td>
      <td><strong>${record.efficiency}%</strong></td>
      <td>${record.yield}%</td>
    `;
    tbody.appendChild(row);
  });
  
  updateRecordsFilters();
}

function updateRecordsFilters() {
  const lots = window.appState.getState('lots') || [];
  const lotFilter = document.getElementById('recordsLotFilter');
  
  if (!lotFilter) return;
  
  const currentValue = lotFilter.value;
  lotFilter.innerHTML = '<option value="">All Lots</option>';
  
  lots.forEach(lot => {
    const option = document.createElement('option');
    option.value = lot.lotNumber;
    option.textContent = `${lot.lotNumber} (${lot.brand})`;
    if (option.value === currentValue) option.selected = true;
    lotFilter.appendChild(option);
  });
}

function filterRecords() {
  const lotFilter = document.getElementById('recordsLotFilter').value;
  const shiftFilter = document.getElementById('recordsShiftFilter').value;
  const fromDate = document.getElementById('recordsFromDate').value;
  const toDate = document.getElementById('recordsToDate').value;
  
  const tbody = document.querySelector('#recordsTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  let productionRecords = window.appState.getState('productionRecords') || [];
  
  // Apply filters
  if (lotFilter) {
    productionRecords = productionRecords.filter(record => record.lotNumber === lotFilter);
  }
  
  if (shiftFilter) {
    productionRecords = productionRecords.filter(record => record.shift === shiftFilter);
  }
  
  if (fromDate) {
    productionRecords = productionRecords.filter(record => record.productionDate >= fromDate);
  }
  
  if (toDate) {
    productionRecords = productionRecords.filter(record => record.productionDate <= toDate);
  }
  
  if (productionRecords.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666; font-style: italic; padding: 2rem;">No records match the selected filters</td></tr>';
    return;
  }
  
  // Render filtered records
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${Utils.formatDateTime(record.timestamp)}</td>
      <td><strong>${record.lotNumber}</strong></td>
      <td>${record.brand}</td>
      <td><span class="shift-badge ${record.shift.toLowerCase()}">${record.shift}</span></td>
      <td>${Utils.formatNumber(record.rawInputShift)}</td>
      <td>${Utils.formatNumber(record.kg1821)}</td>
      <td>${Utils.formatNumber(record.kg2125)}</td>
      <td><strong>${Utils.formatNumber(record.finishedKg)}</strong></td>
      <td>${Utils.formatNumber(record.rejectsKg)}</td>
      <td><strong>${record.efficiency}%</strong></td>
      <td>${record.yield}%</td>
    `;
    tbody.appendChild(row);
  });
}

// Reports Functions
function updateReportsLotDropdown() {
  const dropdown = document.getElementById('reportLotSelect');
  const checkboxContainer = document.getElementById('lotCheckboxes');
  
  if (!dropdown || !checkboxContainer) return;
  
  const currentValue = dropdown.value;
  dropdown.innerHTML = '<option value="">Choose a lot...</option>';
  checkboxContainer.innerHTML = '';
  
  const lots = window.appState.getState('lots') || [];
  
  if (lots.length === 0) {
    dropdown.innerHTML = '<option value="" disabled>No lots available</option>';
    checkboxContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No lots available</div>';
    return;
  }
  
  lots.forEach(lot => {
    // Single lot dropdown
    const option = document.createElement('option');
    option.value = lot.id;
    option.textContent = `${lot.lotNumber} (${lot.brand}) - ${lot.status}`;
    if (option.value === currentValue) option.selected = true;
    dropdown.appendChild(option);
    
    // Multiple lots checkboxes
    const checkboxDiv = document.createElement('div');
    checkboxDiv.className = 'checkbox-item';
    checkboxDiv.innerHTML = `
      <label>
        <input type="checkbox" value="${lot.id}" onchange="updateSelectedCount()">
        <div>
          <strong>${lot.lotNumber}</strong> (${lot.brand})
          <div style="font-size: 0.8rem; color: #666;">
            ${lot.status} ‚Ä¢ ${Utils.formatNumber(lot.totalRawQuantity, 1)} kg total
          </div>
        </div>
      </label>
    `;
    checkboxContainer.appendChild(checkboxDiv);
  });
  
  updateSelectedCount();
}

function toggleLotSelection() {
  const reportType = document.getElementById('reportType').value;
  const singleGroup = document.getElementById('singleLotGroup');
  const multipleGroup = document.getElementById('multipleLotGroup');
  
  if (reportType === 'single') {
    singleGroup.style.display = 'block';
    multipleGroup.style.display = 'none';
  } else {
    singleGroup.style.display = 'none';
    multipleGroup.style.display = 'block';
  }
}

function selectAllLots() {
  const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = true);
  updateSelectedCount();
}

function clearAllLots() {
  const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
  updateSelectedCount();
}

function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]:checked');
  const countElement = document.getElementById('selectedLotsCount');
  if (countElement) {
    countElement.textContent = `${checkboxes.length} lots selected`;
  }
}

function generateLotReport() {
  const btn = document.getElementById('generateReportBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span> Generating...';
  
  try {
    const reportType = document.getElementById('reportType').value;
    let selectedLotIds = [];
    
    if (reportType === 'single') {
      const singleLotId = document.getElementById('reportLotSelect').value;
      if (!singleLotId) {
        Utils.showMessage('reportsMessages', 'Please select a lot', 'error');
        return;
      }
      selectedLotIds = [singleLotId];
    } else {
      const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]:checked');
      selectedLotIds = Array.from(checkboxes).map(cb => cb.value);
      
      if (selectedLotIds.length === 0) {
        Utils.showMessage('reportsMessages', 'Please select at least one lot', 'error');
        return;
      }
    }
    
    const lots = window.appState.getState('lots') || [];
    const productionRecords = window.appState.getState('productionRecords') || [];
    
    const selectedLots = lots.filter(lot => selectedLotIds.includes(lot.id));
    const allLotRecords = productionRecords.filter(record => selectedLotIds.includes(record.lotId));
    
    if (selectedLots.length === 1) {
      generateSingleLotReportHTML(selectedLots[0], allLotRecords);
    } else {
      generateMultiLotReportHTML(selectedLots, allLotRecords);
    }
    
    document.getElementById('lotReportPreview').style.display = 'block';
    Utils.showMessage('reportsMessages', 'Report generated successfully!', 'success');
    
  } finally {
    btn.disabled = false;
    btn.textContent = 'Generate Report';
  }
}

function generateSingleLotReportHTML(lot, records) {
  const reportContent = document.getElementById('lotReportContent');
  if (!reportContent) return;
  
  // Calculate totals
  const totalRawUsed = records.reduce((sum, r) => sum + (r.rawInputShift || 0), 0);
  const totalFinished = records.reduce((sum, r) => sum + (r.finishedKg || 0), 0);
  const totalRejects = records.reduce((sum, r) => sum + (r.rejectsKg || 0), 0);
  const avgEfficiency = totalRawUsed > 0 ? Math.round((totalFinished / totalRawUsed) * 100) : 0;
  const avgYield = totalRawUsed > 0 ? Math.round(((totalFinished + totalRejects) / totalRawUsed) * 100) : 0;
  
  const reportHTML = `
    <div style="padding: 2rem; background: white; border-radius: 0.5rem;">
      <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 3px solid var(--primary);">
        <h1 style="color: var(--primary); margin: 0;">Al Jameel MES</h1>
        <h2 style="margin: 0.5rem 0;">Lot Production Report</h2>
        <p><strong>Generated:</strong> ${Utils.formatDateTime(new Date())}</p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div>
          <h3 style="color: var(--primary); margin-bottom: 1rem;">Lot Information</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Lot Number:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.lotNumber}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Brand:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${lot.brand}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Total Containers:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${Utils.formatNumber(lot.totalContainers)}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Bags per Container:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${Utils.formatNumber(lot.bagsPerContainer)}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Kg per Bag:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${Utils.formatNumber(lot.kgPerBag, 1)}</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem; border-bottom: 1px solid #eee;">Total Raw Quantity:</td><td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${Utils.formatNumber(lot.totalRawQuantity, 1)} kg</td></tr>
            <tr><td style="font-weight: bold; padding: 0.5rem;">Status:</td><td style="padding: 0.5rem;"><span class="lot-status ${lot.status.toLowerCase()}">${lot.status}</span></td></tr>
          </table>
        </div>

        <div>
          <h3 style="color: var(--primary); margin-bottom: 1rem;">Production Summary</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${records.length}</div>
              <div style="font-size: 0.9rem;">Total Shifts</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${Utils.formatNumber(totalRawUsed)}</div>
              <div style="font-size: 0.9rem;">Raw Used (kg)</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${Utils.formatNumber(totalFinished)}</div>
              <div style="font-size: 0.9rem;">Finished (kg)</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
              <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${avgEfficiency}%</div>
              <div style="font-size: 0.9rem;">Avg Efficiency</div>
            </div>
          </div>
        </div>
      </div>

      ${records.length > 0 ? `
      <h3 style="color: var(--primary); margin-bottom: 1rem;">Shift-wise Production Details</h3>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
          <thead>
            <tr style="background: var(--primary); color: white;">
              <th style="padding: 0.75rem; text-align: left;">Date</th>
              <th style="padding: 0.75rem; text-align: left;">Shift</th>
              <th style="padding: 0.75rem; text-align: right;">Raw Input (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">18-21 Size (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">21-25 Size (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Finished (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Rejects (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Efficiency (%)</th>
              <th style="padding: 0.75rem; text-align: right;">Yield (%)</th>
            </tr>
          </thead>
          <tbody>
            ${records.map(record => `
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 0.5rem;">${Utils.formatDate(record.productionDate)}</td>
                <td style="padding: 0.5rem;"><span class="shift-badge ${record.shift.toLowerCase()}">${record.shift}</span></td>
                <td style="padding: 0.5rem; text-align: right;">${Utils.formatNumber(record.rawInputShift)}</td>
                <td style="padding: 0.5rem; text-align: right;">${Utils.formatNumber(record.kg1821)}</td>
                <td style="padding: 0.5rem; text-align: right;">${Utils.formatNumber(record.kg2125)}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${Utils.formatNumber(record.finishedKg)}</td>
                <td style="padding: 0.5rem; text-align: right;">${Utils.formatNumber(record.rejectsKg)}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${record.efficiency}%</td>
                <td style="padding: 0.5rem; text-align: right;">${record.yield}%</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid var(--primary);">
              <td style="padding: 0.75rem;" colspan="2">TOTALS</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(totalRawUsed)}</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(records.reduce((sum, r) => sum + (r.kg1821 || 0), 0))}</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(records.reduce((sum, r) => sum + (r.kg2125 || 0), 0))}</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(totalFinished)}</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(totalRejects)}</td>
              <td style="padding: 0.75rem; text-align: right;">${avgEfficiency}%</td>
              <td style="padding: 0.75rem; text-align: right;">${avgYield}%</td>
            </tr>
          </tfoot>
        </table>
      </div>
      ` : '<p style="text-align: center; color: #666; font-style: italic; margin: 2rem 0;">No production records found for this lot.</p>'}

      <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 0.5rem; text-align: center; border-top: 3px solid var(--primary);">
        <p style="margin: 0; color: var(--primary); font-weight: 600;">Al Jameel MES - Pistachio Production Management System</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #6c757d;">Generated: ${Utils.formatDateTime(new Date())} | Confidential Report</p>
      </div>
    </div>
  `;
  
  reportContent.innerHTML = reportHTML;
}

function generateMultiLotReportHTML(lots, allRecords) {
  const reportContent = document.getElementById('lotReportContent');
  if (!reportContent) return;
  
  // Calculate combined totals
  const totalRawUsed = allRecords.reduce((sum, r) => sum + (r.rawInputShift || 0), 0);
  const totalFinished = allRecords.reduce((sum, r) => sum + (r.finishedKg || 0), 0);
  const totalRejects = allRecords.reduce((sum, r) => sum + (r.rejectsKg || 0), 0);
  const totalShifts = allRecords.length;
  const avgEfficiency = totalRawUsed > 0 ? Math.round((totalFinished / totalRawUsed) * 100) : 0;
  
  // Calculate lot-wise summaries
  const lotSummaries = lots.map(lot => {
    const lotRecords = allRecords.filter(r => r.lotId === lot.id);
    const lotRawUsed = lotRecords.reduce((sum, r) => sum + (r.rawInputShift || 0), 0);
    const lotFinished = lotRecords.reduce((sum, r) => sum + (r.finishedKg || 0), 0);
    const lotRejects = lotRecords.reduce((sum, r) => sum + (r.rejectsKg || 0), 0);
    const lotEfficiency = lotRawUsed > 0 ? Math.round((lotFinished / lotRawUsed) * 100) : 0;
    
    return {
      lot,
      records: lotRecords,
      totalRawUsed: lotRawUsed,
      totalFinished: lotFinished,
      totalRejects: lotRejects,
      efficiency: lotEfficiency,
      shiftsCount: lotRecords.length
    };
  });
  
  const reportHTML = `
    <div style="padding: 2rem; background: white; border-radius: 0.5rem;">
      <!-- Header -->
      <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 3px solid var(--primary);">
        <h1 style="color: var(--primary); margin: 0;">Al Jameel MES</h1>
        <h2 style="margin: 0.5rem 0;">Multi-Lot Production Report</h2>
        <p><strong>Generated:</strong> ${Utils.formatDateTime(new Date())}</p>
        <p><strong>Lots Included:</strong> ${lots.length} lots ‚Ä¢ <strong>Total Shifts:</strong> ${totalShifts}</p>
      </div>

      <!-- Combined Summary -->
      <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; border-left: 4px solid var(--primary);">
        <h3 style="color: var(--primary); margin-bottom: 1rem;">üìä Combined Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${lots.length}</div>
            <div style="font-size: 0.9rem;">Total Lots</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${totalShifts}</div>
            <div style="font-size: 0.9rem;">Total Shifts</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${Utils.formatNumber(totalRawUsed)}</div>
            <div style="font-size: 0.9rem;">Raw Used (kg)</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${Utils.formatNumber(totalFinished)}</div>
            <div style="font-size: 0.9rem;">Finished (kg)</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${Utils.formatNumber(totalRejects)}</div>
            <div style="font-size: 0.9rem;">Rejects (kg)</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: white; border-radius: 0.5rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${avgEfficiency}%</div>
            <div style="font-size: 0.9rem;">Avg Efficiency</div>
          </div>
        </div>
      </div>

      <!-- Lot Comparison Table -->
      <h3 style="color: var(--primary); margin-bottom: 1rem;">üìà Lot Performance Comparison</h3>
      <div style="overflow-x: auto; margin-bottom: 2rem;">
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
          <thead>
            <tr style="background: var(--primary); color: white;">
              <th style="padding: 0.75rem; text-align: left;">Lot Number</th>
              <th style="padding: 0.75rem; text-align: left;">Brand</th>
              <th style="padding: 0.75rem; text-align: center;">Shifts</th>
              <th style="padding: 0.75rem; text-align: right;">Raw Used (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Finished (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Rejects (kg)</th>
              <th style="padding: 0.75rem; text-align: right;">Efficiency (%)</th>
              <th style="padding: 0.75rem; text-align: center;">Status</th>
            </tr>
          </thead>
          <tbody>
            ${lotSummaries.map(summary => `
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 0.5rem; font-weight: bold;">${summary.lot.lotNumber}</td>
                <td style="padding: 0.5rem;">${summary.lot.brand}</td>
                <td style="padding: 0.5rem; text-align: center;">${summary.shiftsCount}</td>
                <td style="padding: 0.5rem; text-align: right;">${Utils.formatNumber(summary.totalRawUsed)}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${Utils.formatNumber(summary.totalFinished)}</td>
                <td style="padding: 0.5rem; text-align: right;">${Utils.formatNumber(summary.totalRejects)}</td>
                <td style="padding: 0.5rem; text-align: right; font-weight: bold;">${summary.efficiency}%</td>
                <td style="padding: 0.5rem; text-align: center;"><span class="lot-status ${summary.lot.status.toLowerCase()}">${summary.lot.status}</span></td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid var(--primary);">
              <td style="padding: 0.75rem;" colspan="3">COMBINED TOTALS</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(totalRawUsed)}</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(totalFinished)}</td>
              <td style="padding: 0.75rem; text-align: right;">${Utils.formatNumber(totalRejects)}</td>
              <td style="padding: 0.75rem; text-align: right;">${avgEfficiency}%</td>
              <td style="padding: 0.75rem;"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Footer -->
      <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 0.5rem; text-align: center; border-top: 3px solid var(--primary);">
        <p style="margin: 0; color: var(--primary); font-weight: 600;">Al Jameel MES - Multi-Lot Production Report</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #6c757d;">Generated: ${Utils.formatDateTime(new Date())} | ${lots.length} Lots ‚Ä¢ ${totalShifts} Shifts</p>
      </div>
    </div>
  `;
  
  reportContent.innerHTML = reportHTML;
}

function printLotReport() {
  window.print();
}

function exportLotReportPDF() {
  const reportContent = document.getElementById('lotReportContent');
  if (!reportContent || !reportContent.innerHTML.trim()) {
    Utils.showMessage('reportsMessages', 'Please generate a report first', 'error');
    return;
  }
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Production Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        .lot-status.open { background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 4px; }
        .lot-status.completed { background: #f3f4f6; color: #374151; padding: 4px 8px; border-radius: 4px; }
        .shift-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .shift-badge.day { background: #fef3c7; color: #92400e; }
        .shift-badge.night { background: #e0e7ff; color: #3730a3; }
        table { border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        @media print { body { margin: 0; } @page { margin: 1in; } }
      </style>
    </head>
    <body>
      ${reportContent.innerHTML}
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 250);
}

function exportLotReportExcel() {
  const reportType = document.getElementById('reportType').value;
  let selectedLotIds = [];
  
  if (reportType === 'single') {
    const singleLotId = document.getElementById('reportLotSelect').value;
    if (!singleLotId) {
      Utils.showMessage('reportsMessages', 'Please generate a report first', 'error');
      return;
    }
    selectedLotIds = [singleLotId];
  } else {
    const checkboxes = document.querySelectorAll('#lotCheckboxes input[type="checkbox"]:checked');
    selectedLotIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedLotIds.length === 0) {
      Utils.showMessage('reportsMessages', 'Please generate a report first', 'error');
      return;
    }
  }
  
  try {
    const lots = window.appState.getState('lots') || [];
    const productionRecords = window.appState.getState('productionRecords') || [];
    
    const selectedLots = lots.filter(lot => selectedLotIds.includes(lot.id));
    const allLotRecords = productionRecords.filter(record => selectedLotIds.includes(record.lotId));
    
    const wb = XLSX.utils.book_new();
    
    if (selectedLots.length === 1) {
      // Single lot export
      const selectedLot = selectedLots[0];
      const lotRecords = allLotRecords;
      
      // Lot Summary Sheet
      const summaryData = [
        ['Lot Production Report', ''],
        ['Generated', Utils.formatDateTime(new Date())],
        ['', ''],
        ['Lot Information', ''],
        ['Lot Number', selectedLot.lotNumber],
        ['Brand', selectedLot.brand],
        ['Total Containers', selectedLot.totalContainers],
        ['Bags per Container', selectedLot.bagsPerContainer],
        ['Kg per Bag', selectedLot.kgPerBag],
        ['Total Raw Quantity (kg)', selectedLot.totalRawQuantity],
        ['Status', selectedLot.status],
        ['', ''],
        ['Production Summary', ''],
        ['Total Shifts', lotRecords.length],
        ['Raw Used (kg)', lotRecords.reduce((sum, r) => sum + (r.rawInputShift || 0), 0)],
        ['Finished (kg)', lotRecords.reduce((sum, r) => sum + (r.finishedKg || 0), 0)],
        ['Rejects (kg)', lotRecords.reduce((sum, r) => sum + (r.rejectsKg || 0), 0)]
      ];
      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWs, 'Lot Summary');
      
      // Production Details Sheet
      if (lotRecords.length > 0) {
        const detailsData = [
          ['Date', 'Shift', 'Raw Input (kg)', '18-21 Size (kg)', '21-25 Size (kg)', 'Finished (kg)', 'Rejects (kg)', 'Efficiency (%)', 'Yield (%)'],
          ...lotRecords.map(record => [
            Utils.formatDate(record.productionDate),
            record.shift,
            record.rawInputShift,
            record.kg1821,
            record.kg2125,
            record.finishedKg,
            record.rejectsKg,
            record.efficiency,
            record.yield
          ])
        ];
        const detailsWs = XLSX.utils.aoa_to_sheet(detailsData);
        XLSX.utils.book_append_sheet(wb, detailsWs, 'Production Details');
      }
      
      XLSX.writeFile(wb, `lot_report_${selectedLot.lotNumber}_${new Date().toISOString().split('T')[0]}.xlsx`);
      
    } else {
      // Multi-lot export
      const totalRawUsed = allLotRecords.reduce((sum, r) => sum + (r.rawInputShift || 0), 0);
      const totalFinished = allLotRecords.reduce((sum, r) => sum + (r.finishedKg || 0), 0);
      const totalRejects = allLotRecords.reduce((sum, r) => sum + (r.rejectsKg || 0), 0);
      
      // Combined Summary Sheet
      const combinedData = [
        ['Multi-Lot Production Report', ''],
        ['Generated', Utils.formatDateTime(new Date())],
        ['Total Lots', selectedLots.length],
        ['Total Shifts', allLotRecords.length],
        ['', ''],
        ['Combined Totals', ''],
        ['Raw Used (kg)', totalRawUsed],
        ['Finished (kg)', totalFinished],
        ['Rejects (kg)', totalRejects],
        ['Average Efficiency (%)', totalRawUsed > 0 ? Math.round((totalFinished / totalRawUsed) * 100) : 0],
        ['', ''],
        ['Lot Comparison', ''],
        ['Lot Number', 'Brand', 'Shifts', 'Raw Used', 'Finished', 'Efficiency'],
        ...selectedLots.map(lot => {
          const lotRecords = allLotRecords.filter(r => r.lotId === lot.id);
          const lotRawUsed = lotRecords.reduce((sum, r) => sum + (r.rawInputShift || 0), 0);
          const lotFinished = lotRecords.reduce((sum, r) => sum + (r.finishedKg || 0), 0);
          const lotEfficiency = lotRawUsed > 0 ? Math.round((lotFinished / lotRawUsed) * 100) : 0;
          
          return [lot.lotNumber, lot.brand, lotRecords.length, lotRawUsed, lotFinished, lotEfficiency];
        })
      ];
      const combinedWs = XLSX.utils.aoa_to_sheet(combinedData);
      XLSX.utils.book_append_sheet(wb, combinedWs, 'Combined Summary');
      
      // All Production Details Sheet
      if (allLotRecords.length > 0) {
        const allDetailsData = [
          ['Date', 'Lot Number', 'Brand', 'Shift', 'Raw Input (kg)', '18-21 Size (kg)', '21-25 Size (kg)', 'Finished (kg)', 'Rejects (kg)', 'Efficiency (%)', 'Yield (%)'],
          ...allLotRecords.map(record => [
            Utils.formatDate(record.productionDate),
            record.lotNumber,
            record.brand,
            record.shift,
            record.rawInputShift,
            record.kg1821,
            record.kg2125,
            record.finishedKg,
            record.rejectsKg,
            record.efficiency,
            record.yield
          ])
        ];
        const allDetailsWs = XLSX.utils.aoa_to_sheet(allDetailsData);
        XLSX.utils.book_append_sheet(wb, allDetailsWs, 'All Production Details');
      }
      
      XLSX.writeFile(wb, `multi_lot_report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    
    Utils.showMessage('reportsMessages', 'Excel report exported successfully!', 'success');
    
  } catch (error) {
    console.error('Excel export error:', error);
    Utils.showMessage('reportsMessages', 'Error exporting Excel file', 'error');
  }
}

// Inventory Functions
function renderInventory() {
  const currentInventory = window.appState.getState('currentInventory') || {};
  
  const inventoryElements = {
    invVacuumBags: currentInventory.vacuumBags || 0,
    invGoldenHillBoxes: currentInventory.goldenHillBoxes || 0,
    invExtraBoxes: currentInventory.extraBoxes || 0
  };
  
  Object.entries(inventoryElements).forEach(([id, value]) => {
    const element = document.getElementById(id);
    if (element) element.textContent = Utils.formatNumber(value);
  });
}

function adjustInventory() {
  const btn = document.getElementById('adjustInventoryBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span> Updating...';
  
  try {
    const item = document.getElementById('invItem').value;
    const action = document.getElementById('invAction').value;
    const quantity = Utils.sanitizeInput(document.getElementById('invQuantity').value, 'integer');
    const notes = Utils.sanitizeInput(document.getElementById('invNotes').value, 'text');
    
    if (!item) {
      Utils.showMessage('inventoryMessages', 'Please select an item', 'error');
      return;
    }
    
    if (!action) {
      Utils.showMessage('inventoryMessages', 'Please select an action', 'error');
      return;
    }
    
    if (!Utils.validateNumberRange(quantity, 0, 100000)) {
      Utils.showMessage('inventoryMessages', 'Quantity must be between 0 and 100,000', 'error');
      return;
    }
    
    if (quantity === 0 && action !== 'set') {
      Utils.showMessage('inventoryMessages', 'Please enter a valid quantity', 'error');
      return;
    }
    
    const result = window.appState.updateInventory(item, action, quantity);
    
    if (result.success) {
      document.getElementById('invQuantity').value = '0';
      document.getElementById('invNotes').value = '';
      document.getElementById('invItem').value = '';
      document.getElementById('invAction').value = '';
      
      const itemNames = {
        vacuumBags: 'Vacuum Bags',
        goldenHillBoxes: 'Golden Hill Boxes',
        extraBoxes: 'Extra Boxes'
      };
      
      Utils.showMessage('inventoryMessages', 
        `${itemNames[item]} inventory updated successfully! New quantity: ${Utils.formatNumber(result.newValue)}`, 'success');
    } else {
      Utils.showMessage('inventoryMessages', result.error, 'error');
    }
    
  } finally {
    btn.disabled = false;
    btn.textContent = 'Update Inventory';
  }
}

function exportInventoryExcel() {
  try {
    const inventoryLog = window.appState.getState('inventoryLog') || [];
    const currentInventory = window.appState.getState('currentInventory') || {};
    
    const wb = XLSX.utils.book_new();
    
    // Current Stock Sheet
    const stockData = [
      ['Al Jameel MES - Inventory Report', ''],
      ['Generated', Utils.formatDateTime(new Date())],
      ['', ''],
      ['Current Stock Levels', ''],
      ['Item', 'Current Quantity'],
      ['Vacuum Bags (10kg)', currentInventory.vacuumBags || 0],
      ['Golden Hill Boxes', currentInventory.goldenHillBoxes || 0],
      ['Extra Boxes', currentInventory.extraBoxes || 0]
    ];
    const stockWs = XLSX.utils.aoa_to_sheet(stockData);
    XLSX.utils.book_append_sheet(wb, stockWs, 'Current Stock');
    
    // Inventory Log Sheet (if exists)
    if (inventoryLog.length > 0) {
      const logData = [
        ['Timestamp', 'Item', 'Action', 'Quantity', 'Previous Value', 'New Value', 'User'],
        ...inventoryLog.slice(-100).map(log => [
          Utils.formatDateTime(log.timestamp),
          log.item,
          log.action,
          log.quantity,
          log.previousValue || 0,
          log.newValue || 0,
          log.user || 'Unknown'
        ])
      ];
      const logWs = XLSX.utils.aoa_to_sheet(logData);
      XLSX.utils.book_append_sheet(wb, logWs, 'Inventory Log');
    }
    
    XLSX.writeFile(wb, `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`);
    Utils.showMessage('inventoryMessages', 'Inventory Excel report exported successfully!', 'success');
    
  } catch (error) {
    console.error('Inventory Excel export error:', error);
    Utils.showMessage('inventoryMessages', 'Error exporting inventory Excel file', 'error');
  }
}

function exportInventoryPDF() {
  try {
    const inventoryLog = window.appState.getState('inventoryLog') || [];
    const currentInventory = window.appState.getState('currentInventory') || {};
    
    const pdfContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Inventory Report</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #a32034; padding-bottom: 10px; }
          .stock-summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
          .stock-card { padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; }
          .stock-value { font-size: 24px; font-weight: bold; color: #a32034; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
          th { background-color: #a32034; color: white; }
          @media print { body { margin: 0; } }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>Al Jameel MES - Inventory Report</h1>
          <p>Generated: ${Utils.formatDateTime(new Date())}</p>
        </div>
        
        <h2>Current Stock Levels</h2>
        <div class="stock-summary">
          <div class="stock-card">
            <div class="stock-value">${Utils.formatNumber(currentInventory.vacuumBags || 0)}</div>
            <div>Vacuum Bags (10kg)</div>
          </div>
          <div class="stock-card">
            <div class="stock-value">${Utils.formatNumber(currentInventory.goldenHillBoxes || 0)}</div>
            <div>Golden Hill Boxes</div>
          </div>
          <div class="stock-card">
            <div class="stock-value">${Utils.formatNumber(currentInventory.extraBoxes || 0)}</div>
            <div>Extra Boxes</div>
          </div>
        </div>
        
        ${inventoryLog.length > 0 ? `
        <h2>Recent Inventory Movements (Last 20)</h2>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Item</th>
              <th>Action</th>
              <th>Quantity</th>
              <th>New Value</th>
              <th>User</th>
            </tr>
          </thead>
          <tbody>
            ${inventoryLog.slice(-20).reverse().map(log => `
              <tr>
                <td>${Utils.formatDate(log.timestamp)}</td>
                <td>${log.item}</td>
                <td>${log.action}</td>
                <td>${Utils.formatNumber(log.quantity)}</td>
                <td>${Utils.formatNumber(log.newValue || 0)}</td>
                <td>${log.user || 'Unknown'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        ` : '<p style="text-align: center; color: #666; margin: 2rem 0;">No inventory movements recorded yet.</p>'}
      </body>
      </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(pdfContent);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => printWindow.print(), 250);
    
    Utils.showMessage('inventoryMessages', 'Inventory PDF report opened for printing', 'success');
    
  } catch (error) {
    console.error('Inventory PDF export error:', error);
    Utils.showMessage('inventoryMessages', 'Error generating inventory PDF', 'error');
  }
}

// Initialize app when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('productionDate').value = today;
  
  // Subscribe to state changes
  window.appState.subscribe('lots', renderLots);
  window.appState.subscribe('productionRecords', renderRecords);
  window.appState.subscribe('currentInventory', renderInventory);
  
  // Initialize calculations
  calculateLotTotals();
  updateProductionSummary();
  
  console.log('Pistachio MES System initialized successfully');
});

// Add some CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
  }
`;
document.head.appendChild(style);
</script>

</body>
</html>
