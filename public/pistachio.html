<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pistachio Production ‚Äì Al Jameel MES</title>
  <style>
    :root {
      --primary: #a32034;
      --accent: #d5a333;
      --text: #2f2a28;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 1.5rem; }
    .back-link { 
      color: white; 
      text-decoration: none; 
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-right: 1rem;
    }

    /* Pistachio icon styling */
    .pistachio-brand-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 0.75rem;
      vertical-align: middle;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    .nav-btn:hover { opacity: 0.9; }
    .nav-btn.active { background: var(--accent); color: var(--text); }

    .section {
      display: none;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section.active { display: block; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      text-align: center;
      border: 2px solid var(--accent);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    input, select {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover { opacity: 0.9; }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--primary);
      color: white;
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
    }

    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .summary-box {
      background: #fff7e6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      border: 1px solid #f5e1a8;
      font-weight: 600;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .materials-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }

    /* Section header with pistachio image */
    .section-header-with-image {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header-with-image img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-right: 1rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <a href="./index.html" style="position: absolute; top: 20px; left: 20px; color: var(--primary); text-decoration: none; z-index: 10;">‚Üê Back to MES</a>
  <div class="login-form">
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <img src="src/assets/icons/pistachio.png" alt="Pistachio" style="width: 64px; height: 64px; margin-bottom: 1rem;" onerror="this.outerHTML='ü•ú'">
      <h2 style="color: var(--primary); margin: 0;">Pistachio Production Login</h2>
    </div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Username</label>
        <input id="loginUsername" type="text" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input id="loginPassword" type="password" required>
      </div>
      <button type="submit" style="width: 100%; margin-top: 1rem;">Login</button>
    </form>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
      <p><strong>Demo Credentials:</strong></p>
      <p>Admin: admin / admin123</p>
      <p>Operator: operator / op123</p>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display: none;">
  <header class="header">
    <div style="display: flex; align-items: center;">
      <a href="./index.html" class="back-link">‚Üê Back to MES</a>
      <img src="src/assets/icons/pistachio.png" alt="Pistachio" class="pistachio-brand-icon" onerror="this.outerHTML='ü•ú '">
      <h1>Pistachio Production Management</h1>
    </div>
    <div>
      <span id="userDisplay">User</span>
      <button onclick="logout()" style="margin-left: 1rem; background: rgba(255,255,255,0.2);">
        Logout
      </button>
    </div>
  </header>

  <div class="container">
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="showSection('production')">New Production</button>
      <button class="nav-btn" onclick="showSection('records')">View Records</button>
      <button class="nav-btn" onclick="showSection('inventory')">Inventory</button>
    </div>

    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>Production Dashboard</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div>Total Produced (kg)</div>
          <div class="stat-value" id="kpiFinished">0</div>
        </div>
        <div class="stat-card">
          <div>Efficiency (%)</div>
          <div class="stat-value" id="kpiEff">0</div>
        </div>
        <div class="stat-card">
          <div>Reject Rate (%)</div>
          <div class="stat-value" id="kpiReject">0.0</div>
        </div>
      </div>
      <p>KPIs update automatically when you submit production records.</p>
    </section>

    <!-- Production Entry Section -->
    <section id="production" class="section">
      <div class="section-header-with-image">
        <img src="src/assets/icons/pistachio.png" alt="Pistachio" onerror="this.outerHTML='ü•ú '">
        <h2>New Production Entry</h2>
      </div>
      
      <div class="warning-box">
        <strong>Note:</strong> Huller Run shows rejects section, Repacking Only hides it.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Run Type</label>
          <select id="runType" onchange="updateFormVisibility()">
            <option value="huller">Huller Run</option>
            <option value="repack">Repacking Only</option>
          </select>
        </div>
        <div class="form-group">
          <label>Brand</label>
          <select id="brand" onchange="updateInventoryDisplay()">
            <option>Golden Hill</option>
            <option>Extra</option>
          </select>
        </div>
        <div class="form-group" id="sizeGroup">
          <label>Size</label>
          <select id="size">
            <option>18-21</option>
            <option>21-25</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lot Number</label>
          <input id="lotNo" type="text" placeholder="e.g., GH-240315-01">
        </div>
        <div class="form-group">
          <label>Raw Input (kg)</label>
          <input id="rawInput" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
      </div>

      <!-- Final Goods -->
      <h3>Final Goods Output</h3>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="form-group">
          <label>18-21 Size (kg)</label>
          <input id="bags1821" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
        <div class="form-group">
          <label>21-25 Size (kg)</label>
          <input id="bags2125" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
      </div>

      <!-- Materials -->
      <div class="materials-section">
        <h3>Materials Usage</h3>
        <div id="inventoryStatus" style="background: #e3f2fd; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem;">
          <strong>Current Stock:</strong> 
          <span id="currentBags">0</span> vacuum bags, 
          <span id="currentGoldenBoxes">0</span> Golden Hill boxes, 
          <span id="currentExtraBoxes">0</span> Extra boxes
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Vacuum Bags Used</label>
            <input id="bagsUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Used</label>
            <input id="boxesUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Vacuum Bags Wasted</label>
            <input id="bagsWasted" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Packing Boxes Wasted</label>
            <input id="boxesWasted" type="number" min="0" step="1" value="0">
          </div>
        </div>
      </div>

      <!-- Rejects (shown only for Huller Run) -->
      <div id="rejectsSection" class="materials-section">
        <h3>Rejects (kg) - Huller Run Only</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Non-Split (Closed)</label>
            <input id="rejNonSplit" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Light Stain</label>
            <input id="rejLightStain" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Adhering Hull</label>
            <input id="rejAdheringHull" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Dark Stain</label>
            <input id="rejDarkStain" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Shell & Split</label>
            <input id="rejShellSplit" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Undersize & Kernel</label>
            <input id="rejUndersize" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Loose Shell</label>
            <input id="rejLooseShell" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Loose Kernel</label>
            <input id="rejLooseKernel" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
          <div class="form-group">
            <label>Dust</label>
            <input id="rejDust" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <button onclick="submitProduction()">Submit Production</button>
        <button class="btn-secondary" onclick="clearForm()">Clear Form</button>
      </div>

      <div class="summary-box" id="productionSummary">
        Finished: 0 kg ‚Ä¢ Rejects: 0 kg ‚Ä¢ Efficiency: 0% ‚Ä¢ Reject Rate: 0%
      </div>
    </section>

    <!-- Records Section -->
    <section id="records" class="section">
      <h2 style="margin-bottom: 1rem;">üìã Production Records</h2>
      <div style="overflow-x: auto;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Run Type</th>
              <th>Brand</th>
              <th>Size</th>
              <th>Lot</th>
              <th>Raw Input (kg)</th>
              <th>Final Bags</th>
              <th>Finished (kg)</th>
              <th>Rejects (kg)</th>
              <th>Efficiency (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Inventory Section -->
    <section id="inventory" class="section">
      <h2 style="margin-bottom: 1rem;">üì¶ Inventory Management</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Vacuum Bags (10kg)</div>
          <div class="stat-value" id="invVacuumBags">0</div>
        </div>
        <div class="stat-card">
          <div>Golden Hill Boxes</div>
          <div class="stat-value" id="invGoldenHillBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Extra Boxes</div>
          <div class="stat-value" id="invExtraBoxes">0</div>
        </div>
      </div>

      <div class="materials-section">
        <h3>Stock Adjustment</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Item</label>
            <select id="invItem">
              <option value="vacuumBags">Vacuum Bags (10kg)</option>
              <option value="goldenHillBoxes">Golden Hill Boxes</option>
              <option value="extraBoxes">Extra Boxes</option>
            </select>
          </div>
          <div class="form-group">
            <label>Action</label>
            <select id="invAction">
              <option value="add">Add Stock</option>
              <option value="remove">Remove Stock</option>
              <option value="set">Set Exact Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input id="invQuantity" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input id="invNotes" type="text" placeholder="Reason for adjustment">
          </div>
        </div>
        <button onclick="adjustInventory()">Update Inventory</button>
      </div>

      <h3>Stock Movement Log</h3>
      <div style="overflow-x: auto;">
        <table id="inventoryTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Item</th>
              <th>Action</th>
              <th>Quantity</th>
              <th>Result</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script>
// Data storage (in-memory)
let productionRecords = [];
let inventoryLog = [];
let currentInventory = {
  vacuumBags: 0,
  goldenHillBoxes: 0,
  extraBoxes: 0
};

// User management
const users = { admin: 'admin123', operator: 'op123' };
let currentUser = null;

// Login handling
function handleLogin(event) {
  event.preventDefault();
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  
  if (users[username] && users[username] === password) {
    currentUser = username;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userDisplay').textContent = username;
    updateDashboard();
    renderRecords();
    renderInventory();
  } else {
    alert('Invalid credentials');
  }
}

function logout() {
  currentUser = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

// Navigation
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.getElementById(sectionId).classList.add('active');
  event.target.classList.add('active');
}

// Form handling
function updateFormVisibility() {
  const runType = document.getElementById('runType').value;
  const sizeGroup = document.getElementById('sizeGroup');
  const rejectsSection = document.getElementById('rejectsSection');
  
  if (runType === 'huller') {
    sizeGroup.style.display = 'none';
    rejectsSection.style.display = 'block';
  } else {
    sizeGroup.style.display = 'block';
    rejectsSection.style.display = 'none';
  }
  updateSummary();
}

function updateInventoryDisplay() {
  renderInventory();
}

function updateSummary() {
  const kg1821 = parseInt(document.getElementById('bags1821').value) || 0;
  const kg2125 = parseInt(document.getElementById('bags2125').value) || 0;
  const finishedKg = kg1821 + kg2125;
  
  const runType = document.getElementById('runType').value;
  let rejectsKg = 0;
  
  if (runType === 'huller') {
    const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                      'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
    rejectsKg = rejectIds.reduce((sum, id) => {
      return sum + (parseInt(document.getElementById(id).value) || 0);
    }, 0);
  }
  
  const rawInput = parseInt(document.getElementById('rawInput').value) || 0;
  const totalInput = rawInput > 0 ? rawInput : finishedKg + rejectsKg;
  
  const efficiency = totalInput > 0 ? Math.round((finishedKg / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((rejectsKg / totalInput) * 1000) / 10 : 0;
  
  document.getElementById('productionSummary').textContent = 
    `Finished: ${finishedKg} kg ‚Ä¢ Rejects: ${rejectsKg} kg ‚Ä¢ Efficiency: ${efficiency}% ‚Ä¢ Reject Rate: ${rejectRate}%`;
}

function clearForm() {
  document.querySelectorAll('#production input[type="number"]').forEach(input => {
    input.value = 0;
  });
  document.getElementById('lotNo').value = '';
  updateSummary();
}

function submitProduction() {
  const bags1821 = parseInt(document.getElementById('bags1821').value) || 0;
  const bags2125 = parseInt(document.getElementById('bags2125').value) || 0;
  const totalBags = bags1821 + bags2125;
  
  if (totalBags === 0) {
    alert('Please enter final goods quantities');
    return;
  }
  
  // Get the brand to determine which box type to use
  const brand = document.getElementById('brand').value;
  const boxType = brand === 'Golden Hill' ? 'goldenHillBoxes' : 'extraBoxes';
  
  // Inventory validation
  const bagsUsed = parseInt(document.getElementById('bagsUsed').value) || 0;
  const boxesUsed = parseInt(document.getElementById('boxesUsed').value) || 0;
  const bagsWasted = parseInt(document.getElementById('bagsWasted').value) || 0;
  const boxesWasted = parseInt(document.getElementById('boxesWasted').value) || 0;
  
  const totalBagsNeeded = bagsUsed + bagsWasted;
  const totalBoxesNeeded = boxesUsed + boxesWasted;
  
  // Check if sufficient inventory exists
  if (totalBagsNeeded > currentInventory.vacuumBags) {
    alert(`Insufficient vacuum bags! Required: ${totalBagsNeeded}, Available: ${currentInventory.vacuumBags}`);
    return;
  }
  
  if (totalBoxesNeeded > currentInventory[boxType]) {
    const boxTypeName = brand === 'Golden Hill' ? 'Golden Hill boxes' : 'Extra boxes';
    alert(`Insufficient ${boxTypeName}! Required: ${totalBoxesNeeded}, Available: ${currentInventory[boxType]}`);
    return;
  }
  
  const runType = document.getElementById('runType').value;
  const finishedKg = totalBags;
  
  let rejectsKg = 0;
  if (runType === 'huller') {
    const rejectIds = ['rejNonSplit', 'rejLightStain', 'rejAdheringHull', 'rejDarkStain', 
                      'rejShellSplit', 'rejUndersize', 'rejLooseShell', 'rejLooseKernel', 'rejDust'];
    rejectsKg = rejectIds.reduce((sum, id) => {
      return sum + (parseInt(document.getElementById(id).value) || 0);
    }, 0);
  }
  
  const rawInput = parseInt(document.getElementById('rawInput').value) || 0;
  const totalInput = rawInput > 0 ? rawInput : finishedKg + rejectsKg;
  const efficiency = totalInput > 0 ? Math.round((finishedKg / totalInput) * 100) : 0;
  
  const record = {
    timestamp: new Date().toISOString(),
    runType,
    brand: brand,
    size: document.getElementById('size').value,
    lot: document.getElementById('lotNo').value,
    rawInput,
    kg1821: bags1821,
    kg2125: bags2125,
    totalKg: totalBags,
    finishedKg,
    rejectsKg,
    efficiency,
    materials: {
      bagsUsed: bagsUsed,
      boxesUsed: boxesUsed,
      bagsWasted: bagsWasted,
      boxesWasted: boxesWasted
    }
  };
  
  productionRecords.push(record);
  
  // Update inventory (we already validated sufficient stock exists)
  const totalBagsUsed = record.materials.bagsUsed + record.materials.bagsWasted;
  const totalBoxesUsed = record.materials.boxesUsed + record.materials.boxesWasted;

  currentInventory.vacuumBags -= totalBagsUsed;
  currentInventory[boxType] -= totalBoxesUsed;
  
  // Log vacuum bags usage and waste separately
if (record.materials.bagsUsed > 0) {
  inventoryLog.push({
    timestamp: new Date().toISOString(),
    item: 'Vacuum Bags (10kg)',
    action: 'remove',
    quantity: record.materials.bagsUsed,
    result: currentInventory.vacuumBags + record.materials.bagsWasted, // Before waste deduction
    notes: 'Production: Used'
  });
}

if (record.materials.bagsWasted > 0) {
  inventoryLog.push({
    timestamp: new Date().toISOString(),
    item: 'Vacuum Bags (10kg)',
    action: 'remove',
    quantity: record.materials.bagsWasted,
    result: currentInventory.vacuumBags,
    notes: 'Production: Wasted'
  });
}

// Log boxes usage and waste separately
const boxTypeName = brand === 'Golden Hill' ? 'Golden Hill Boxes' : 'Extra Boxes';

if (record.materials.boxesUsed > 0) {
  inventoryLog.push({
    timestamp: new Date().toISOString(),
    item: boxTypeName,
    action: 'remove',
    quantity: record.materials.boxesUsed,
    result: currentInventory[boxType] + record.materials.boxesWasted, // Before waste deduction
    notes: 'Production: Used'
  });
}

if (record.materials.boxesWasted > 0) {
  inventoryLog.push({
    timestamp: new Date().toISOString(),
    item: boxTypeName,
    action: 'remove',
    quantity: record.materials.boxesWasted,
    result: currentInventory[boxType],
    notes: 'Production: Wasted'
  });
}
  
  alert('Production record submitted successfully!');
  clearForm();
  updateDashboard();
  renderRecords();
  renderInventory();
}

// Dashboard updates
function updateDashboard() {
  let totalFinished = 0;
  let totalRejects = 0;
  let totalInput = 0;
  
  productionRecords.forEach(record => {
    totalFinished += record.finishedKg;
    totalRejects += record.rejectsKg;
    totalInput += record.rawInput || (record.finishedKg + record.rejectsKg);
  });
  
  const efficiency = totalInput > 0 ? Math.round((totalFinished / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((totalRejects / totalInput) * 1000) / 10 : 0;
  
  document.getElementById('kpiFinished').textContent = totalFinished;
  document.getElementById('kpiEff').textContent = efficiency;
  document.getElementById('kpiReject').textContent = rejectRate.toFixed(1);
}

// Records rendering
function renderRecords() {
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(record.timestamp).toLocaleString()}</td>
      <td>${record.runType}</td>
      <td>${record.brand}</td>
      <td>${record.size}</td>
      <td>${record.lot}</td>
      <td>${record.rawInput}</td>
      <td>${record.totalKg || record.totalBags}</td>
      <td>${record.finishedKg}</td>
      <td>${record.rejectsKg}</td>
      <td>${record.efficiency}%</td>
    `;
    tbody.appendChild(row);
  });
}

// Inventory management
function adjustInventory() {
  const item = document.getElementById('invItem').value;
  const action = document.getElementById('invAction').value;
  const quantity = parseInt(document.getElementById('invQuantity').value) || 0;
  const notes = document.getElementById('invNotes').value;
  
  if (quantity <= 0 && action !== 'set') {
    alert('Please enter a valid quantity');
    return;
  }
  
  let itemName;
  if (item === 'vacuumBags') itemName = 'Vacuum Bags (10kg)';
  else if (item === 'goldenHillBoxes') itemName = 'Golden Hill Boxes';
  else if (item === 'extraBoxes') itemName = 'Extra Boxes';
  
  let result = 0;
  
  if (action === 'add') {
    currentInventory[item] += quantity;
    result = currentInventory[item];
  } else if (action === 'remove') {
    currentInventory[item] = Math.max(0, currentInventory[item] - quantity);
    result = currentInventory[item];
  } else if (action === 'set') {
    currentInventory[item] = Math.max(0, quantity);
    result = currentInventory[item];
  }
  
  inventoryLog.push({
    timestamp: new Date().toISOString(),
    item: itemName,
    action,
    quantity,
    result,
    notes
  });
  
  document.getElementById('invQuantity').value = 0;
  document.getElementById('invNotes').value = '';
  
  renderInventory();
}

function renderInventory() {
  document.getElementById('invVacuumBags').textContent = currentInventory.vacuumBags;
  document.getElementById('invGoldenHillBoxes').textContent = currentInventory.goldenHillBoxes;
  document.getElementById('invExtraBoxes').textContent = currentInventory.extraBoxes;
  
  // Update the production form display too
  if (document.getElementById('currentBags')) {
    document.getElementById('currentBags').textContent = currentInventory.vacuumBags;
    document.getElementById('currentGoldenBoxes').textContent = currentInventory.goldenHillBoxes;
    document.getElementById('currentExtraBoxes').textContent = currentInventory.extraBoxes;
  }
  
  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML = '';
  
  inventoryLog.slice().reverse().forEach(log => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(log.timestamp).toLocaleString()}</td>
      <td>${log.item}</td>
      <td>${log.action}</td>
      <td>${log.quantity}</td>
      <td>${log.result}</td>
      <td>${log.notes}</td>
    `;
    tbody.appendChild(row);
  });
}

// Initialize
window.addEventListener('load', () => {
  updateFormVisibility();
  updateSummary();
  renderInventory();
});
</script>

</body>
</html>
