<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Walnut Production ‚Äì Al Jameel MES</title>
  <style>
    :root {
      --primary: #8B4513;     /* Walnut brown */
      --accent: #D2B48C;      /* Tan */
      --text: #2f2a28;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --border: #e5e7eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 1.5rem; }
    .back-link { 
      color: white; 
      text-decoration: none; 
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-right: 1rem;
    }

    /* Walnut icon styling */
    .walnut-brand-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 0.75rem;
      vertical-align: middle;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    .nav-btn:hover { opacity: 0.9; }
    .nav-btn.active { background: var(--accent); color: var(--text); }

    .section {
      display: none;
      background: var(--surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section.active { display: block; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      text-align: center;
      border: 2px solid var(--accent);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    input, select {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover { opacity: 0.9; }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--primary);
      color: white;
    }

    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
    }

    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }

    .summary-box {
      background: #fff7e6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      border: 1px solid #f5e1a8;
      font-weight: 600;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .materials-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }

    /* Section header with walnut image */
    .section-header-with-image {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header-with-image img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-right: 1rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    /* Metrics grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .metric-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1.5rem;
      border-radius: 0.5rem;
      text-align: center;
      border: 1px solid #dee2e6;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .metric-label {
      font-size: 0.9rem;
      color: #6c757d;
      font-weight: 500;
    }

    /* Professional Chart Styling */
    .chart-container {
      margin: 2rem 0;
      padding: 1.5rem;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 2rem 0;
    }

    .pie-chart-container {
      text-align: center;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }

    .bar-chart-container {
      padding: 1rem;
    }

    .bar-item {
      margin-bottom: 1rem;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }

    .bar-track {
      background: #e9ecef;
      height: 24px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      border-radius: 12px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 0.5rem;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }

    /* Print-specific styles */
    @media print {
      .chart-container {
        box-shadow: none;
        border: 1px solid #ddd;
      }
      
      .chart-grid {
        page-break-inside: avoid;
      }
      
      .pie-chart-container,
      .bar-chart-container {
        page-break-inside: avoid;
      }
    }

    /* Export button styling */
    .export-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .export-btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 0.375rem;
    }

    .export-btn-pdf {
      background: #dc2626;
      color: white;
    }

    .export-btn-excel {
      background: #059669;
      color: white;
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <a href="./index.html" style="position: absolute; top: 20px; left: 20px; color: var(--primary); text-decoration: none; z-index: 10;">‚Üê Back to MES</a>
  <div class="login-form">
    <div style="text-align: center; margin-bottom: 1.5rem;">
      <img src="src/assets/icons/Walnut.png" alt="Walnut" style="width: 64px; height: 64px; margin-bottom: 1rem;" onerror="this.outerHTML='üå∞'">
      <h2 style="color: var(--primary); margin: 0;">Walnut Production Login</h2>
    </div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>Username</label>
        <input id="loginUsername" type="text" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input id="loginPassword" type="password" required>
      </div>
      <button type="submit" style="width: 100%; margin-top: 1rem;">Login</button>
    </form>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem;">
      <p><strong>Demo Credentials:</strong></p>
      <p>Admin: admin / admin123</p>
      <p>Operator: operator / op123</p>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display: none;">
  <header class="header">
    <div style="display: flex; align-items: center;">
      <a href="./index.html" class="back-link">‚Üê Back to MES</a>
      <img src="src/assets/icons/Walnut.png" alt="Walnut" class="walnut-brand-icon" onerror="this.outerHTML='üå∞ '">
      <h1>Walnut Production Management</h1>
    </div>
    <div>
      <span id="userDisplay">User</span>
      <button onclick="logout()" style="margin-left: 1rem; background: rgba(255,255,255,0.2);">
        Logout
      </button>
    </div>
  </header>

  <div class="container">
   <div class="nav-buttons">
  <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="showSection('production')">New Production</button>
  <button class="nav-btn" onclick="showSection('records')">View Records</button>
  <button class="nav-btn" onclick="showSection('inventory')">Inventory</button>
  <button class="nav-btn" onclick="showSection('maintenance')">Maintenance</button>
  <button class="nav-btn" onclick="showSection('reports')">Reports</button>
  <button class="nav-btn" id="itemPricesBtn" onclick="showSection('itemprices')" style="display: none;">Item Prices</button>
</div>

    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <div class="section-header-with-image">
        <img src="src/assets/icons/Walnut.png" alt="Walnut" onerror="this.outerHTML='üå∞ '">
        <h2>Production Dashboard</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div>Total Finished (kg)</div>
          <div class="stat-value" id="kpiFinished">0</div>
        </div>
        <div class="stat-card">
          <div>Efficiency (%)</div>
          <div class="stat-value" id="kpiEff">0</div>
        </div>
        <div class="stat-card">
          <div>Reject Rate (%)</div>
          <div class="stat-value" id="kpiReject">0.0</div>
        </div>
      </div>
      <p>KPIs update automatically when you submit production records.</p>
    </section>

    <!-- Production Entry Section -->
    <section id="production" class="section">
      <div class="section-header-with-image">
        <img src="src/assets/icons/Walnut.png" alt="Walnut" onerror="this.outerHTML='üå∞ '">
        <h2>New Production Entry</h2>
      </div>
      
      <div class="warning-box">
        <strong>Note:</strong> Enter production details for the current shift.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Brand</label>
          <select id="brand" onchange="updateProductOptions()">
            <option>Al Jameel</option>
            <option>Abu Taj</option>
          </select>
        </div>
        <div class="form-group">
          <label>Raw Material Type</label>
          <select id="rawMaterialType">
            <option>Walnut Inshell</option>
          </select>
        </div>
        <div class="form-group">
          <label>Raw Material Supplier</label>
          <select id="supplier" onchange="updateRawFormat()">
            <option>USA</option>
            <option>China</option>
          </select>
        </div>
        <div class="form-group">
          <label>Raw Material Format</label>
          <select id="rawFormat">
            <option value="big_bag">Big Bag (454.5 kg)</option>
            <option value="bag25">25 kg Bag</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lot Number</label>
          <input id="lotNo" type="text" placeholder="e.g., WN-240315-01">
        </div>
        <div class="form-group">
          <label>Raw Input (kg)</label>
          <input id="rawInput" type="number" min="0" step="1" value="0" onchange="updateSummary()">
        </div>
      </div>

      <!-- Product Type Outputs -->
      <h3>Product Type Outputs (kg)</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Half Kernel (kg)</label>
          <input id="halfKernel" type="number" min="0" step="0.1" value="0" onchange="updateSummary()">
        </div>
        <div class="form-group">
          <label>Quarter (kg)</label>
          <input id="quarter" type="number" min="0" step="0.1" value="0" onchange="updateSummary()">
        </div>
        <div class="form-group">
          <label>Large Pieces (kg)</label>
          <input id="largePieces" type="number" min="0" step="0.1" value="0" onchange="updateSummary()">
        </div>
        <div class="form-group">
          <label>Amber (kg)</label>
          <input id="amber" type="number" min="0" step="0.1" value="0" onchange="updateSummary()">
        </div>
      </div>

      <!-- Packaging Output -->
      <h3>Packaging Output</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>5kg Pouches</label>
          <input id="pouches5kg" type="number" min="0" step="1" value="0">
        </div>
        <div class="form-group">
          <label>10kg Pouches</label>
          <input id="pouches10kg" type="number" min="0" step="1" value="0">
        </div>
      </div>

      <!-- Materials -->
      <div class="materials-section">
        <h3>Materials Usage</h3>
        <div id="inventoryStatus" style="background: #e3f2fd; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem;">
          <strong>Current Stock:</strong> 
          <span id="currentPouches5kg">0</span> 5kg pouches, 
          <span id="currentPouches10kg">0</span> 10kg pouches<br>
          <strong>Boxes Available:</strong> 
          <span id="currentHalfKernelBoxes">0</span> Half Kernel, 
          <span id="currentQuarterBoxes">0</span> Quarter, 
          <span id="currentLargePiecesBoxes">0</span> Large Pieces, 
          <span id="currentAmberBoxes">0</span> Amber
        </div>
        
        <!-- Auto-Calculated Box Requirements -->
        <div id="boxCalculations" style="background: #f0f9ff; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem; border-left: 4px solid #0ea5e9;">
          <strong>üì¶ Auto-Calculated Box Requirements (10kg per box):</strong><br>
          <span id="calculatedHalfKernelBoxes">Half Kernel: 0 kg √∑ 10 = 0 boxes</span><br>
          <span id="calculatedQuarterBoxes">Quarter: 0 kg √∑ 10 = 0 boxes</span><br>
          <span id="calculatedLargePiecesBoxes">Large Pieces: 0 kg √∑ 10 = 0 boxes</span><br>
          <span id="calculatedAmberBoxes">Amber: 0 kg √∑ 10 = 0 boxes</span><br>
          <strong style="color: #0ea5e9;">Total Boxes Required: <span id="totalBoxesRequired">0</span></strong>
        </div>
        
        <!-- Pouches Section -->
        <h4>Pouches (Manual Entry)</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>5kg Pouches Used</label>
            <input id="pouches5kgUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>10kg Pouches Used</label>
            <input id="pouches10kgUsed" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>5kg Pouches Wasted</label>
            <input id="pouches5kgWasted" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>10kg Pouches Wasted</label>
            <input id="pouches10kgWasted" type="number" min="0" step="1" value="0">
          </div>
        </div>
        
        <!-- Optional Additional Wastage for Boxes -->
        <h4>Additional Box Wastage (Optional)</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Extra Half Kernel Boxes Wasted</label>
            <input id="halfKernelBoxesWasted" type="number" min="0" step="1" value="0" placeholder="Additional wastage beyond calculated">
          </div>
          <div class="form-group">
            <label>Extra Quarter Boxes Wasted</label>
            <input id="quarterBoxesWasted" type="number" min="0" step="1" value="0" placeholder="Additional wastage beyond calculated">
          </div>
          <div class="form-group">
            <label>Extra Large Pieces Boxes Wasted</label>
            <input id="largePiecesBoxesWasted" type="number" min="0" step="1" value="0" placeholder="Additional wastage beyond calculated">
          </div>
          <div class="form-group">
            <label>Extra Amber Boxes Wasted</label>
            <input id="amberBoxesWasted" type="number" min="0" step="1" value="0" placeholder="Additional wastage beyond calculated">
          </div>
        </div>
      </div>

      <!-- Rejects -->
      <div id="rejectSection" class="materials-section">
        <h3>Rejects (kg)</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Walnut Shell</label>
            <input id="rejWalnutShell" type="number" min="0" step="5" value="0" onchange="updateSummary()">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <button onclick="submitProduction()">Submit Production</button>
        <button class="btn-secondary" onclick="clearForm()">Clear Form</button>
      </div>

      <div class="summary-box" id="productionSummary">
        Finished: 0 kg ‚Ä¢ Rejects: 0 kg ‚Ä¢ Efficiency: 0% ‚Ä¢ Reject Rate: 0%
      </div>
    </section>

    <!-- Records Section -->
    <section id="records" class="section">
      <h2 style="margin-bottom: 1rem;">üìã Production Records</h2>
      <div style="overflow-x: auto;">
        <table id="recordsTable">
         <thead>
  <tr>
    <th>Timestamp</th>
    <th>Brand</th>
    <th>Raw Material</th>
    <th>Lot</th>
    <th>Raw Input (kg)</th>
    <th>Half Kernel (kg)</th>
    <th>Quarter (kg)</th>
    <th>Large Pieces (kg)</th>
    <th>Amber (kg)</th>
    <th>5kg Pouches</th>
    <th>10kg Pouches</th>
    <th>Total Finished (kg)</th>
    <th>Rejects (kg)</th>
    <th>Efficiency (%)</th>
  </tr>
</thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Inventory Section -->
    <section id="inventory" class="section">
      <h2 style="margin-bottom: 1rem;">üì¶ Inventory Management</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Al Jameel 5kg Pouches</div>
          <div class="stat-value" id="invAlJameel5kg">0</div>
        </div>
        <div class="stat-card">
          <div>Al Jameel 10kg Pouches</div>
          <div class="stat-value" id="invAlJameel10kg">0</div>
        </div>
        <div class="stat-card">
          <div>Abu Taj 5kg Pouches</div>
          <div class="stat-value" id="invAbuTaj5kg">0</div>
        </div>
        <div class="stat-card">
          <div>Abu Taj 10kg Pouches</div>
          <div class="stat-value" id="invAbuTaj10kg">0</div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Al Jameel Half Kernel Boxes</div>
          <div class="stat-value" id="invAlJameelHalfBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Al Jameel Quarter Boxes</div>
          <div class="stat-value" id="invAlJameelQuarterBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Al Jameel Large Pieces Boxes</div>
          <div class="stat-value" id="invAlJameelLargeBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Al Jameel Amber Boxes</div>
          <div class="stat-value" id="invAlJameelAmberBoxes">0</div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Abu Taj Half Kernel Boxes</div>
          <div class="stat-value" id="invAbuTajHalfBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Abu Taj Quarter Boxes</div>
          <div class="stat-value" id="invAbuTajQuarterBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Abu Taj Large Pieces Boxes</div>
          <div class="stat-value" id="invAbuTajLargeBoxes">0</div>
        </div>
        <div class="stat-card">
          <div>Abu Taj Amber Boxes</div>
          <div class="stat-value" id="invAbuTajAmberBoxes">0</div>
        </div>
      </div>

      <!-- Inventory Export Section -->
      <div class="materials-section" style="margin-bottom: 1rem;">
        <h3>Export Inventory Reports</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Export Type</label>
            <select id="inventoryExportType">
              <option value="current">Current Stock Levels</option>
              <option value="movements">Stock Movement Log</option>
              <option value="full">Complete Inventory Report</option>
            </select>
          </div>
          <div class="form-group">
            <label>From Date (for movements)</label>
            <input id="inventoryExportFromDate" type="date">
          </div>
          <div class="form-group">
            <label>To Date (for movements)</label>
            <input id="inventoryExportToDate" type="date">
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <div class="export-buttons">
              <button onclick="exportInventoryPDF()" class="export-btn export-btn-pdf">Export PDF</button>
              <button onclick="exportInventoryExcel()" class="export-btn export-btn-excel">Export Excel</button>
            </div>
          </div>
        </div>
      </div>

      <div class="materials-section">
        <h3>Stock Adjustment</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Item</label>
            <select id="invItem">
              <option value="alJameel5kg">Al Jameel 5kg Pouches</option>
              <option value="alJameel10kg">Al Jameel 10kg Pouches</option>
              <option value="abuTaj5kg">Abu Taj 5kg Pouches</option>
              <option value="abuTaj10kg">Abu Taj 10kg Pouches</option>
              <option value="alJameelHalfBoxes">Al Jameel Half Kernel Boxes</option>
              <option value="alJameelQuarterBoxes">Al Jameel Quarter Boxes</option>
              <option value="alJameelLargeBoxes">Al Jameel Large Pieces Boxes</option>
              <option value="alJameelAmberBoxes">Al Jameel Amber Boxes</option>
              <option value="abuTajHalfBoxes">Abu Taj Half Kernel Boxes</option>
              <option value="abuTajQuarterBoxes">Abu Taj Quarter Boxes</option>
              <option value="abuTajLargeBoxes">Abu Taj Large Pieces Boxes</option>
              <option value="abuTajAmberBoxes">Abu Taj Amber Boxes</option>
            </select>
          </div>
          <div class="form-group">
            <label>Action</label>
            <select id="invAction">
              <option value="add">Add Stock</option>
              <option value="remove">Remove Stock</option>
              <option value="set">Set Exact Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input id="invQuantity" type="number" min="0" step="1" value="0">
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input id="invNotes" type="text" placeholder="Reason for adjustment">
          </div>
        </div>
        <button onclick="adjustInventory()">Update Inventory</button>
      </div>

      <h3>Stock Movement Log</h3>
      <div style="overflow-x: auto;">
        <table id="inventoryTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Item</th>
              <th>Action</th>
              <th>Quantity</th>
              <th>Result</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Maintenance Section -->
    <section id="maintenance" class="section">
      <h2 style="margin-bottom: 1rem;">üîß Equipment Maintenance</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div>Total Equipment</div>
          <div class="stat-value" id="totalEquipment">42</div>
        </div>
        <div class="stat-card">
          <div>Operational</div>
          <div class="stat-value" id="operationalEquipment" style="color: #22c55e;">42</div>
        </div>
        <div class="stat-card">
          <div>Critical Down (P1-3)</div>
          <div class="stat-value" id="criticalDown" style="color: #ef4444;">0</div>
        </div>
        <div class="stat-card">
          <div>Minor Issues (P5+)</div>
          <div class="stat-value" id="minorIssues" style="color: #f59e0b;">0</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="materials-section" style="margin-bottom: 1rem;">
        <h3>Equipment Filters</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Priority Level</label>
            <select id="priorityFilter" onchange="filterEquipment()">
              <option value="all">All Priorities</option>
              <option value="1">Priority 1 (Critical)</option>
              <option value="3">Priority 3 (High)</option>
              <option value="5">Priority 5 (Medium)</option>
              <option value="7">Priority 7 (Low)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Equipment Type</label>
            <select id="typeFilter" onchange="filterEquipment()">
              <option value="all">All Types</option>
              <option value="cracker">Crackers</option>
              <option value="sorter">Sorters</option>
              <option value="conveyor">Conveyors</option>
              <option value="processing">Processing</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="statusFilter" onchange="filterEquipment()">
              <option value="all">All Status</option>
              <option value="operational">Operational Only</option>
              <option value="issues">Issues Only</option>
              <option value="down">Down/Broken Only</option>
            </select>
          </div>
         <div class="form-group">
  <label>Sort By</label>
  <select id="sortBy">
    <option value="priority">Priority Level</option>
    <option value="code">Equipment Code</option>
    <option value="status">Status</option>
  </select>
</div>
<div class="form-group">
  <label>&nbsp;</label>
  <button onclick="filterEquipment()" style="width: 100%;">Apply Filters</button>
</div>
        </div>
      </div>

      <h3>Equipment Status (<span id="shownCount">42</span> shown)</h3>
      <div id="equipmentGrid" class="stats-grid" style="margin-bottom: 2rem;">
        <!-- Equipment cards will be populated here -->
      </div>

      <div class="materials-section">
        <h3>Update Equipment Status</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Equipment</label>
            <select id="equipmentSelect">
              <option value="CR1">CR1 - Main Cracker (P1)</option>
              <option value="CR2">CR2 - Secondary Cracker (P1)</option>
              <option value="ST1">ST1 - Size Sorter (P1)</option>
              <option value="ST2">ST2 - Color Sorter (P1)</option>
              <option value="CV1">CV1 - Main Conveyor (P1)</option>
              <option value="CV2">CV2 - Shell Removal Conveyor (P1)</option>
              <option value="PR1">PR1 - Size Grader (P3)</option>
              <option value="PR2">PR2 - Laser Sorter (P3)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="equipmentStatus">
              <option value="operational" style="color: #22c55e;">Operational</option>
              <option value="maintenance" style="color: #f59e0b;">Maintenance Due</option>
              <option value="attention" style="color: #f97316;">Needs Attention</option>
              <option value="down" style="color: #ef4444;">Down/Broken</option>
              <option value="offline" style="color: #6b7280;">Offline</option>
            </select>
          </div>
          <div class="form-group">
            <label>Problem Description</label>
            <input id="problemDescription" type="text" placeholder="Describe the issue or maintenance needed">
          </div>
          <div class="form-group">
            <label>Maintenance Cost ($)</label>
            <input id="maintenanceCost" type="number" min="0" step="0.01" value="0">
          </div>
        </div>
        <button onclick="updateEquipmentStatus()">Update Status</button>
      </div>

      <h3>Maintenance Log</h3>
      <div class="materials-section" style="margin-bottom: 1rem;">
  <h4>Export Maintenance Cost Report</h4>
  <div class="form-grid">
    <div class="form-group">
      <label>From Date</label>
      <input id="exportFromDate" type="date">
    </div>
    <div class="form-group">
      <label>To Date</label>
      <input id="exportToDate" type="date">
    </div>
    <div class="form-group">
      <label>&nbsp;</label>
      <button onclick="exportMaintenanceReport()" style="width: 100%;">Export Cost Report</button>
    </div>
  </div>
</div>
      <div style="overflow-x: auto;">
        <table id="maintenanceTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Equipment</th>
              <th>Priority</th>
              <th>Status Change</th>
              <th>Problem</th>
              <th>Cost ($)</th>
              <th>Downtime (hrs)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <!-- Reports Section -->
    <section id="reports" class="section">
      <h2 style="margin-bottom: 1rem;">üìä Production Reports</h2>
      
      <div class="materials-section">
        <h3>Report Generator</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>From Date</label>
            <input id="reportFromDate" type="date">
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input id="reportToDate" type="date">
          </div>
          <div class="form-group">
            <label>Brand</label>
            <select id="reportBrand">
              <option value="all">All Brands</option>
              <option value="Al Jameel">Al Jameel</option>
              <option value="Abu Taj">Abu Taj</option>
            </select>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button onclick="loadAvailableLots()" style="width: 100%;">Load Available Lots</button>
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 1rem;">
          <label>Select Lots (multi-select with search)</label>
          <div id="lotSelector" class="lot-selector">
            <div class="search-box">
              <input id="lotSearch" type="text" placeholder="Search lots..." onkeyup="filterLots()">
            </div>
            <div class="lot-options" id="lotOptions" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.5rem;">
              <p style="color: #666; text-align: center; padding: 1rem;">Click "Load Available Lots" to see options</p>
            </div>
            <div class="selected-lots" id="selectedLots" style="margin-top: 0.5rem;">
              <strong>Selected:</strong> <span id="selectedLotsDisplay">None</span>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 1.5rem;">
          <button onclick="generateReport()" style="margin-right: 1rem;">Generate Report</button>
          <button onclick="printReport()" class="btn-secondary" id="printButton" disabled>Print Report</button>
        </div>
      </div>
      
      <!-- Report Preview Area -->
      <div id="reportPreview" style="display: none; margin-top: 2rem;">
        <div style="text-align: right; margin-bottom: 1rem;">
          <button onclick="printReport()">Print Report</button>
        </div>
        <div id="reportContent" class="report-content">
          <!-- Report content will be generated here -->
        </div>
      </div>
    </section>
    
    <!-- Item Prices Section -->
    <section id="itemprices" class="section">
      <h2 style="margin-bottom: 1rem;">üí∞ Item Prices Management</h2>
      
      <div class="warning-box" style="background: #fff3cd; border: 1px solid #ffeeba;">
        <strong>Admin Only:</strong> Changes to pricing affect all future calculations and reports.
      </div>

      <!-- Current Item Prices -->
      <div class="materials-section">
        <h3>Current Item Prices</h3>
        <div style="overflow-x: auto;">
          <table id="itemPricesTable">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Unit</th>
                <th>Unit Price ($)</th>
                <th>Status</th>
                <th>Last Updated</th>
                <th>Updated By</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Add/Edit Item Form -->
      <div class="materials-section">
        <h3 id="itemFormTitle">Add New Item</h3>
        <form id="itemPriceForm" onsubmit="saveItemPrice(event)">
          <input type="hidden" id="editItemId" value="">
          <div class="form-grid">
            <div class="form-group">
              <label>Item Name</label>
              <input id="itemName" type="text" required placeholder="e.g., Abu Taj 5kg Pouch">
            </div>
            <div class="form-group">
              <label>Unit</label>
              <input id="itemUnit" type="text" required placeholder="e.g., piece, kg, box">
            </div>
            <div class="form-group">
              <label>Unit Price ($)</label>
              <input id="itemPrice" type="number" min="0" step="0.01" required placeholder="0.00">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="itemStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div style="margin-top: 1rem;">
            <button type="submit" id="saveItemBtn">Add Item</button>
            <button type="button" class="btn-secondary" onclick="cancelItemEdit()">Cancel</button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>
 
<script>
// ===== STATE MANAGEMENT =====
class AppState {
  constructor() {
    this.data = {
      productionRecords: [],
      inventoryLog: [],
      maintenanceLog: [],
      wastageLog: [],
      itemPrices: [
        {
          id: 'alJameel5kg_pouch',
          name: 'Al Jameel 5kg Pouch',
          unit: 'piece',
          price: 1.75,
          status: 'active',
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'alJameel10kg_pouch',
          name: 'Al Jameel 10kg Pouch',
          unit: 'piece', 
          price: 2.50,
          status: 'active',
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'abuTaj5kg_pouch',
          name: 'Abu Taj 5kg Pouch',
          unit: 'piece',
          price: 1.50,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'abuTaj10kg_pouch',
          name: 'Abu Taj 10kg Pouch',
          unit: 'piece',
          price: 2.25,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'alJameel_half_kernel_box',
          name: 'Al Jameel Half Kernel Box',
          unit: 'piece',
          price: 1.80,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'alJameel_quarter_box',
          name: 'Al Jameel Quarter Box',
          unit: 'piece',
          price: 1.75,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'alJameel_large_pieces_box',
          name: 'Al Jameel Large Pieces Box',
          unit: 'piece',
          price: 1.70,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'alJameel_amber_box',
          name: 'Al Jameel Amber Box',
          unit: 'piece',
          price: 1.65,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'abuTaj_half_kernel_box',
          name: 'Abu Taj Half Kernel Box',
          unit: 'piece',
          price: 1.75,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'abuTaj_quarter_box',
          name: 'Abu Taj Quarter Box',
          unit: 'piece',
          price: 1.70,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'abuTaj_large_pieces_box',
          name: 'Abu Taj Large Pieces Box',
          unit: 'piece',
          price: 1.65,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        },
        {
          id: 'abuTaj_amber_box',
          name: 'Abu Taj Amber Box',
          unit: 'piece',
          price: 1.60,
          status: 'active', 
          category: 'packaging',
          lastUpdated: new Date().toISOString(),
          updatedBy: 'system'
        }
      ],
      priceAuditLog: [],
      currentInventory: {
        alJameel5kg: 0,
        alJameel10kg: 0,
        abuTaj5kg: 0,
        abuTaj10kg: 0,
        alJameelHalfBoxes: 0,
        alJameelQuarterBoxes: 0,
        alJameelLargeBoxes: 0,
        alJameelAmberBoxes: 0,
        abuTajHalfBoxes: 0,
        abuTajQuarterBoxes: 0,
        abuTajLargeBoxes: 0,
        abuTajAmberBoxes: 0
      },
      equipment: [], // Will be populated in the initialization
      currentUser: null
    };
    this.listeners = {};
    this.loadFromStorage();
  }

  subscribe(key, callback) {
    if (!this.listeners[key]) {
      this.listeners[key] = [];
    }
    this.listeners[key].push(callback);
  }

  setState(key, value) {
    this.data[key] = value;
    this.saveToStorage();
    this.notify(key, value);
  }

  getState(key) {
    return this.data[key];
  }

  notify(key, value) {
    if (this.listeners[key]) {
      this.listeners[key].forEach(callback => callback(value));
    }
  }

  addToArray(key, item) {
    if (Array.isArray(this.data[key])) {
      this.data[key].push(item);
      this.saveToStorage();
      this.notify(key, this.data[key]);
    }
  }

  updateInventory(item, action, quantity) {
    const current = this.data.currentInventory[item] || 0;
    let newValue;

    switch(action) {
      case 'add':
        newValue = current + quantity;
        break;
      case 'remove':
        newValue = Math.max(0, current - quantity);
        break;
      case 'set':
        newValue = Math.max(0, quantity);
        break;
      default:
        return false;
    }

    this.data.currentInventory[item] = newValue;
    this.saveToStorage();
    this.notify('currentInventory', this.data.currentInventory);
    return true;
  }

  saveToStorage() {
    try {
      localStorage.setItem('walnut_mes_data', JSON.stringify(this.data));
    } catch (e) {
      console.warn('Could not save to localStorage:', e);
    }
  }

  loadFromStorage() {
    try {
      const saved = localStorage.getItem('walnut_mes_data');
      if (saved) {
        const parsed = JSON.parse(saved);
        this.data = { ...this.data, ...parsed };
      }
    } catch (e) {
      console.warn('Could not load from localStorage:', e);
    }
  }

  getItemPrice(itemId) {
    const item = this.data.itemPrices.find(item => item.id === itemId && item.status === 'active');
    return item ? item.price : 0;
  }

  updateItemPrice(itemId, newPrice, updatedBy, notes = '') {
    const item = this.data.itemPrices.find(item => item.id === itemId);
    if (item) {
      const oldPrice = item.price;
      item.price = newPrice;
      item.lastUpdated = new Date().toISOString();
      item.updatedBy = updatedBy;
      
      this.addToArray('priceAuditLog', {
        timestamp: new Date().toISOString(),
        itemId: itemId,
        itemName: item.name,
        action: 'price_update',
        oldPrice: oldPrice,
        newPrice: newPrice,
        change: newPrice - oldPrice,
        changePercent: oldPrice > 0 ? ((newPrice - oldPrice) / oldPrice * 100).toFixed(2) : 0,
        updatedBy: updatedBy,
        notes: notes
      });
      
      this.saveToStorage();
      this.notify('itemPrices', this.data.itemPrices);
      return true;
    }
    return false;
  }

  addNewItem(itemData, createdBy) {
    const newItem = {
      id: itemData.name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
      name: itemData.name,
      unit: itemData.unit,
      price: itemData.price,
      status: itemData.status || 'active',
      category: itemData.category || 'general',
      lastUpdated: new Date().toISOString(),
      updatedBy: createdBy
    };
    
    this.addToArray('itemPrices', newItem);
    
    this.addToArray('priceAuditLog', {
      timestamp: new Date().toISOString(),
      itemId: newItem.id,
      itemName: newItem.name,
      action: 'item_created',
      oldPrice: 0,
      newPrice: newItem.price,
      change: newItem.price,
      changePercent: 0,
      updatedBy: createdBy,
      notes: 'New item created'
    });
    
    return newItem.id;
  }
}

// ===== INITIALIZE GLOBAL OBJECTS =====
window.appState = new AppState();

// Initialize with sample equipment
const equipmentData = [
  {code: "CR1", name: "Main Cracker", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "CR2", name: "Secondary Cracker", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "ST1", name: "Size Sorter", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "ST2", name: "Color Sorter", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "CV1", name: "Main Conveyor", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "CV2", name: "Shell Removal Conveyor", priority: 1, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "PR1", name: "Size Grader", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0},
  {code: "PR2", name: "Laser Sorter", priority: 3, status: "operational", problem: "", lastUpdate: new Date().toISOString(), downtime: 0}
];

// Initialize equipment data in state
window.appState.setState('equipment', equipmentData);

// User management
const users = { admin: 'admin123', operator: 'op123' };

// ===== FUNCTIONS =====
function handleLogin(event) {
  event.preventDefault();
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  
  if (users[username] && users[username] === password) {
    window.appState.setState('currentUser', username);
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userDisplay').textContent = username;
    
    showAdminControls();
    
    updateDashboard();
    renderRecords();
    renderInventory();
    renderEquipmentGrid();
    
    if (username === 'admin') {
      renderItemPricesTable();
    }
  } else {
    alert('Invalid credentials');
  }
}

function logout() {
  window.appState.setState('currentUser', null);
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

function showSection(sectionId) {
  // Check admin access for restricted sections
  if (sectionId === 'itemprices') {
    const currentUser = window.appState.getState('currentUser');
    if (currentUser !== 'admin') {
      alert('Access denied: Admin only section');
      return;
    }
  }
  
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.getElementById(sectionId).classList.add('active');
  event.target.classList.add('active');
  
  // Load section-specific data when switching
  if (sectionId === 'itemprices') {
    renderItemPricesTable();
  }
}

// Update raw material format options based on supplier
function updateRawFormat() {
  const supplier = document.getElementById('supplier').value;
  const rawFormatSelect = document.getElementById('rawFormat');
  
  // Clear existing options
  rawFormatSelect.innerHTML = '';
  
  if (supplier === 'USA') {
    rawFormatSelect.innerHTML = `
      <option value="big_bag">Big Bag (454.5 kg)</option>
      <option value="bag25">25 kg Bag</option>
    `;
  } else if (supplier === 'China') {
    rawFormatSelect.innerHTML = `
      <option value="bag25">25 kg Bag</option>
    `;
  }
}

// Update product options based on brand selection
function updateProductOptions() {
  // In this implementation, both brands have the same product types
  // But this function can be extended for brand-specific product types
  updateInventoryDisplay();
}

function updateInventoryDisplay() {
  renderInventory();
}

function updateSummary() {
  // Get product type quantities
  const halfKernel = parseFloat(document.getElementById('halfKernel').value) || 0;
  const quarter = parseFloat(document.getElementById('quarter').value) || 0;
  const largePieces = parseFloat(document.getElementById('largePieces').value) || 0;
  const amber = parseFloat(document.getElementById('amber').value) || 0;
  
  // Calculate total finished weight from product types
  const finishedKg = halfKernel + quarter + largePieces + amber;
  
  // Calculate rejects
  const rejectsKg = parseInt(document.getElementById('rejWalnutShell').value) || 0;
  
  // Calculate total and efficiency
  const rawInput = parseInt(document.getElementById('rawInput').value) || 0;
  const totalInput = rawInput > 0 ? rawInput : finishedKg + rejectsKg;
  
  const efficiency = totalInput > 0 ? Math.round((finishedKg / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((rejectsKg / totalInput) * 1000) / 10 : 0;
  
  // Auto-calculate box requirements (10kg per box)
  const halfKernelBoxesNeeded = Math.ceil(halfKernel / 10);
  const quarterBoxesNeeded = Math.ceil(quarter / 10);
  const largePiecesBoxesNeeded = Math.ceil(largePieces / 10);
  const amberBoxesNeeded = Math.ceil(amber / 10);
  const totalBoxesNeeded = halfKernelBoxesNeeded + quarterBoxesNeeded + largePiecesBoxesNeeded + amberBoxesNeeded;
  
  // Update box calculation display
  document.getElementById('calculatedHalfKernelBoxes').textContent = `Half Kernel: ${halfKernel} kg √∑ 10 = ${halfKernelBoxesNeeded} boxes`;
  document.getElementById('calculatedQuarterBoxes').textContent = `Quarter: ${quarter} kg √∑ 10 = ${quarterBoxesNeeded} boxes`;
  document.getElementById('calculatedLargePiecesBoxes').textContent = `Large Pieces: ${largePieces} kg √∑ 10 = ${largePiecesBoxesNeeded} boxes`;
  document.getElementById('calculatedAmberBoxes').textContent = `Amber: ${amber} kg √∑ 10 = ${amberBoxesNeeded} boxes`;
  document.getElementById('totalBoxesRequired').textContent = totalBoxesNeeded;
  
  // Store calculated values globally for use in submitProduction
  window.calculatedBoxRequirements = {
    halfKernel: halfKernelBoxesNeeded,
    quarter: quarterBoxesNeeded,
    largePieces: largePiecesBoxesNeeded,
    amber: amberBoxesNeeded,
    total: totalBoxesNeeded
  };
  
  document.getElementById('productionSummary').textContent = 
    `Finished: ${finishedKg} kg ‚Ä¢ Rejects: ${rejectsKg} kg ‚Ä¢ Efficiency: ${efficiency}% ‚Ä¢ Reject Rate: ${rejectRate}% ‚Ä¢ Boxes Required: ${totalBoxesNeeded}`;
}

function clearForm() {
  document.querySelectorAll('#production input[type="number"]').forEach(input => {
    input.value = 0;
  });
  document.getElementById('lotNo').value = '';
  
  // Clear wastage fields specifically
  document.getElementById('halfKernelBoxesWasted').value = 0;
  document.getElementById('quarterBoxesWasted').value = 0;
  document.getElementById('largePiecesBoxesWasted').value = 0;
  document.getElementById('amberBoxesWasted').value = 0;
  
  // Reset calculated requirements
  window.calculatedBoxRequirements = { halfKernel: 0, quarter: 0, largePieces: 0, amber: 0, total: 0 };
  
  updateSummary();
}

function submitProduction() {
  const brand = document.getElementById('brand').value;
  const rawMaterialType = document.getElementById('rawMaterialType').value; // "Walnut Inshell"
  const supplier = document.getElementById('supplier').value;
  const rawFormat = document.getElementById('rawFormat').value;
  const lotNo = document.getElementById('lotNo').value;
  const rawInput = parseInt(document.getElementById('rawInput').value) || 0;
  
  // Get product type quantities
  const halfKernel = parseFloat(document.getElementById('halfKernel').value) || 0;
  const quarter = parseFloat(document.getElementById('quarter').value) || 0;
  const largePieces = parseFloat(document.getElementById('largePieces').value) || 0;
  const amber = parseFloat(document.getElementById('amber').value) || 0;
  
  // Get packaging quantities
  const pouches5kg = parseInt(document.getElementById('pouches5kg').value) || 0;
  const pouches10kg = parseInt(document.getElementById('pouches10kg').value) || 0;
  
  // Calculate total finished weight from product types
  const finishedKg = halfKernel + quarter + largePieces + amber;
  
  if (finishedKg === 0) {
    alert('Please enter finished goods quantities for at least one product type');
    return;
  }
  
  if (!lotNo) {
    alert('Please enter a lot number');
    return;
  }
  
  // Get pouches usage
  const pouches5kgUsed = parseInt(document.getElementById('pouches5kgUsed').value) || 0;
  const pouches10kgUsed = parseInt(document.getElementById('pouches10kgUsed').value) || 0;
  const pouches5kgWasted = parseInt(document.getElementById('pouches5kgWasted').value) || 0;
  const pouches10kgWasted = parseInt(document.getElementById('pouches10kgWasted').value) || 0;
  
  // Get auto-calculated box requirements + additional wastage
  const calculatedReqs = window.calculatedBoxRequirements || { halfKernel: 0, quarter: 0, largePieces: 0, amber: 0 };
  
  const halfKernelBoxesUsed = calculatedReqs.halfKernel;
  const quarterBoxesUsed = calculatedReqs.quarter;
  const largePiecesBoxesUsed = calculatedReqs.largePieces;
  const amberBoxesUsed = calculatedReqs.amber;
  
  // Additional wastage (optional manual entries)
  const halfKernelBoxesWasted = parseInt(document.getElementById('halfKernelBoxesWasted').value) || 0;
  const quarterBoxesWasted = parseInt(document.getElementById('quarterBoxesWasted').value) || 0;
  const largePiecesBoxesWasted = parseInt(document.getElementById('largePiecesBoxesWasted').value) || 0;
  const amberBoxesWasted = parseInt(document.getElementById('amberBoxesWasted').value) || 0;
  
  // Calculate rejects
  const rejectsKg = parseInt(document.getElementById('rejWalnutShell').value) || 0;
  
  // Calculate efficiency
  const totalInput = rawInput > 0 ? rawInput : finishedKg + rejectsKg;
  const efficiency = totalInput > 0 ? Math.round((finishedKg / totalInput) * 100) : 0;
  
  // Update inventory based on brand
  let pouch5kgType, pouch10kgType, halfKernelBoxType, quarterBoxType, largePiecesBoxType, amberBoxType;
  
  if (brand === 'Al Jameel') {
    pouch5kgType = 'alJameel5kg';
    pouch10kgType = 'alJameel10kg';
    halfKernelBoxType = 'alJameelHalfBoxes';
    quarterBoxType = 'alJameelQuarterBoxes';
    largePiecesBoxType = 'alJameelLargeBoxes';
    amberBoxType = 'alJameelAmberBoxes';
  } else { // Abu Taj
    pouch5kgType = 'abuTaj5kg';
    pouch10kgType = 'abuTaj10kg';
    halfKernelBoxType = 'abuTajHalfBoxes';
    quarterBoxType = 'abuTajQuarterBoxes';
    largePiecesBoxType = 'abuTajLargeBoxes';
    amberBoxType = 'abuTajAmberBoxes';
  }
  
  // Check inventory for pouches
  const currentInventory = window.appState.getState('currentInventory');
  const totalPouches5kgNeeded = pouches5kgUsed + pouches5kgWasted;
  const totalPouches10kgNeeded = pouches10kgUsed + pouches10kgWasted;
  
  if (totalPouches5kgNeeded > currentInventory[pouch5kgType]) {
    alert(`Insufficient 5kg pouches! Required: ${totalPouches5kgNeeded}, Available: ${currentInventory[pouch5kgType]}`);
    return;
  }
  
  if (totalPouches10kgNeeded > currentInventory[pouch10kgType]) {
    alert(`Insufficient 10kg pouches! Required: ${totalPouches10kgNeeded}, Available: ${currentInventory[pouch10kgType]}`);
    return;
  }
  
  // Check inventory for each specific box type (auto-calculated + additional wastage)
  const totalHalfKernelBoxesNeeded = halfKernelBoxesUsed + halfKernelBoxesWasted;
  const totalQuarterBoxesNeeded = quarterBoxesUsed + quarterBoxesWasted;
  const totalLargePiecesBoxesNeeded = largePiecesBoxesUsed + largePiecesBoxesWasted;
  const totalAmberBoxesNeeded = amberBoxesUsed + amberBoxesWasted;
  
  if (totalHalfKernelBoxesNeeded > currentInventory[halfKernelBoxType]) {
    alert(`Insufficient Half Kernel boxes! Required: ${totalHalfKernelBoxesNeeded} (${halfKernelBoxesUsed} for production + ${halfKernelBoxesWasted} wastage), Available: ${currentInventory[halfKernelBoxType]}`);
    return;
  }
  
  if (totalQuarterBoxesNeeded > currentInventory[quarterBoxType]) {
    alert(`Insufficient Quarter boxes! Required: ${totalQuarterBoxesNeeded} (${quarterBoxesUsed} for production + ${quarterBoxesWasted} wastage), Available: ${currentInventory[quarterBoxType]}`);
    return;
  }
  
  if (totalLargePiecesBoxesNeeded > currentInventory[largePiecesBoxType]) {
    alert(`Insufficient Large Pieces boxes! Required: ${totalLargePiecesBoxesNeeded} (${largePiecesBoxesUsed} for production + ${largePiecesBoxesWasted} wastage), Available: ${currentInventory[largePiecesBoxType]}`);
    return;
  }
  
  if (totalAmberBoxesNeeded > currentInventory[amberBoxType]) {
    alert(`Insufficient Amber boxes! Required: ${totalAmberBoxesNeeded} (${amberBoxesUsed} for production + ${amberBoxesWasted} wastage), Available: ${currentInventory[amberBoxType]}`);
    return;
  }
  
  // Create production record
  const record = {
    timestamp: new Date().toISOString(),
    brand,
    rawMaterialType, // "Walnut Inshell"
    supplier,
    rawFormat,
    lot: lotNo,
    rawInput,
    // Product type outputs (kg)
    halfKernel,
    quarter,
    largePieces,
    amber,
    // Packaging outputs
    pouches5kg,
    pouches10kg,
    finishedKg,
    rejectsKg,
    efficiency,
    materials: {
      pouches5kgUsed,
      pouches10kgUsed,
      pouches5kgWasted,
      pouches10kgWasted,
      // Auto-calculated box usage + additional wastage
      halfKernelBoxesUsed,
      quarterBoxesUsed,
      largePiecesBoxesUsed,
      amberBoxesUsed,
      halfKernelBoxesWasted,
      quarterBoxesWasted,
      largePiecesBoxesWasted,
      amberBoxesWasted,
      // Store calculation method for audit trail
      boxCalculationMethod: 'auto-calculated from product weight (10kg per box)'
    }
  };
  
  // Add to production records
  window.appState.addToArray('productionRecords', record);
  
  // Update inventory - pouches
  window.appState.updateInventory(pouch5kgType, 'remove', totalPouches5kgNeeded);
  window.appState.updateInventory(pouch10kgType, 'remove', totalPouches10kgNeeded);
  
  // Update inventory - boxes (exact deduction by type - auto-calculated amounts)
  window.appState.updateInventory(halfKernelBoxType, 'remove', totalHalfKernelBoxesNeeded);
  window.appState.updateInventory(quarterBoxType, 'remove', totalQuarterBoxesNeeded);
  window.appState.updateInventory(largePiecesBoxType, 'remove', totalLargePiecesBoxesNeeded);
  window.appState.updateInventory(amberBoxType, 'remove', totalAmberBoxesNeeded);
  
  // Add detailed inventory log entries
  if (totalPouches5kgNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: `${brand} 5kg Pouches`,
      action: 'remove',
      quantity: totalPouches5kgNeeded,
      result: window.appState.getState('currentInventory')[pouch5kgType],
      notes: `Auto: Production ${lotNo} - Used: ${pouches5kgUsed}, Wasted: ${pouches5kgWasted}`
    });
  }
  
  if (totalPouches10kgNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: `${brand} 10kg Pouches`,
      action: 'remove',
      quantity: totalPouches10kgNeeded,
      result: window.appState.getState('currentInventory')[pouch10kgType],
      notes: `Auto: Production ${lotNo} - Used: ${pouches10kgUsed}, Wasted: ${pouches10kgWasted}`
    });
  }
  
  // Add specific box inventory log entries with calculation details
  if (totalHalfKernelBoxesNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: `${brand} Half Kernel Boxes`,
      action: 'remove',
      quantity: totalHalfKernelBoxesNeeded,
      result: window.appState.getState('currentInventory')[halfKernelBoxType],
      notes: `Auto: Production ${lotNo} - Calculated: ${halfKernelBoxesUsed} (${halfKernel}kg √∑ 10), Extra Wasted: ${halfKernelBoxesWasted}`
    });
  }
  
  if (totalQuarterBoxesNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: `${brand} Quarter Boxes`,
      action: 'remove',
      quantity: totalQuarterBoxesNeeded,
      result: window.appState.getState('currentInventory')[quarterBoxType],
      notes: `Auto: Production ${lotNo} - Calculated: ${quarterBoxesUsed} (${quarter}kg √∑ 10), Extra Wasted: ${quarterBoxesWasted}`
    });
  }
  
  if (totalLargePiecesBoxesNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: `${brand} Large Pieces Boxes`,
      action: 'remove',
      quantity: totalLargePiecesBoxesNeeded,
      result: window.appState.getState('currentInventory')[largePiecesBoxType],
      notes: `Auto: Production ${lotNo} - Calculated: ${largePiecesBoxesUsed} (${largePieces}kg √∑ 10), Extra Wasted: ${largePiecesBoxesWasted}`
    });
  }
  
  if (totalAmberBoxesNeeded > 0) {
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: `${brand} Amber Boxes`,
      action: 'remove',
      quantity: totalAmberBoxesNeeded,
      result: window.appState.getState('currentInventory')[amberBoxType],
      notes: `Auto: Production ${lotNo} - Calculated: ${amberBoxesUsed} (${amber}kg √∑ 10), Extra Wasted: ${amberBoxesWasted}`
    });
  }
  
  alert('Production record submitted successfully!\n\n' + 
        `üì¶ Box Requirements Auto-Calculated:\n` +
        `‚Ä¢ Half Kernel: ${halfKernelBoxesUsed} boxes (${halfKernel}kg √∑ 10)\n` +
        `‚Ä¢ Quarter: ${quarterBoxesUsed} boxes (${quarter}kg √∑ 10)\n` +
        `‚Ä¢ Large Pieces: ${largePiecesBoxesUsed} boxes (${largePieces}kg √∑ 10)\n` +
        `‚Ä¢ Amber: ${amberBoxesUsed} boxes (${amber}kg √∑ 10)`);
        
  clearForm();
  updateDashboard();
  renderRecords();
  renderInventory();
}

// Dashboard updates
function updateDashboard() {
  const productionRecords = window.appState.getState('productionRecords') || [];
  let totalFinished = 0;
  let totalRejects = 0;
  let totalInput = 0;
  
  productionRecords.forEach(record => {
    totalFinished += record.finishedKg;
    totalRejects += record.rejectsKg;
    totalInput += record.rawInput || (record.finishedKg + record.rejectsKg);
  });
  
  const efficiency = totalInput > 0 ? Math.round((totalFinished / totalInput) * 100) : 0;
  const rejectRate = totalInput > 0 ? Math.round((totalRejects / totalInput) * 1000) / 10 : 0;
  
  document.getElementById('kpiFinished').textContent = totalFinished;
  document.getElementById('kpiEff').textContent = efficiency;
  document.getElementById('kpiReject').textContent = rejectRate.toFixed(1);
}

// Records rendering
function renderRecords() {
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  
  const productionRecords = window.appState.getState('productionRecords') || [];
  productionRecords.slice().reverse().forEach(record => {
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${new Date(record.timestamp).toLocaleString()}</td>
      <td>${record.brand}</td>
      <td>${record.rawMaterialType || 'Walnut Inshell'}</td>
      <td>${record.lot}</td>
      <td>${record.rawInput}</td>
      <td>${record.halfKernel || 0}</td>
      <td>${record.quarter || 0}</td>
      <td>${record.largePieces || 0}</td>
      <td>${record.amber || 0}</td>
      <td>${record.pouches5kg || 0}</td>
      <td>${record.pouches10kg || 0}</td>
      <td>${record.finishedKg}</td>
      <td>${record.rejectsKg}</td>
      <td>${record.efficiency}%</td>
    `;
    tbody.appendChild(row);
  });
}

// Inventory management
function renderInventory() {
  const currentInventory = window.appState.getState('currentInventory') || {};
  
  document.getElementById('invAlJameel5kg').textContent = currentInventory.alJameel5kg || 0;
  document.getElementById('invAlJameel10kg').textContent = currentInventory.alJameel10kg || 0;
  document.getElementById('invAbuTaj5kg').textContent = currentInventory.abuTaj5kg || 0;
  document.getElementById('invAbuTaj10kg').textContent = currentInventory.abuTaj10kg || 0;
  
  document.getElementById('invAlJameelHalfBoxes').textContent = currentInventory.alJameelHalfBoxes || 0;
  document.getElementById('invAlJameelQuarterBoxes').textContent = currentInventory.alJameelQuarterBoxes || 0;
  document.getElementById('invAlJameelLargeBoxes').textContent = currentInventory.alJameelLargeBoxes || 0;
  document.getElementById('invAlJameelAmberBoxes').textContent = currentInventory.alJameelAmberBoxes || 0;
  
  document.getElementById('invAbuTajHalfBoxes').textContent = currentInventory.abuTajHalfBoxes || 0;
  document.getElementById('invAbuTajQuarterBoxes').textContent = currentInventory.abuTajQuarterBoxes || 0;
  document.getElementById('invAbuTajLargeBoxes').textContent = currentInventory.abuTajLargeBoxes || 0;
  document.getElementById('invAbuTajAmberBoxes').textContent = currentInventory.abuTajAmberBoxes || 0;
  
  // Update current stock display in production form
  if (document.getElementById('currentPouches5kg')) {
    const brand = document.getElementById('brand').value;
    
    if (brand === 'Al Jameel') {
      document.getElementById('currentPouches5kg').textContent = currentInventory.alJameel5kg || 0;
      document.getElementById('currentPouches10kg').textContent = currentInventory.alJameel10kg || 0;
      
      // Show individual box counts for specific product types
      document.getElementById('currentHalfKernelBoxes').textContent = currentInventory.alJameelHalfBoxes || 0;
      document.getElementById('currentQuarterBoxes').textContent = currentInventory.alJameelQuarterBoxes || 0;
      document.getElementById('currentLargePiecesBoxes').textContent = currentInventory.alJameelLargeBoxes || 0;
      document.getElementById('currentAmberBoxes').textContent = currentInventory.alJameelAmberBoxes || 0;
    } else { // Abu Taj
      document.getElementById('currentPouches5kg').textContent = currentInventory.abuTaj5kg || 0;
      document.getElementById('currentPouches10kg').textContent = currentInventory.abuTaj10kg || 0;
      
      // Show individual box counts for specific product types
      document.getElementById('currentHalfKernelBoxes').textContent = currentInventory.abuTajHalfBoxes || 0;
      document.getElementById('currentQuarterBoxes').textContent = currentInventory.abuTajQuarterBoxes || 0;
      document.getElementById('currentLargePiecesBoxes').textContent = currentInventory.abuTajLargeBoxes || 0;
      document.getElementById('currentAmberBoxes').textContent = currentInventory.abuTajAmberBoxes || 0;
    }
  }
  
  // Render inventory log
  const tbody = document.querySelector('#inventoryTable tbody');
  if (tbody) {
    tbody.innerHTML = '';
    
    const inventoryLog = window.appState.getState('inventoryLog') || [];
    inventoryLog.slice().reverse().forEach(log => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${new Date(log.timestamp).toLocaleString()}</td>
        <td>${log.item}</td>
        <td>${log.action}</td>
        <td>${log.quantity}</td>
        <td>${log.result}</td>
        <td>${log.notes}</td>
      `;
      tbody.appendChild(row);
    });
  }
}

function adjustInventory() {
  const item = document.getElementById('invItem').value;
  const action = document.getElementById('invAction').value;
  const quantity = parseInt(document.getElementById('invQuantity').value) || 0;
  const notes = document.getElementById('invNotes').value;
  
  if (quantity <= 0 && action !== 'set') {
    alert('Please enter a valid quantity');
    return;
  }
  
  let itemName;
  switch(item) {
    case 'alJameel5kg':
      itemName = 'Al Jameel 5kg Pouches';
      break;
    case 'alJameel10kg':
      itemName = 'Al Jameel 10kg Pouches';
      break;
    case 'abuTaj5kg':
      itemName = 'Abu Taj 5kg Pouches';
      break;
    case 'abuTaj10kg':
      itemName = 'Abu Taj 10kg Pouches';
      break;
    case 'alJameelHalfBoxes':
      itemName = 'Al Jameel Half Kernel Boxes';
      break;
    case 'alJameelQuarterBoxes':
      itemName = 'Al Jameel Quarter Boxes';
      break;
    case 'alJameelLargeBoxes':
      itemName = 'Al Jameel Large Pieces Boxes';
      break;
    case 'alJameelAmberBoxes':
      itemName = 'Al Jameel Amber Boxes';
      break;
    case 'abuTajHalfBoxes':
      itemName = 'Abu Taj Half Kernel Boxes';
      break;
    case 'abuTajQuarterBoxes':
      itemName = 'Abu Taj Quarter Boxes';
      break;
    case 'abuTajLargeBoxes':
      itemName = 'Abu Taj Large Pieces Boxes';
      break;
    case 'abuTajAmberBoxes':
      itemName = 'Abu Taj Amber Boxes';
      break;
  }
  
  const success = window.appState.updateInventory(item, action, quantity);
  
  if (success) {
    const result = window.appState.getState('currentInventory')[item];
    window.appState.addToArray('inventoryLog', {
      timestamp: new Date().toISOString(),
      item: itemName,
      action,
      quantity,
      result,
      notes
    });
    
    document.getElementById('invQuantity').value = 0;
    document.getElementById('invNotes').value = '';
    alert('Inventory updated successfully');
  } else {
    alert('Failed to update inventory');
  }
  
  renderInventory();
}

// ===== INVENTORY EXPORT FUNCTIONS =====

function exportInventoryPDF() {
  const exportType = document.getElementById('inventoryExportType').value;
  const fromDate = document.getElementById('inventoryExportFromDate').value;
  const toDate = document.getElementById('inventoryExportToDate').value;
  
  let reportHTML = '';
  const currentDate = new Date().toLocaleString();
  
  if (exportType === 'current' || exportType === 'full') {
    reportHTML += generateCurrentStockHTML();
  }
  
  if (exportType === 'movements' || exportType === 'full') {
    reportHTML += generateStockMovementsHTML(fromDate, toDate);
  }
  
  // Create a new window for printing
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Inventory Report - Al Jameel MES</title>
      <style>
        @media print {
          body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
          .no-print { display: none !important; }
          .page-break { page-break-before: always; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
          th { background: #8B4513; color: white; }
          .header { text-align: center; margin-bottom: 30px; }
          .section-title { font-size: 1.2em; font-weight: bold; margin: 20px 0 10px 0; color: #8B4513; }
        }
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        th { background: #8B4513; color: white; }
        .header { text-align: center; margin-bottom: 30px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin: 20px 0 10px 0; color: #8B4513; }
        .print-button { margin: 20px 0; text-align: center; }
        .print-button button { padding: 10px 20px; background: #8B4513; color: white; border: none; border-radius: 5px; cursor: pointer; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Al Jameel MES - Inventory Report</h1>
        <p><strong>Export Type:</strong> ${getExportTypeLabel(exportType)}</p>
        <p><strong>Generated:</strong> ${currentDate}</p>
        ${(fromDate || toDate) ? `<p><strong>Date Range:</strong> ${fromDate || 'Start'} to ${toDate || 'End'}</p>` : ''}
      </div>
      
      <div class="print-button no-print">
        <button onclick="window.print()">Print Report</button>
        <button onclick="window.close()" style="margin-left: 10px; background: #6b7280;">Close</button>
      </div>
      
      ${reportHTML}
      
      <div style="margin-top: 40px; text-align: center; border-top: 2px solid #8B4513; padding-top: 20px;">
        <p><strong>Al Jameel MES - Walnut Production Management System</strong></p>
        <p>Confidential Report - Generated: ${currentDate}</p>
      </div>
    </body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.focus();
}

function exportInventoryExcel() {
  const exportType = document.getElementById('inventoryExportType').value;
  const fromDate = document.getElementById('inventoryExportFromDate').value;
  const toDate = document.getElementById('inventoryExportToDate').value;
  
  let csvContent = '\ufeff'; // BOM for proper encoding
  const currentDate = new Date().toLocaleString();
  
  // Header information
  csvContent += `Al Jameel MES - Inventory Export\n`;
  csvContent += `Export Type: ${getExportTypeLabel(exportType)}\n`;
  csvContent += `Generated: ${currentDate}\n`;
  if (fromDate || toDate) {
    csvContent += `Date Range: ${fromDate || 'Start'} to ${toDate || 'End'}\n`;
  }
  csvContent += '\n';
  
  if (exportType === 'current' || exportType === 'full') {
    csvContent += generateCurrentStockCSV();
    csvContent += '\n';
  }
  
  if (exportType === 'movements' || exportType === 'full') {
    csvContent += generateStockMovementsCSV(fromDate, toDate);
  }
  
  // Create and download the file
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `inventory_report_${exportType}_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert('Inventory report exported successfully!');
}

function generateCurrentStockHTML() {
  const currentInventory = window.appState.getState('currentInventory') || {};
  
  const inventoryItems = [
    { name: 'Al Jameel 5kg Pouches', key: 'alJameel5kg', category: 'Al Jameel Pouches' },
    { name: 'Al Jameel 10kg Pouches', key: 'alJameel10kg', category: 'Al Jameel Pouches' },
    { name: 'Abu Taj 5kg Pouches', key: 'abuTaj5kg', category: 'Abu Taj Pouches' },
    { name: 'Abu Taj 10kg Pouches', key: 'abuTaj10kg', category: 'Abu Taj Pouches' },
    { name: 'Al Jameel Half Kernel Boxes', key: 'alJameelHalfBoxes', category: 'Al Jameel Boxes' },
    { name: 'Al Jameel Quarter Boxes', key: 'alJameelQuarterBoxes', category: 'Al Jameel Boxes' },
    { name: 'Al Jameel Large Pieces Boxes', key: 'alJameelLargeBoxes', category: 'Al Jameel Boxes' },
    { name: 'Al Jameel Amber Boxes', key: 'alJameelAmberBoxes', category: 'Al Jameel Boxes' },
    { name: 'Abu Taj Half Kernel Boxes', key: 'abuTajHalfBoxes', category: 'Abu Taj Boxes' },
    { name: 'Abu Taj Quarter Boxes', key: 'abuTajQuarterBoxes', category: 'Abu Taj Boxes' },
    { name: 'Abu Taj Large Pieces Boxes', key: 'abuTajLargeBoxes', category: 'Abu Taj Boxes' },
    { name: 'Abu Taj Amber Boxes', key: 'abuTajAmberBoxes', category: 'Abu Taj Boxes' }
  ];
  
  let html = '<div class="section-title">Current Stock Levels</div>';
  html += '<table>';
  html += '<thead><tr><th>Item Name</th><th>Category</th><th>Current Stock</th><th>Status</th></tr></thead>';
  html += '<tbody>';
  
  inventoryItems.forEach(item => {
    const quantity = currentInventory[item.key] || 0;
    const status = quantity === 0 ? 'Out of Stock' : quantity < 10 ? 'Low Stock' : 'In Stock';
    const statusColor = quantity === 0 ? '#ef4444' : quantity < 10 ? '#f59e0b' : '#22c55e';
    
    html += `
      <tr>
        <td>${item.name}</td>
        <td>${item.category}</td>
        <td style="text-align: right; font-weight: bold;">${quantity.toLocaleString()}</td>
        <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  
  // Add summary totals
  const totalPouches = (currentInventory.alJameel5kg || 0) + (currentInventory.alJameel10kg || 0) + 
                      (currentInventory.abuTaj5kg || 0) + (currentInventory.abuTaj10kg || 0);
  const totalBoxes = Object.keys(currentInventory).filter(key => key.includes('Boxes'))
                     .reduce((sum, key) => sum + (currentInventory[key] || 0), 0);
  
  html += `
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
      <strong>Summary Totals:</strong><br>
      Total Pouches: ${totalPouches.toLocaleString()}<br>
      Total Boxes: ${totalBoxes.toLocaleString()}<br>
      Total Items: ${(totalPouches + totalBoxes).toLocaleString()}
    </div>
  `;
  
  return html;
}

function generateStockMovementsHTML(fromDate, toDate) {
  const inventoryLog = window.appState.getState('inventoryLog') || [];
  
  let filteredLog = inventoryLog;
  if (fromDate || toDate) {
    filteredLog = inventoryLog.filter(log => {
      const logDate = new Date(log.timestamp).toISOString().split('T')[0];
      let include = true;
      if (fromDate && logDate < fromDate) include = false;
      if (toDate && logDate > toDate) include = false;
      return include;
    });
  }
  
  let html = '<div class="section-title page-break">Stock Movement Log';
  if (fromDate || toDate) {
    html += ` (${fromDate || 'Start'} to ${toDate || 'End'})`;
  }
  html += '</div>';
  
  if (filteredLog.length === 0) {
    html += '<p>No stock movements found for the selected period.</p>';
    return html;
  }
  
  html += '<table>';
  html += '<thead><tr><th>Date & Time</th><th>Item</th><th>Action</th><th>Quantity</th><th>Result</th><th>Notes</th></tr></thead>';
  html += '<tbody>';
  
  filteredLog.slice().reverse().forEach(log => {
    const actionColor = log.action === 'add' ? '#22c55e' : log.action === 'remove' ? '#ef4444' : '#6b7280';
    html += `
      <tr>
        <td>${new Date(log.timestamp).toLocaleString()}</td>
        <td>${log.item}</td>
        <td style="color: ${actionColor}; font-weight: bold;">${log.action.toUpperCase()}</td>
        <td style="text-align: right;">${log.quantity.toLocaleString()}</td>
        <td style="text-align: right; font-weight: bold;">${log.result.toLocaleString()}</td>
        <td>${log.notes}</td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  
  // Add movement summary
  const addTotal = filteredLog.filter(log => log.action === 'add').reduce((sum, log) => sum + log.quantity, 0);
  const removeTotal = filteredLog.filter(log => log.action === 'remove').reduce((sum, log) => sum + log.quantity, 0);
  
  html += `
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
      <strong>Movement Summary:</strong><br>
      Total Records: ${filteredLog.length.toLocaleString()}<br>
      Total Added: ${addTotal.toLocaleString()}<br>
      Total Removed: ${removeTotal.toLocaleString()}<br>
      Net Change: ${(addTotal - removeTotal).toLocaleString()}
    </div>
  `;
  
  return html;
}

function generateCurrentStockCSV() {
  const currentInventory = window.appState.getState('currentInventory') || {};
  
  const inventoryItems = [
    { name: 'Al Jameel 5kg Pouches', key: 'alJameel5kg', category: 'Al Jameel Pouches' },
    { name: 'Al Jameel 10kg Pouches', key: 'alJameel10kg', category: 'Al Jameel Pouches' },
    { name: 'Abu Taj 5kg Pouches', key: 'abuTaj5kg', category: 'Abu Taj Pouches' },
    { name: 'Abu Taj 10kg Pouches', key: 'abuTaj10kg', category: 'Abu Taj Pouches' },
    { name: 'Al Jameel Half Kernel Boxes', key: 'alJameelHalfBoxes', category: 'Al Jameel Boxes' },
    { name: 'Al Jameel Quarter Boxes', key: 'alJameelQuarterBoxes', category: 'Al Jameel Boxes' },
    { name: 'Al Jameel Large Pieces Boxes', key: 'alJameelLargeBoxes', category: 'Al Jameel Boxes' },
    { name: 'Al Jameel Amber Boxes', key: 'alJameelAmberBoxes', category: 'Al Jameel Boxes' },
    { name: 'Abu Taj Half Kernel Boxes', key: 'abuTajHalfBoxes', category: 'Abu Taj Boxes' },
    { name: 'Abu Taj Quarter Boxes', key: 'abuTajQuarterBoxes', category: 'Abu Taj Boxes' },
    { name: 'Abu Taj Large Pieces Boxes', key: 'abuTajLargeBoxes', category: 'Abu Taj Boxes' },
    { name: 'Abu Taj Amber Boxes', key: 'abuTajAmberBoxes', category: 'Abu Taj Boxes' }
  ];
  
  let csv = 'CURRENT STOCK LEVELS\n';
  csv += 'Item Name,Category,Current Stock,Status\n';
  
  inventoryItems.forEach(item => {
    const quantity = currentInventory[item.key] || 0;
    const status = quantity === 0 ? 'Out of Stock' : quantity < 10 ? 'Low Stock' : 'In Stock';
    csv += `"${item.name}","${item.category}",${quantity},"${status}"\n`;
  });
  
  return csv;
}

function generateStockMovementsCSV(fromDate, toDate) {
  const inventoryLog = window.appState.getState('inventoryLog') || [];
  
  let filteredLog = inventoryLog;
  if (fromDate || toDate) {
    filteredLog = inventoryLog.filter(log => {
      const logDate = new Date(log.timestamp).toISOString().split('T')[0];
      let include = true;
      if (fromDate && logDate < fromDate) include = false;
      if (toDate && logDate > toDate) include = false;
      return include;
    });
  }
  
  let csv = 'STOCK MOVEMENT LOG\n';
  csv += 'Date & Time,Item,Action,Quantity,Result,Notes\n';
  
  filteredLog.slice().reverse().forEach(log => {
    csv += `"${new Date(log.timestamp).toLocaleString()}","${log.item}","${log.action.toUpperCase()}",${log.quantity},${log.result},"${log.notes}"\n`;
  });
  
  return csv;
}

function getExportTypeLabel(type) {
  switch(type) {
    case 'current': return 'Current Stock Levels';
    case 'movements': return 'Stock Movement Log';
    case 'full': return 'Complete Inventory Report';
    default: return 'Inventory Report';
  }
}

// Equipment management
function filterEquipment() {
  const priorityFilter = document.getElementById('priorityFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  const sortBy = document.getElementById('sortBy').value;
  
  const equipment = window.appState.getState('equipment');
  let filteredEquipment = [...equipment];
  
  if (priorityFilter !== 'all') {
    filteredEquipment = filteredEquipment.filter(eq => eq.priority == priorityFilter);
  }
  
  if (typeFilter !== 'all') {
    filteredEquipment = filteredEquipment.filter(eq => {
      switch(typeFilter) {
        case 'cracker': return eq.code.startsWith('CR');
        case 'sorter': return eq.code.startsWith('ST');
        case 'conveyor': return eq.code.startsWith('CV');
        case 'processing': return eq.code.startsWith('PR');
        default: return true;
      }
    });
  }
  
  if (statusFilter !== 'all') {
    if (statusFilter === 'operational') {
      filteredEquipment = filteredEquipment.filter(eq => eq.status === 'operational');
    } else if (statusFilter === 'issues') {
      filteredEquipment = filteredEquipment.filter(eq => ['maintenance', 'attention'].includes(eq.status));
    } else if (statusFilter === 'down') {
      filteredEquipment = filteredEquipment.filter(eq => ['down', 'offline'].includes(eq.status));
    }
  }
  
  filteredEquipment.sort((a, b) => {
    switch(sortBy) {
      case 'priority': return a.priority - b.priority;
      case 'code': return a.code.localeCompare(b.code);
      case 'status': 
        const statusOrder = {operational: 0, maintenance: 1, attention: 2, down: 3, offline: 4};
        return statusOrder[a.status] - statusOrder[b.status];
      default: return 0;
    }
  });
  
  renderFilteredEquipment(filteredEquipment);
}

function renderFilteredEquipment(filteredList) {
  const grid = document.getElementById('equipmentGrid');
  
  const equipmentCards = filteredList.map(eq => {
    const statusColors = {
      operational: '#22c55e',
      maintenance: '#f59e0b', 
      attention: '#f97316',
      down: '#ef4444',
      offline: '#6b7280'
    };
    
    const statusLabels = {
      operational: 'Operational',
      maintenance: 'Maintenance Due',
      attention: 'Needs Attention', 
      down: 'Down/Broken',
      offline: 'Offline'
    };
    
    return `
      <div class="stat-card" style="border-left: 5px solid ${statusColors[eq.status]};">
        <div style="font-weight: bold; font-size: 1.1rem;">${eq.code}</div>
        <div style="margin: 0.5rem 0; color: ${statusColors[eq.status]}; font-weight: 600;">
          ${statusLabels[eq.status]}
        </div>
        <div style="font-size: 0.9rem; color: #666;">
          ${eq.name}
        </div>
        <div style="font-size: 0.8rem; color: #666;">Priority ${eq.priority}</div>
        ${eq.problem ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">${eq.problem}</div>` : ''}
      </div>
    `;
  }).join('');
  
  grid.innerHTML = equipmentCards;
  document.getElementById('shownCount').textContent = filteredList.length;
}

function renderEquipmentGrid() {
  const equipment = window.appState.getState('equipment');
  renderFilteredEquipment(equipment);
  
  const operational = equipment.filter(e => e.status === 'operational').length;
  const criticalDown = equipment.filter(e => e.priority <= 3 && e.status !== 'operational').length;
  const minorIssues = equipment.filter(e => e.priority >= 5 && e.status !== 'operational').length;
  
  document.getElementById('operationalEquipment').textContent = operational;
  document.getElementById('criticalDown').textContent = criticalDown;
  document.getElementById('minorIssues').textContent = minorIssues;
}

function updateEquipmentStatus() {
  const equipmentCode = document.getElementById('equipmentSelect').value;
  const newStatus = document.getElementById('equipmentStatus').value;
  const problem = document.getElementById('problemDescription').value;
  const cost = parseFloat(document.getElementById('maintenanceCost').value) || 0;
  
  const equipment = window.appState.getState('equipment');
  const equipmentItem = equipment.find(e => e.code === equipmentCode);
  if (!equipmentItem) return;
  
  const oldStatus = equipmentItem.status;
  
  let downtimeHours = 0;
  if (oldStatus !== 'operational' && newStatus === 'operational') {
    const downStart = new Date(equipmentItem.lastUpdate);
    const now = new Date();
    downtimeHours = Math.round((now - downStart) / (1000 * 60 * 60) * 10) / 10;
  }
  
  equipmentItem.status = newStatus;
  equipmentItem.problem = problem;
  equipmentItem.lastUpdate = new Date().toISOString();
  if (newStatus === 'operational') {
    equipmentItem.downtime = 0;
  }
  
  window.appState.setState('equipment', equipment);
  
  window.appState.addToArray('maintenanceLog', {
    timestamp: new Date().toISOString(),
    equipment: `${equipmentCode} - ${equipmentItem.name}`,
    priority: equipmentItem.priority,
    statusChange: `${oldStatus} ‚Üí ${newStatus}`,
    problem: problem || 'Status update',
    cost: cost,
    downtime: downtimeHours
  });
  
  document.getElementById('problemDescription').value = '';
  document.getElementById('maintenanceCost').value = 0;
  
  alert('Equipment status updated successfully!');
  renderEquipmentGrid();
  renderMaintenanceTable();
}

function renderMaintenanceTable() {
  const tbody = document.querySelector('#maintenanceTable tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  const maintenanceLog = window.appState.getState('maintenanceLog') || [];
  maintenanceLog.slice().reverse().forEach(log => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${new Date(log.timestamp).toLocaleString()}</td>
      <td>${log.equipment}</td>
      <td style="color: ${log.priority <= 3 ? '#ef4444' : '#22c55e'}; font-weight: bold;">P${log.priority || 'N/A'}</td>
      <td>${log.statusChange}</td>
      <td>${log.problem}</td>
      <td>${log.cost > 0 ? '$' + log.cost.toFixed(2) : '-'}</td>
      <td>${log.downtime > 0 ? log.downtime : '-'}</td>
    `;
    tbody.appendChild(row);
  });
}

function exportMaintenanceReport() {
  const fromDate = document.getElementById('exportFromDate').value;
  const toDate = document.getElementById('exportToDate').value;
  
  if (!fromDate || !toDate) {
    alert('Please select both From and To dates');
    return;
  }
  
  const maintenanceLog = window.appState.getState('maintenanceLog') || [];
  const filtered = maintenanceLog.filter(log => {
    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
    return logDate >= fromDate && logDate <= toDate;
  });
  
  if (filtered.length === 0) {
    alert('No maintenance records found in the selected date range');
    return;
  }
  
  alert('Maintenance report would be exported here in a real application');
}

// ===== REPORTS FUNCTIONALITY =====
let availableLots = [];
let selectedLotsList = [];

function loadAvailableLots() {
  const fromDate = document.getElementById('reportFromDate').value;
  const toDate = document.getElementById('reportToDate').value;
  const brand = document.getElementById('reportBrand').value;
  
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  // Filter records based on date and brand
  let filteredRecords = productionRecords.filter(record => {
    let dateMatch = true;
    let brandMatch = true;
    
    if (fromDate || toDate) {
      const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
      if (fromDate && recordDate < fromDate) dateMatch = false;
      if (toDate && recordDate > toDate) dateMatch = false;
    }
    
    if (brand !== 'all' && record.brand !== brand) {
      brandMatch = false;
    }
    
    return dateMatch && brandMatch;
  });
  
  // Extract unique lots
  availableLots = [...new Set(filteredRecords.map(record => ({
    lot: record.lot,
    brand: record.brand,
    date: new Date(record.timestamp).toLocaleDateString(),
    finished: record.finishedKg,
    rejects: record.rejectsKg
  })))];
  
  renderLotOptions();
  alert(`Found ${availableLots.length} lots`);
}

function renderLotOptions() {
  const container = document.getElementById('lotOptions');
  
  if (availableLots.length === 0) {
    container.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">No lots found for the selected criteria</p>';
    return;
  }
  
  container.innerHTML = availableLots.map(lotData => `
    <div class="lot-option" onclick="toggleLot('${lotData.lot}')" style="padding: 0.5rem; border: 1px solid #ddd; margin-bottom: 0.5rem; cursor: pointer; border-radius: 0.25rem;">
      <input type="checkbox" ${selectedLotsList.includes(lotData.lot) ? 'checked' : ''}>
      <div>
        <strong>${lotData.lot}</strong> - ${lotData.brand}<br>
        <small>${lotData.date} ‚Ä¢ ${lotData.finished}kg finished ‚Ä¢ ${lotData.rejects}kg rejects</small>
      </div>
    </div>
  `).join('');
}

function filterLots() {
  const searchTerm = document.getElementById('lotSearch').value.toLowerCase();
  const lotOptions = document.querySelectorAll('.lot-option');
  
  lotOptions.forEach(option => {
    const lotText = option.textContent.toLowerCase();
    option.style.display = lotText.includes(searchTerm) ? 'block' : 'none';
  });
}

function toggleLot(lotNumber) {
  if (selectedLotsList.includes(lotNumber)) {
    selectedLotsList = selectedLotsList.filter(lot => lot !== lotNumber);
  } else {
    selectedLotsList.push(lotNumber);
  }
  
  updateSelectedDisplay();
  renderLotOptions(); // Re-render to update checkboxes
}

function updateSelectedDisplay() {
  const display = document.getElementById('selectedLotsDisplay');
  display.textContent = selectedLotsList.length > 0 ? selectedLotsList.join(', ') : 'None';
}

function generateReport() {
  if (selectedLotsList.length === 0) {
    alert('Please select at least one lot');
    return;
  }
  
  const productionRecords = window.appState.getState('productionRecords') || [];
  
  // Filter records for selected lots
  const selectedRecords = productionRecords.filter(record => 
    selectedLotsList.includes(record.lot)
  );
  
  generateReportHTML(selectedRecords);
  
  document.getElementById('reportPreview').style.display = 'block';
  document.getElementById('printButton').disabled = false;
}

function generateReportHTML(records) {
  const reportContent = document.getElementById('reportContent');
  
  // Calculate comprehensive metrics
  const totalFinished = records.reduce((sum, r) => sum + r.finishedKg, 0);
  const totalRejects = records.reduce((sum, r) => sum + r.rejectsKg, 0);
  const totalInput = records.reduce((sum, r) => sum + r.rawInput, 0);
  const avgEfficiency = totalInput > 0 ? Math.round((totalFinished / totalInput) * 100) : 0;
  
  // Brand analysis
  const brandStats = {};
  records.forEach(record => {
    if (!brandStats[record.brand]) {
      brandStats[record.brand] = { finished: 0, rejects: 0, count: 0 };
    }
    brandStats[record.brand].finished += record.finishedKg;
    brandStats[record.brand].rejects += record.rejectsKg;
    brandStats[record.brand].count += 1;
  });

  // Product type analysis
  const productStats = {
    'Half Kernel': records.reduce((sum, r) => sum + (r.halfKernel || 0), 0),
    'Quarter': records.reduce((sum, r) => sum + (r.quarter || 0), 0),
    'Large Pieces': records.reduce((sum, r) => sum + (r.largePieces || 0), 0),
    'Amber': records.reduce((sum, r) => sum + (r.amber || 0), 0)
  };

  const reportHTML = `
    <div class="report-header" style="margin-bottom: 2rem; padding: 2rem; background: linear-gradient(135deg, #8B4513 0%, #D2B48C 100%); color: white; border-radius: 0.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1 style="margin: 0; font-size: 2rem;">Al Jameel MES</h1>
          <h2 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; opacity: 0.9;">Walnut Production Report</h2>
        </div>
        <div style="text-align: right;">
          <p style="margin: 0.25rem 0;"><strong>Generated:</strong> ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
          <p style="margin: 0.25rem 0;"><strong>Lots Analyzed:</strong> ${selectedLotsList.length}</p>
          <p style="margin: 0.25rem 0;"><strong>Total Records:</strong> ${records.length}</p>
        </div>
      </div>
    </div>

    <!-- Executive Summary Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value">${totalFinished.toLocaleString()}</div>
        <div class="metric-label">Total Finished (kg)</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">${totalRejects.toLocaleString()}</div>
        <div class="metric-label">Total Rejects (kg)</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">${avgEfficiency}%</div>
        <div class="metric-label">Average Efficiency</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">${totalInput.toLocaleString()}</div>
        <div class="metric-label">Total Raw Input (kg)</div>
      </div>
    </div>

    <!-- Professional Charts Grid -->
    <div class="chart-grid">
      <!-- Production Distribution Pie Chart -->
      <div class="chart-container">
        <div class="chart-title">Production Distribution</div>
        <div class="pie-chart-container">
          ${generatePieChart([
            { label: 'Finished Product', value: totalFinished, color: '#22c55e' },
            { label: 'Rejects', value: totalRejects, color: '#ef4444' }
          ], 200)}
        </div>
      </div>

      <!-- Brand Performance Pie Chart -->
      <div class="chart-container">
        <div class="chart-title">Brand Distribution</div>
        <div class="pie-chart-container">
          ${generatePieChart(
            Object.entries(brandStats).map(([brand, stats], index) => ({
              label: brand,
              value: stats.finished,
              color: index === 0 ? '#8B4513' : '#D2B48C'
            })), 200
          )}
        </div>
      </div>
    </div>

    <!-- Product Type Distribution Bar Chart -->
    <div class="chart-container">
      <div class="chart-title">Product Type Distribution Analysis</div>
      <div class="bar-chart-container">
        ${generateBarChart([
          { label: 'Half Kernel', value: productStats['Half Kernel'], color: '#8B4513' },
          { label: 'Quarter', value: productStats['Quarter'], color: '#D2B48C' },
          { label: 'Large Pieces', value: productStats['Large Pieces'], color: '#CD853F' },
          { label: 'Amber', value: productStats['Amber'], color: '#DEB887' }
        ])}
      </div>
    </div>

    <!-- Production Volume by Lot -->
    <div class="chart-container">
      <div class="chart-title">Production Volume by Lot</div>
      <div class="bar-chart-container">
        ${generateProductionBarChart(records)}
      </div>
    </div>

    <!-- Detailed Data Tables -->
    <div class="chart-container">
      <div class="chart-title">Detailed Production Records</div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
          <thead>
            <tr style="background: var(--primary); color: white;">
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: left;">Date</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: left;">Lot</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: left;">Brand</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Raw Input</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Half Kernel</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Quarter</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Large Pieces</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Amber</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Finished</th>
              <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">Efficiency</th>
            </tr>
          </thead>
          <tbody>
            ${records.map(record => `
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 0.5rem; border: 1px solid #ddd;">${new Date(record.timestamp).toLocaleDateString()}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd;">${record.lot}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd;">${record.brand}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right;">${record.rawInput.toLocaleString()}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right;">${(record.halfKernel || 0).toLocaleString()}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right;">${(record.quarter || 0).toLocaleString()}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right;">${(record.largePieces || 0).toLocaleString()}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right;">${(record.amber || 0).toLocaleString()}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right;"><strong>${record.finishedKg.toLocaleString()}</strong></td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-weight: 600;">${record.efficiency}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 0.5rem; text-align: center; border-top: 3px solid var(--primary);">
      <p style="margin: 0; color: var(--primary); font-weight: 600;">Al Jameel MES - Walnut Production Management System</p>
      <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #6c757d;">Generated: ${new Date().toLocaleString()} | Confidential Report</p>
    </div>
  `;
  
  reportContent.innerHTML = reportHTML;
}

// Professional Chart Generation Functions
function generatePieChart(data, size = 200) {
  if (!data || data.length === 0) return '<div class="chart-placeholder">No data available</div>';
  
  const total = data.reduce((sum, item) => sum + item.value, 0);
  if (total === 0) return '<div class="chart-placeholder">No data to display</div>';
  
  const radius = size / 2 - 10;
  const centerX = size / 2;
  const centerY = size / 2;
  
  let currentAngle = -90; // Start at top
  let paths = '';
  let legends = '';
  
  data.forEach((item, index) => {
    if (item.value > 0) {
      const percentage = (item.value / total) * 100;
      const angle = (item.value / total) * 360;
      const endAngle = currentAngle + angle;
      
      // Calculate path for pie slice
      const startAngleRad = (currentAngle * Math.PI) / 180;
      const endAngleRad = (endAngle * Math.PI) / 180;
      
      const x1 = centerX + radius * Math.cos(startAngleRad);
      const y1 = centerY + radius * Math.sin(startAngleRad);
      const x2 = centerX + radius * Math.cos(endAngleRad);
      const y2 = centerY + radius * Math.sin(endAngleRad);
      
      const largeArcFlag = angle > 180 ? 1 : 0;
      
      const pathData = [
        `M ${centerX} ${centerY}`,
        `L ${x1} ${y1}`,
        `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
        'Z'
      ].join(' ');
      
      paths += `<path d="${pathData}" fill="${item.color}" stroke="#fff" stroke-width="2" opacity="0.9"/>`;
      
      legends += `
        <div class="legend-item">
          <div class="legend-color" style="background: ${item.color};"></div>
          <span>${item.label}: ${item.value.toLocaleString()} (${percentage.toFixed(1)}%)</span>
        </div>
      `;
      
      currentAngle = endAngle;
    }
  });
  
  return `
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="margin: 0 auto; display: block;">
      ${paths}
    </svg>
    <div class="chart-legend">${legends}</div>
  `;
}

function generateBarChart(data) {
  if (!data || data.length === 0) return '<div class="chart-placeholder">No data available</div>';
  
  const maxValue = Math.max(...data.map(item => item.value));
  if (maxValue === 0) return '<div class="chart-placeholder">No data to display</div>';
  
  return data.map(item => {
    const percentage = (item.value / maxValue) * 100;
    return `
      <div class="bar-item">
        <div class="bar-label">
          <span style="font-weight: 600;">${item.label}</span>
          <span style="font-weight: 700; color: ${item.color};">${item.value.toLocaleString()}</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" style="background: ${item.color}; width: ${percentage}%;">
            ${percentage > 20 ? `${percentage.toFixed(1)}%` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function generateProductionBarChart(records) {
  if (!records || records.length === 0) return '<div class="chart-placeholder">No production data available</div>';
  
  const maxValue = Math.max(...records.map(r => r.finishedKg));
  if (maxValue === 0) return '<div class="chart-placeholder">No production data to display</div>';
  
  // Sort records by production volume for better visualization
  const sortedRecords = [...records].sort((a, b) => b.finishedKg - a.finishedKg);
  
  return sortedRecords.map((record, index) => {
    const percentage = (record.finishedKg / maxValue) * 100;
    const color = getGradientColor(index, sortedRecords.length);
    
    return `
      <div class="bar-item">
        <div class="bar-label">
          <span style="font-weight: 600;">${record.lot}</span>
          <span style="font-weight: 700; color: ${color};">${record.finishedKg.toLocaleString()} kg</span>
        </div>
        <div class="bar-label" style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">
          <span>${record.brand} ‚Ä¢ ${new Date(record.timestamp).toLocaleDateString()}</span>
          <span>Efficiency: ${record.efficiency}%</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" style="background: linear-gradient(90deg, ${color} 0%, ${adjustBrightness(color, -20)} 100%); width: ${percentage}%;">
            ${percentage > 15 ? `${percentage.toFixed(1)}%` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Helper function to generate gradient colors for bars
function getGradientColor(index, total) {
  const colors = ['#8B4513', '#D2B48C', '#CD853F', '#DEB887', '#F4A460', '#DAA520'];
  return colors[index % colors.length];
}

// Helper function to adjust color brightness
function adjustBrightness(hex, percent) {
  const num = parseInt(hex.replace("#", ""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) + amt;
  const G = (num >> 8 & 0x00FF) + amt;
  const B = (num & 0x0000FF) + amt;
  return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

function printReport() {
  window.print();
}

// Initialize report dates
function initializeReportDates() {
  const today = new Date();
  const monthAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
  document.getElementById('reportFromDate').value = monthAgo.toISOString().split('T')[0];
}

// Item prices management
function showAdminControls() {
  const currentUser = window.appState.getState('currentUser');
  if (currentUser === 'admin') {
    document.getElementById('itemPricesBtn').style.display = 'block';
  } else {
    document.getElementById('itemPricesBtn').style.display = 'none';
  }
}

function renderItemPricesTable() {
  const tbody = document.querySelector('#itemPricesTable tbody');
  if (!tbody) return;
  
  const itemPrices = window.appState.getState('itemPrices') || [];
  tbody.innerHTML = '';
  
  itemPrices.forEach(item => {
    const row = document.createElement('tr');
    const statusColor = item.status === 'active' ? '#22c55e' : '#6b7280';
    
    row.innerHTML = `
      <td><strong>${item.name}</strong></td>
      <td>${item.unit}</td>
      <td>${item.price.toFixed(2)}</td>
      <td style="color: ${statusColor}; font-weight: bold;">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</td>
      <td>${new Date(item.lastUpdated).toLocaleDateString()}</td>
      <td>${item.updatedBy}</td>
      <td>
        <button onclick="editItemPrice('${item.id}')" style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">Edit</button>
        <button onclick="toggleItemStatus('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" class="btn-secondary">
          ${item.status === 'active' ? 'Deactivate' : 'Activate'}
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function editItemPrice(itemId) {
  const itemPrices = window.appState.getState('itemPrices') || [];
  const item = itemPrices.find(item => item.id === itemId);
  
  if (item) {
    document.getElementById('editItemId').value = itemId;
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemUnit').value = item.unit;
    document.getElementById('itemPrice').value = item.price;
    document.getElementById('itemStatus').value = item.status;
    
    document.getElementById('itemFormTitle').textContent = 'Edit Item Price';
    document.getElementById('saveItemBtn').textContent = 'Update Item';
  }
}

function saveItemPrice(event) {
  event.preventDefault();
  
  const currentUser = window.appState.getState('currentUser');
  if (currentUser !== 'admin') {
    alert('Access denied: Admin only');
    return;
  }
  
  const itemId = document.getElementById('editItemId').value;
  const itemData = {
    name: document.getElementById('itemName').value,
    unit: document.getElementById('itemUnit').value,
    price: parseFloat(document.getElementById('itemPrice').value),
    status: document.getElementById('itemStatus').value
  };
  
  if (itemId) {
    const success = window.appState.updateItemPrice(itemId, itemData.price, currentUser, 'Manual price update');
    
    if (success) {
      const itemPrices = window.appState.getState('itemPrices');
      const item = itemPrices.find(item => item.id === itemId);
      if (item) {
        item.name = itemData.name;
        item.unit = itemData.unit;
        item.status = itemData.status;
        item.lastUpdated = new Date().toISOString();
        item.updatedBy = currentUser;
        window.appState.setState('itemPrices', itemPrices);
      }
      
      alert('Item updated successfully!');
    } else {
      alert('Failed to update item');
    }
  } else {
    const newItemId = window.appState.addNewItem(itemData, currentUser);
    if (newItemId) {
      alert('New item added successfully!');
    } else {
      alert('Failed to add item');
    }
  }
  
  cancelItemEdit();
  renderItemPricesTable();
}

function cancelItemEdit() {
  document.getElementById('itemPriceForm').reset();
  document.getElementById('editItemId').value = '';
  document.getElementById('itemFormTitle').textContent = 'Add New Item';
  document.getElementById('saveItemBtn').textContent = 'Add Item';
}

function toggleItemStatus(itemId) {
  const currentUser = window.appState.getState('currentUser');
  if (currentUser !== 'admin') {
    alert('Access denied: Admin only');
    return;
  }
  
  const itemPrices = window.appState.getState('itemPrices');
  const item = itemPrices.find(item => item.id === itemId);
  
  if (item) {
    item.status = item.status === 'active' ? 'inactive' : 'active';
    item.lastUpdated = new Date().toISOString();
    item.updatedBy = currentUser;
    
    window.appState.setState('itemPrices', itemPrices);
    alert(`Item ${item.status === 'active' ? 'activated' : 'deactivated'}!`);
    renderItemPricesTable();
  }
}

// Initialize
window.addEventListener('load', () => {
  // Set up inventory with some initial values for testing
  const currentInventory = window.appState.getState('currentInventory');
  if (currentInventory.alJameel5kg === 0) {
    window.appState.updateInventory('alJameel5kg', 'set', 100);
    window.appState.updateInventory('alJameel10kg', 'set', 100);
    window.appState.updateInventory('abuTaj5kg', 'set', 100);
    window.appState.updateInventory('abuTaj10kg', 'set', 100);
    window.appState.updateInventory('alJameelHalfBoxes', 'set', 50);
    window.appState.updateInventory('alJameelQuarterBoxes', 'set', 50);
    window.appState.updateInventory('alJameelLargeBoxes', 'set', 50);
    window.appState.updateInventory('alJameelAmberBoxes', 'set', 50);
    window.appState.updateInventory('abuTajHalfBoxes', 'set', 50);
    window.appState.updateInventory('abuTajQuarterBoxes', 'set', 50);
    window.appState.updateInventory('abuTajLargeBoxes', 'set', 50);
    window.appState.updateInventory('abuTajAmberBoxes', 'set', 50);
  }
  
  // Set up today's date for export forms
  const today = new Date();
  const fromDate = new Date();
  fromDate.setDate(today.getDate() - 30);
  
  // Initialize inventory export dates
  if (document.getElementById('inventoryExportFromDate')) {
    document.getElementById('inventoryExportFromDate').value = fromDate.toISOString().split('T')[0];
    document.getElementById('inventoryExportToDate').value = today.toISOString().split('T')[0];
  }
  
  // Initialize maintenance export dates
  if (document.getElementById('exportFromDate')) {
    document.getElementById('exportFromDate').value = fromDate.toISOString().split('T')[0];
    document.getElementById('exportToDate').value = today.toISOString().split('T')[0];
  }
  
  // Initialize report dates
  if (document.getElementById('reportFromDate')) {
    document.getElementById('reportFromDate').value = fromDate.toISOString().split('T')[0];
    document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
  }
  
  // Set up event handlers
  document.getElementById('brand').addEventListener('change', updateInventoryDisplay);
  document.getElementById('supplier').addEventListener('change', updateRawFormat);
  
  // Initialize
  updateRawFormat();
  updateInventoryDisplay();
  renderEquipmentGrid();
  renderMaintenanceTable();
  initializeReportDates();
});
</script>
</body>
</html>
